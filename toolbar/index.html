<!--

        ,----,                                                           
      ,/   .`|                                                           
    ,`   .'  :                    ,--,                                   
  ;    ;     /                  ,--.'|     ,---,                         
.'___,/    ,'  ,---.     ,---.  |  | :   ,---.'|                 __  ,-. 
|    :     |  '   ,'\   '   ,'\ :  : '   |   | :               ,' ,'/ /| 
;    |.';  ; /   /   | /   /   ||  ' |   :   : :      ,--.--.  '  | |' | 
`----'  |  |.   ; ,. :.   ; ,. :'  | |   :     |,-.  /       \ |  |   ,' 
    '   :  ;'   | |: :'   | |: :|  | :   |   : '  | .--.  .-. |'  :  /   
    |   |  ''   | .; :'   | .; :'  : |__ |   |  / :  \__\/: . .|  | '    
    '   :  ||   :    ||   :    ||  | '.'|'   : |: |  ," .--.; |;  : |    
    ;   |.'  \   \  /  \   \  / ;  :    ;|   | '/ : /  /  ,.  ||  , ;    
    '---'     `----'    `----'  |  ,   / |   :    |;  :   .'   \---'     
                                 ---`-'  /    \  / |  ,     .-./         
                                         `-'----'   `--`---'             
                                                                         
@johnny.hunter

-->
<!doctype html>
<html class=hidebrush>
<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <meta name="google" content="notranslate"><!-- WTF chrome, it's not in german -->
    <meta http-equiv="Content-Language" content="en">
    <title>TEST</title>
    <link rel="icon" type="image/png" href="./favicon.png" />
    <script src="../js/gator.js"></script>
    <!-- <script src="../js/hammer.js"></script> -->
    <script src="../js/base.js"></script>
    <script src="./draw.js"></script>
    <script src="./shapes.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,500,500i,600,600i,700,700i,800" rel="stylesheet">
    <style>
        /*@font-face {
            font-family: '';
            font-weight: 200;
            src: url("./fonts/woff/.woff") format("woff");
        }*/

        :root {
            --canvas:#323440;
            --tool: #282931;
            --toolhover: #1e1f25;
            --toolpress: #1B1B1C;
            --toolselect: #1B1B1C;
            --toolselect2: #0f0f10;
            --toolselect3: #1B1B1C;
            --icon:#bbb;
            --iconcurrent:#fff;
            --color:#fff;
            --incolor:#000;
            --ui:27, 26, 28;
            --shadow:rgba(var(--ui), .16);
            --shadow2:rgba(var(--ui), .4);
            --panel: rgb(var(--ui));
            --select: #00CEFF;

            --secondarytext: rgba(255,255,255,.54);

            --toolbtn: 60px;
            /* --toolbtnicon: 32px; */
            --toolgap: 12px;
            --toolradius: 50%;
            --toolicons: 52%;

            --toolbarradius: 12px;

            --hover:rgba(255, 255, 255, 0.025);
            --active:rgba(255, 255, 255, 0.05);

            --handlegap: -4px;
            --handlecolor: var(--select);
            --handlesize: 8px;

            --dotgrid: 48px;
            --dotsize: 1px;
            --dotcolor: rgba(255, 255, 255, 0.125);
            --gridcolor: rgba(255, 255, 255, 0.025);

            --dotcolor2: rgba(255, 255, 255, 0.4);
            --gridcolor2: rgba(255, 255, 255, 0.05);

            --panelicons: var(--icon); /* rgba(255, 255, 255, 0.85) */



            --null: rgb(66,66,66);

            --selectgap: 0px;
            --selectwidth: 2px;

            --menutitle: rgba(255, 255, 255, 0.54);
        }

        .light {
            --canvas:#f2f2f2;
            --tool: #fafafa;
            --toolhover: #fdfdfd;
            --toolpress: #fff;
            --toolselect: #fff;
            --toolselect2: #ddd;
            --toolselect3: #fff;
            --icon:#777;
            --iconcurrent:#000;
            --color:#000;
            --incolor:#fff;

            --panel: #fafafa;

            --shadow:rgba(var(--ui), .08);
            --shadow2:rgba(var(--ui), .15);

            --dotcolor: rgba(0, 0, 0, 0.15);
            --gridcolor: rgba(0, 0, 0, 0.025);

            --dotcolor2: rgba(0, 0, 0, 0.35);
            --gridcolor2: rgba(0, 0, 0, 0.05);

            --menutitle: rgba(0, 0, 0, 0.54);
        }

        .darkgrid {
            --dotcolor: rgba(0, 0, 0, 0.15);
            --gridcolor: rgba(0, 0, 0, 0.04);
        }

        * {margin:0;padding:0;-webkit-overflow-scrolling: touch;-ms-overflow-style: -ms-autohiding-scrollbar;outline:none;-webkit-tap-highlight-color: transparent;-webkit-touch-callout: none;}
        html, body {height:100%;}
        html {background:var(--canvas);cursor:pointer;}
        html, input, textarea, button {font-family:Barlow, sans-serif;color:var(--color);}

        body {cursor:pointer;width:calc(100% + 400px);height:calc(100% + 400px);}

        body.rectangle_tool, body.select_tool {cursor:crosshair;}

        ::-webkit-scrollbar {width:0;height:0;}
        ::-webkit-scrollbar-thumb {}

        input {border:none;border-bottom:2px solid var(--color);line-height:36px;font-size:18px;background:transparent;color:var(--color);padding:0 8px;font-weight:600;box-sizing:border-box;border-radius:0;}
            input[type=text], input[type=number] {display:block;width:100%;}

        button {background:transparent;color:var(--color);font-size:18px;font-weight:600;border:none;padding:4px 12px;border-radius:4px;}
            button.selected {background:var(--color);color:var(--incolor);}

        .buttons button {margin-right:20px;}

        #toolbar {position:fixed;top:50%;left:64px;margin-top:-252px;user-select:none;z-index:2147483645;pointer-events:none;}

            .tools {transition:transform 150ms ease-in-out;}
            html:not(.ui2) #toolbar.swap .tools {transform: translateX(calc(-100% - 60px));}

            .tool {width:var(--toolbtn);height:var(--toolbtn);margin-bottom:var(--toolgap);position:relative;transition:all 150ms ease-in-out;pointer-events:all;}
                .tool:last-child {margin-bottom:0;}
                .horizontal .tool:last-child {margin-right:0;}

                .horizontal .tool {float:left;margin-right:var(--toolgap);margin-bottom:0;}

                .toolbtn {width:100%;height:100%;background:var(--tool);transition:all 150ms ease-in-out;border-radius:var(--toolradius);box-shadow:0 2px 20px var(--shadow);cursor:pointer;position:relative;z-index:1337;}
                    .toolbtn:hover {background:var(--toolhover);}
                    .toolbtn:active {background:var(--toolselect);}

                .tool.active .toolbtn {background:var(--toolselect3);box-shadow:0 2px 20px var(--shadow2);}

                .toolbtn svg {max-width:var(--toolicons);display:block;position:absolute;z-index:1337;top:50%;left:50%;transform:translate(-50%, -50%);}
                    .toolbtn svg * {fill:var(--icon);}
                    .active .toolbtn svg * {fill:var(--iconcurrent);}

                .tools .options {background:var(--tool);border-radius:var(--toolbarradius);position:absolute;top:calc(50% - 20px);left:var(--toolbtn);opacity:0;pointer-events:none;transition:all 150ms ease-in-out;box-shadow:0 2px 20px rgba(0,0,0,0);top:50%;left:calc(var(--toolbtn) + 12px);transform:translate(-16px, -50%);}

                .swap .tools .options {right:calc(var(--toolbtn) + 12px);left:auto;}

                    .tools .active .options {background:var(--toolselect);}

                    .ui3 .tools .active .options {background:#0f0f10;}

                .toggled .options {opacity:1;pointer-events:all;box-shadow:0 2px 20px var(--shadow2);transform:translate(0, -50%);}

                .horizontal .options {left:50%;top:-12px;transform:translate(-50%, calc(-100% + 4px));}

                .horizontal .toggled .options {transform:translate(-50%, -100%);}

                

                .controls {padding-left:48px;}
                        .control {float:left;margin-right:24px;line-height:40px;cursor: pointer;}
                        .control .label {font-size:10px;text-transform:uppercase;color:#888;float:left;margin-right:12px;}
                        .control .option {float:left;}


                .panel {position:fixed;background:var(--toolselect);border-radius:20px;box-shadow:0 2px 20px var(--shadow2);transition:all 150ms ease-in-out;overflow:hidden;user-select:none;z-index:999999999999991;transform:translateY(6px);touch-action: manipulation;}

                    .slide {width:100%;height:316px;position:absolute;top:0;left:0;transition:all 150ms ease-in-out;}
                        .slide:nth-child(2) {left:-100%;}

                .list {height:100%;max-height:300px;overflow-y:auto;padding:4px 0;margin:0 8px;border-bottom:1px solid rgba(255, 255, 255, 0.08);}
                    .item {line-height:40px;font-size:18px;padding:0 12px;margin:4px 0;border-radius:calc(var(--toolbarradius) - 6px);font-weight:500;user-select:none;cursor:pointer;transition:all 150ms ease-in-out;}
                        .item:hover {background:rgba(255, 255, 255, 0.06);}
                        .item:active {background:rgba(255, 255, 255, 0.1);}
                    .item.current {background:var(--color);color:var(--incolor);}
                       

                .row {padding:0 0 8px 24px;display:flex;}
                    .row:first-child {margin-top:24px;}

                .input {width:100%;margin-right:24px;}
                    .input .label {text-transform:uppercase;color:grey;font-size:12px;font-weight:800;letter-spacing:1px;padding:8px 8px;}

                .page {position:absolute;bottom:0;left:50%;transform:translateX(-50%);}
                .dot {width:48px;height:48px;position:relative;display: inline-block;float:left;border-radius:50%;cursor: pointer;}
                    .dot::after {content:'';width:8px;height:8px;border:2px solid white;position:absolute;top:calc(50% - 6px);left:calc(50% - 6px);border-radius:50%;}
                    .dot.current::after {background:white;}

            .handle {pointer-events: all !important;width:48px;height:48px;position:absolute;left:-48px;top:calc(50% - 24px);border-radius:50%;cursor:pointer;}
                .fakehandle {position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:28px;height:28px;background:var(--toolselect);border-radius:50%;box-shadow:0 2px 20px var(--shadow2);}
                    .fakehandle svg {width:16px;height:28px;display:block;margin:0 auto;}
                        .fakehandle svg * {fill:var(--icon);}
                    .fakehandle .open {display:none;}
                    .minimized .fakehandle .close {display:none;}
                    .minimized .fakehandle .open {display:block;}

                .ui2 .fakehandle, .ui3 .fakehandle {box-shadow:none;}

        #toolbar.minimized {pointer-events:none;}
        .ui2 #toolbar.minimized, .ui3 #toolbar.minimized {width:var(--toolbtn);height:var(--toolbtn);overflow:hidden;border-radius:var(--toolbarradius);}
            #toolbar.minimized .tools {pointer-events:none;}
            #toolbar.minimized .tool {transform:translateX(-12px);opacity:0;pointer-events:none;}

            #toolbar.minimized .tool:nth-child(1) {transform:translate(-20px, 20px);}
            #toolbar.minimized .tool:nth-child(2) {transform:translate(-16px, 12px);}
            #toolbar.minimized .tool:nth-child(3) {transform:translate(-12px, 4px);}
            #toolbar.minimized .tool:nth-child(4) {transform:translate(-12px, -4px);}
            #toolbar.minimized .tool:nth-child(5) {transform:translate(-16px, -12px);}
            #toolbar.minimized .tool:nth-child(6) {transform:translate(-20px, -20px);}
            #toolbar.minimized .tool:nth-child(7) {transform:translate(-20px, -20px);}

            #toolbar.minimized .tool:nth-child(1) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(2) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(3) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(4) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(5) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(6) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(7) {transform:translate(-12px, 0);}


        #tweaks {position:fixed;top:0;right:0;bottom:0;padding:8px;overflow-y:auto;width:200px;box-sizing:border-box;background:#f4f4f4;z-index:1336;color:#333;}

            .hidetweak #tweaks {display:none;}
            .hidetweak .rez {right:8px !important;}

            #tweaks h4 {padding: 8px 8px 12px;font-weight: 600;}

        .ui2 .tools {background:var(--toolselect);box-shadow:0 3px 40px var(--shadow);padding:0 0 var(--toolbtn);border-radius:var(--toolbarradius);}
            .ui2 .tools::after {content:'';display:block;clear:both;}

            

        .ui2 .tool {display:flex;}
            .ui2 .toolbtn {width:calc(100% - 8px);margin:4px auto;height:calc(100% - 8px);background:transparent;box-shadow:none;}

                .ui2 .tool.active .toolbtn {background:var(--toolselect2);box-shadow:none;}
                
            .ui2 .handle {bottom:0;top: auto;left: 0;width:var(--toolbtn);height:var(--toolbtn);}

            .ui2.horizontal  .tools, .horiz.ui2 .tools {padding:0 var(--toolbtn) 0 0;}
            .ui2.horizontal .handle {left:auto;right:0;}
            

            /* .ui2 .options {left:calc(var(--toolbtn) + 8px);border-radius:var(--toolbarradius);width:48px;height: auto;opacity:0;pointer-events:none;}

            .ui2 .toggled .options {opacity:1;pointer-events:all;}

            .ui2 .horizontal .options {left:50%;margin-left:-24px;top:auto;bottom:calc(var(--toolbtn) + 12px);}

                .ui2 .controls {padding:0;float:none;margin:0;}
                .ui2 .controls * {float:none;}
                .ui2 .options .label {display:none;}
                .ui2 .control .option {width:48px;height:48px;display: flex;align-content: center;align-items: center;justify-content: center;justify-items: center;}
            .ui2 .option .fill {margin:0;} */

        .ui3 .tools {overflow:hidden;height:var(--toolbtn);background:var(--toolselect);box-shadow:0 3px 40px rgba(0,0,0,.4);padding:0px var(--toolbtn) 0 0;border-radius:var(--toolbarradius);}
            .ui3 .tool {float:left;min-width:var(--toolbtn);height:var(--toolbtn);margin:0px 0 0;width:auto;border-radius:4px;}
            .ui3 .toolbtn {width:var(--toolbtn);float:left;margin:4px auto;height:calc(100% - 8px);background:transparent !important;box-shadow:none !important;}

        .ui3 .tool.active {background:#0f0f10;}
            

        .ui3 .handle {bottom:0;top: auto;left: auto;right:0px;box-shadow:none;width:var(--toolbtn);height:var(--toolbtn);}

        .ui3 .options {position:relative;left:0;width:0;background:transparent;border-radius: 0;box-shadow:none;}
        .ui3 .controls {padding:0;}

        .ui3 .toggled .options {width:auto;}

        .size {width:28px;height:28px;margin-top:6px;border-radius:50%;box-shadow:inset 0 0 0 1px var(--dotcolor2);position:relative;}
            .size .actual {position:absolute;top:50%;left:50%;width:8px;height:8px;background:var(--iconcurrent);border-radius:50%;transform:translate(-50%, -50%);}

        .option .fill {cursor:pointer;width:28px;height:28px;margin-top:6px;border-radius:50%;box-shadow:inset 0 0 0 1px hsla(0, 0%, 100%, 0.175);position:absolute;background:black;}
        .option .border {cursor:pointer;width:28px;height:28px;border-radius:50%;border:4px solid rgba(155, 155, 155, 0.15);box-sizing:border-box;}

        .slider {width:48px;height:200px;position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,.1);border-radius:24px;touch-action: manipulation;background:#212122;cursor:pointer;}

            .hslider {width:100%;height:48px;background:transparent;box-shadow:none;margin:4px 0 24px;}
                .hslider .track {background:rgba(0,0,0,.33);box-shadow:none;background-blend-mode:darken;z-index:1;position:absolute;top:50%;left:0;right:0;border-radius:18px;height:36px;transform:translateY(-50%);}

            .slider .knob {width:32px;height:32px;background:white;border-radius:0;position:absolute;top:20px;left:50%;z-index:2;transform:translate(-50%, 0);border-radius:50%;}

                .hslider .knob {width:28px;height:28px;top:50%;left:12px;transform:translate(0, -50%);}

        .swatches {padding:12px;height:48px;}
        .swatches .swatch {width:48px;height:48px;display:inline-block;cursor:pointer;transition:all 150ms ease-in-out;position:relative;}
            .swatches .swatch:nth-child(1) {background:rgb(255,59,48);border-radius: 8px 0 0 8px;}
            .swatches .swatch:nth-child(2) {background:rgb(255,149,0);}
            .swatches .swatch:nth-child(3) {background:rgb(255,204,0);}
            .swatches .swatch:nth-child(4) {background:rgb(76,217,100);}
            .swatches .swatch:nth-child(5) {background:rgb(90,200,250);}
            .swatches .swatch:nth-child(6) {background:rgb(0,122,255);}
            .swatches .swatch:nth-child(7) {background:rgb(88,86,214);}
            .swatches .swatch:nth-child(8) {background:white;}
            .swatches .swatch:nth-child(9) {background:black;border-radius: 0 8px 8px 0;}

        .swatches .swatch:hover {transform:scale(1.1);z-index:3;}
        .swatches .swatch:active {transform:scale(1.05);}

        .ui1half {}

        .type_tool canvas, .type_tool {cursor:text !important;}

        .textwrap {position:absolute;cursor: -webkit-grab;cursor:grab;}
        .textarea {cursor: default;user-select:none;pointer-events:none;padding:12px;resize:none;border-radius:4px;position:relative;min-width:48px;height:28px;z-index:1337;background:transparent;border:none;color:white;font-size:24px;}
            .textwrap:not(.current):hover .textarea {box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);}
            .current .textarea {box-shadow:0 0 0 var(--selectwidth) var(--select);user-select:text;cursor:text;pointer-events:all;}
                .selectblack .current .textarea {box-shadow:0 0 0 var(--selectwidth) var(--select), inset 0 0 0 1px black;}
                .selectwhite .current .textarea {box-shadow:0 0 0 var(--selectwidth) var(--select), inset 0 0 0 1px white;}
        

        .backbtn {width:48px;height:48px;background:var(--panel);border-radius:var(--toolbarradius);display:flex;align-content:center;align-items:center;justify-content:center;justify-items:center;position: absolute;top: 0;left: -56px;box-shadow: 0 2px 20px var(--shadow2);}
            .backbtn svg {width:24px;height:auto;display:block;transform:rotate(180deg);}
                .backbtn svg * {fill:var(--icon);}


        canvas {pointer-events:none;}
        .brush_tool canvas {pointer-events:all;}

        .rectangle {transition:box-shadow 150ms ease-in-out;cursor:pointer;cursor:grab;border-color:transparent;}
            .rectangle:active {cursor:grabbing;}

          .rectangle:hover, .rectangle.drawing {box-shadow: 0 0 0 2px var(--select);}
            .rectangle.current {/*box-shadow: 0 0 0 2px var(--select);*/z-index:7;box-shadow:none;}

            .resizehandle {border-radius:50%;position:absolute;background:var(--handlecolor);box-shadow:0 0 0 1px var(--handlecolor);width:var(--handlesize);height:var(--handlesize);display:none;transition:box-shadow 125ms ease-in-out;}
              .resizehandle:hover, .resizehandle.active {box-shadow:0 0 0 1px var(--handlecolor), inset 0 0 0 12px #fff;}
              .current .resizehandle {display:block;}

            .resizehandle::after {content:'';position:absolute;width:48px;height:48px;top:50%;left:50%;transform:translate(-50%, -50%);}

            .rectangle .resizehandle:nth-child(1) {top:var(--handlegap);left:var(--handlegap);cursor:nwse-resize;}
            .rectangle .resizehandle:nth-child(2) {top:var(--handlegap);right:var(--handlegap);cursor:nesw-resize;}
            .rectangle .resizehandle:nth-child(3) {bottom:var(--handlegap);left:var(--handlegap);cursor:nesw-resize;}
            .rectangle .resizehandle:nth-child(4) {bottom:var(--handlegap);right:var(--handlegap);cursor:nwse-resize;}


            
            .boundingbox {box-shadow: 0 0 0 var(--selectwidth) var(--select);pointer-events:none;
                padding:var(--selectgap);margin:calc(var(--selectgap) * -1) 0 0  calc(var(--selectgap) * -1);
            }

            .selectwhite .boundingbox {box-shadow: 0 0 0 var(--selectwidth) var(--select), inset 0 0 0 1px white;}
            .selectblack .boundingbox {box-shadow: 0 0 0 var(--selectwidth) var(--select), inset 0 0 0 1px black;}


                .bhandle {border-radius:50%;position:absolute;background:var(--handlecolor);box-shadow:0 0 0 1px var(--handlecolor);width:var(--handlesize);height:var(--handlesize);transition:box-shadow 125ms ease-in-out;pointer-events:all;}
                    .bhandle:hover, .bhandle.active {box-shadow:0 0 0 1px var(--handlecolor), inset 0 0 0 12px #fff;}

                    .bhandle::after {content:'';position:absolute;width:48px;height:48px;top:50%;left:50%;transform:translate(-50%, -50%);}

                .boundingbox .bhandle:nth-child(1) {top:var(--handlegap);left:var(--handlegap);cursor:nwse-resize;}
                .boundingbox .bhandle:nth-child(2) {top:var(--handlegap);right:var(--handlegap);cursor:nesw-resize;}
                .boundingbox .bhandle:nth-child(3) {bottom:var(--handlegap);left:var(--handlegap);cursor:nesw-resize;}
                .boundingbox .bhandle:nth-child(4) {bottom:var(--handlegap);right:var(--handlegap);cursor:nwse-resize;}
            


            .ellipse .resizehandle:nth-child(1) {top:-5px;left:50%;margin-left:-4px;cursor:ns-resize;}
            .ellipse .resizehandle:nth-child(2) {top:50%;margin-top:-4px;right:-5px;cursor:ew-resize;}
            .ellipse .resizehandle:nth-child(3) {bottom:-5px;left:50%;margin-left:-4px;cursor:ns-resize;}
            .ellipse .resizehandle:nth-child(4) {top:50%;margin-top:-4px;left:-5px;cursor:ew-resize;}

        .contextpanel {overflow:hidden;white-space:nowrap;opacity:0;pointer-events:none;transition:none;background:var(--panel);border-radius:var(--toolbarradius);box-shadow:0 3px 20px var(--shadow);min-height:48px;position:absolute;top:-64px;left:50%;transform:translate(0, 4px);z-index:2147483646;}

            .contextpanel.visible {transition:opacity 150ms ease-in-out, transform 150ms ease-in-out;}

            .current:not(.drawing) .contextpanel, .current:not(.moving) .contextpanel, .contextpanel.visible {opacity:1;pointer-events:all;transform:translate(0, 0);}
            
            /* .contextpanel.visible.sublevel {opacity:0;pointer-events:none;transform:translate(-8px, 0);} */


            .contextpanel .option {cursor:pointer;min-width:48px;height:48px;box-sizing:border-box;display:inline-flex;vertical-align:top;align-content:center;align-items:center;justify-content:center;justify-items:center;}

            .contextpanel .optionwrap {transition:margin 150ms ease-in-out;}

            .contextpanel .option:first-child {transition:all 150ms ease-in-out;}
                .sublevel.contextpanel .option:first-child {}

                .morebtn svg {transition:all 150ms ease-in-out;}
                .sublevel .morebtn svg {transform:rotate(180deg);}
                    .swap .sublevel .morebtn svg {transform:rotate(0deg);}
    
            .contextpanel .option svg {width:24px;height:24px;}
                .contextpanel .option svg * {fill:var(--panelicons);}

            .contextpanel .option .fill {margin:0;}

            .contextpanel .option:hover {background-color:var(--hover);}
            .contextpanel .option:active {background-color:var(--active);}

            .recticon {width:24px;height:24px;border:3px solid rgba(255,255,255,.5);box-sizing:border-box;}


            .menuwrap {position:absolute;opacity:0;transition: transform 150ms ease-in-out, opacity 150ms ease-in-out;user-select:none;z-index:2147483644;transform: translateX(100%);touch-action: manipulation;}
                .menuwrap.visible {transform:translateX(0);opacity:1;}

                .menuwrap.subsublevel {transform:translateX(-100%) !important;opacity:0;pointer-events:none;}

            .notransition {transition:none !important;}

            .overflowmenu {overflow:hidden;background: var(--toolselect);border-radius:var(--toolbarradius);padding:0 0;box-shadow: 0 2px 20px var(--shadow2);min-width: 216px;}
                
                .moremenu, .contextmenu.moremenu {padding:0;min-width: 216px;overflow:hidden;}

                
                .mitem {cursor:pointer;min-height:48px;padding:8px 16px;display:flex;align-content:center;align-items:center;box-sizing:border-box;font-size:18px;}
                .mitem:hover {background-color:var(--hover);}
                .mitem:active {background-color:var(--active);}

                .mgap {height:24px;}

                .mlevel {padding-right:48px;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" fill="rgba(255,255,255,0.58)"></path></svg>') no-repeat center right 8px / 20px;}


        .flyout {padding:0 16px;font-size:18px;line-height:23px;}
            .flyout .label {display:inline-block;vertical-align:middle;height:24px;}
            .flyout .icon {display:inline-block;vertical-align:middle;height:24px;margin:0 -4px 0 4px;}
                .flyout .icon svg {display:block;}


        .toggle {width:40px;height:24px;border-radius:30px;background:grey;position:relative;background:rgba(0,0,0,.05);box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.02);cursor:pointer;transition:background 150ms ease-in-out;display: inline-block;margin-right:8px;vertical-align: middle;}
            .toggle::after {content:'';position:absolute;top:4px;left:4px;width:16px;height:16px;background:white;display:block;box-shadow:0 2px 4px rgba(0,0,0,.15);border-radius:50%;transition:transform 150ms ease-in-out;}
            label:hover .toggle {background: rgba(0, 0, 0, 0.08);}
            label:active .toggle {background: rgba(0, 0, 0, 0.12);}

            label:hover .toggle::after {box-shadow:0 2px 5px rgba(0,0,0,.18);}
            label:active .toggle::after {}


        :checked ~ .toggle {background:hsl(130, 65%, 57%);box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.0);}
        :checked ~ .toggle:after {transform:translateX(100%);}

            label:hover :checked ~ .toggle {background:hsl(130, 65%, 51%);}
            label:active :checked ~ .toggle {background:hsl(130, 65%, 48%);}


            label {user-select:none;}

        input.tweakr {display:none;}

        .tweak {cursor:pointer;}
            .tweak label {display:block;padding:8px;cursor:pointer;font-size: 14px;}


        .tweaked {padding: 16px 8px;}
            .tweaked .tweak {margin-bottom:20px;}

        .tweak .label {font-size:12px;display:flex;margin-bottom:8px;}
        .tweak span {width: 100%;}
        .tweak .value {font-size:12px;opacity:.54;text-align:right;}
        .tweak input[type=range] {padding:0 4px;width: 100%;height: 24px;border-radius:30px;background:grey;position:relative;background:rgba(0,0,0,.05);box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.02);cursor:pointer;transition:background 150ms ease-in-out;display: inline-block;margin-right:8px;vertical-align: middle;}

        .toolbar4, .ui4 #toolbar {display:none;}
        .ui4 .toolbar4 {display:block;}


        #advancedpanel {max-width: 320px;padding-bottom: 12px;opacity:0;pointer-events:none;position:fixed;top:50%;right:224px;transform:translateY(-50%);transition:opacity 150ms ease-in-out;}
            .advanced #advancedpanel {opacity:1;pointer-events:all;}

            #advancedpanel .pan {display:none;}
            .brush_tool #advancedpanel .brushpanel, .type_tool #advancedpanel .typepanel {display:block;}


        #keyboard {position:fixed;max-width:772px;width:100%;top:50%;left:50%;z-index:2147483644;background:var(--panel);padding:8px 8px 0px;border-radius:var(--toolbarradius);box-shadow: 0 2px 20px var(--shadow2);opacity:0;pointer-events:none;transition:opacity 150ms ease-in-out;}
            #keyboard {max-width:652px;}

            #keyboard.show {opacity:1;transform:translateY(0);pointer-events:all;}
        #keyboard .row {display:flex;padding: 0 0 8px;margin:0;}
            #keyboard .key {display:flex;width:60px;height:60px;align-items:center;justify-content:center;font-size:24px;font-weight:600;background:#262627;margin-right:8px;cursor:pointer;}

            #keyboard .key {display:flex;width:48px;height:48px;align-items:center;justify-content:center;font-size:22px;font-weight:600;background:transparent;margin-right:8px;cursor:pointer;border-radius:calc(var(--toolbarradius) - 6px);user-select:none;}

                #keyboard .key:last-child {margin:0;}

                #keyboard .key.shift, #keyboard .key.space, #keyboard .key.return, #keyboard .key.del, #keyboard .key.num {background:#303031;}
                #keyboard .key.shift, #keyboard .key.return, #keyboard .key.del, #keyboard .key.num {background:transparent;}
               
                #keyboard .key.shift {width:92px;}

                #keyboard .key.space {width:704px;color:transparent;background:#262627;}

                #keyboard .key.return {width:76px;}
                #keyboard .key.del {width:92px;}
                #keyboard .key.num {}

                

                #keyboard .key:hover {background:#303031;}
                #keyboard .key:active {background:#434348;}

                #keyboard .key:hover {background:#262627;}
                #keyboard .key:active {background:#303031;}

                #keyboard .key.space:hover {background:#303031;}
                #keyboard .key.space:active {background:#434348;}

        #keyboard.uppercase .key {text-transform:uppercase;}
            #keyboard.uppercase .shift {background:#434348;}

            #keyboard.uppercase .shift {background:#262627;}

        /* #keyboard .row:first-child .key:first-child {border-radius: 6px 0 0 0;}
        #keyboard .row:first-child .key:last-child {border-radius: 0 6px 0 0;}
        #keyboard .row:last-child .key:first-child {border-radius: 0 0 0 6px;}
        #keyboard .row:last-child .key:last-child {border-radius: 0 0 6px 0;} */

        .minishape {width:48px;height:48px;display:inline-flex;align-items:center;justify-content:center;cursor: pointer;border-radius:8px;transition:all 150ms ease-in-out;}

        .minishape .square, .minishape .circle, .shapeicon {width:22px;height:22px;border-radius:2px;border:2px solid var(--icon);box-sizing:border-box;}
            .minishape .circle, .shapeicon.circle {border-radius:50%;}

            .minishape:hover {background:var(--hover);}
            .minishape:active {background:var(--active);}

        .rectanglex .minishape.rx, .circlex .minishape.cx {background:var(--iconcurrent);}
            .rectanglex .minishape.rx .shapeicon, .circlex .minishape.cx .shapeicon {border-color:var(--panel);opacity:1;}

            .shapemenu .minishape {margin-right:8px;}
                .shapemenu .minishape:last-child {margin-right:0;}

            #brush_context {opacity:0;pointer-events:none;top:auto !important;}
            .brush_tool #brush_context {opacity:1;pointer-events:all;bottom:24px;left:24px;top:auto !important;transform:translateY(0);}
            
            .hidebrush #brush_context {opacity:0 !important;pointer-events:none !important;}
        
        .canvaslabel {position: absolute;top:-32px;left:-2px;padding:3px 8px 4px;background:#4E4D4D;color:white;border-radius:6px;white-space:nowrap;font-size:14px;font-weight:500;transition:all 150ms ease-in-out;}
            .current .canvaslabel {background:#433453;}

            .neartop .canvaslabel {top:4px;left:4px;}

            .ractangle.canvasboard.current {border-color:#7754A1;box-shadow:none;}


            input[type=range] {
            -webkit-appearance: none; /* Hides the slider so that custom slider can be made */
            width: 280px; /* Specific width is required for Firefox. */
            background: transparent; /* Otherwise white in Chrome */
            border:none;
            cursor:pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }

        input[type=range]:focus {
            outline: none; /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
            box-shadow:none;
        }

        input[type=range]::-webkit-slider-thumb {width: 16px;height: 16px;background: white;display: block;box-shadow: 0 2px 4px rgba(0,0,0,.15);border-radius: 50%;transition: all 150ms ease-in-out;}
        input[type=range]:hover::-webkit-slider-thumb {box-shadow:0 2px 2px rgba(0,0,0,.2);}
        input[type=range]:active::-webkit-slider-thumb {box-shadow:0 2px 2px rgba(0,0,0,.3);cursor:-webkit-grabbing;}
        input[type=range]:focus::-webkit-slider-thumb {}
            input[type=range]:hover:focus::-webkit-slider-thumb {}



        input[type=range]::-webkit-slider-runnable-track {}
        input[type=range]:focus::-webkit-slider-runnable-track {}


        .colorslide input[type=range]::-webkit-slider-thumb {border:3px solid white;height:20px;width:20px;transition:none;box-sizing:border-box;box-shadow:0 3px 6px rgba(0,0,0,.2);}


        .lock .locked {display:none;}
        .lock.unlock .unlocked {display:none;}
        .lock.unlock .locked {display:block;}


        .grid body {background-size: var(--dotgrid) var(--dotgrid);background-image: linear-gradient(to right, var(--gridcolor) 1px, transparent 1px), linear-gradient(to bottom, var(--gridcolor) 1px, transparent 1px);background-position: center;}
            .highlight.grid body {background-image: linear-gradient(to right, var(--gridcolor) 1px, transparent 1px), linear-gradient(to bottom, var(--gridcolor2) 1px, transparent 1px),linear-gradient(to right, var(--gridcolor2) 1px, transparent 1px), linear-gradient(to bottom, var(--gridcolor) 1px, transparent 1px);background-size:var(--dotgrid) var(--dotgrid), 1px calc(var(--dotgrid) * 9), calc(var(--dotgrid) * 9) 1px;}
        /* .dotgrid body {background: linear-gradient(90deg, var(--canvas) calc(var(--dotgrid) - var(--dotsize)), transparent 1%) center, linear-gradient(var(--canvas) calc(var(--dotgrid) - var(--dotsize)), transparent 1%) center, var(--dotcolor);background-size: var(--dotgrid) var(--dotgrid);} */
        .dotgrid body { background-image: radial-gradient(var(--dotcolor) var(--dotsize), transparent 0);background-size: var(--dotgrid) var(--dotgrid);background-position:center;}
            .highlight.dotgrid body {background-image: radial-gradient(circle, var(--dotcolor) var(--dotsize), transparent 0), radial-gradient(circle, var(--dotcolor2) var(--dotsize), transparent 0);background-size: var(--dotgrid) var(--dotgrid), calc(var(--dotgrid) * 9) calc(var(--dotgrid) * 9);}


            .highlight.dotgrid body {
            background-image:   radial-gradient(circle, var(--dotcolor2) var(--dotsize), transparent 0), 
                                radial-gradient(circle, var(--canvas) var(--dotsize), transparent 0), 
                                radial-gradient(circle, var(--canvas) var(--dotsize), transparent 0), 
                                radial-gradient(circle, var(--dotcolor) var(--dotsize), transparent 0);    
            
            background-size:    calc(var(--dotgrid) * 9) calc(var(--dotgrid) * 9), 
                                var(--dotgrid) calc(var(--dotgrid) * 9), 
                                calc(var(--dotgrid) * 9) var(--dotgrid), 
                                var(--dotgrid) var(--dotgrid);
            }


        .contextmenu {padding:12px;background:var(--panel);box-shadow:0 3px 20px var(--shadow2);border-radius:var(--toolbarradius);}
            .menutitle {font-weight: 600;padding:2px 8px;margin-bottom:4px;color:var(--menutitle);}

        .colors {display: flex;flex-wrap: wrap;margin-top:12px;} 
            .colors .color {width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
                .color .chip {width:28px;height:28px;border-radius:50%;position:relative;box-shadow:inset 0 0 0 1px rgba(255, 255, 255, 0.1);}

                .color .chip::after, .menubtn > div::after {content:'';width:calc(100% + 8px);height:calc(100% + 8px);border:2px solid white;box-sizing:border-box;border-radius:50%;top:-4px;left:-4px;opacity:0;display:block;position:absolute;transition:opacity 150ms ease-in-out;}

                .color:hover .chip::after, .menubtn:hover > div::after {opacity:.5;}
                .color:active .chip::after, .color.current .chip::after, .menubtn:active > div::after, .menubtn.current > div::after {opacity:1;}

                .color:nth-child(1) .chip {background-color:#D50201;}
                .color:nth-child(2) .chip {background-color:#C51262;}
                .color:nth-child(3) .chip {background-color:#AB00FF;}
                .color:nth-child(4) .chip {background-color:#6300EA;}
                .color:nth-child(5) .chip {background-color:#314EFE;}
                .color:nth-child(6) .chip {background-color:#2B61FF;}
                .color:nth-child(7) .chip {background-color:#0091EA;}
                .color:nth-child(8) .chip {background-color:#00B8D4;}
                .color:nth-child(9) .chip {background-color:#00BFA5;}
                .color:nth-child(10) .chip {background-color:#00C853;}
                .color:nth-child(11) .chip {background-color:#63DD18;}
                .color:nth-child(12) .chip {background-color:#ADEA03;}
                .color:nth-child(13) .chip {background-color:#FFCC02;}
                .color:nth-child(14) .chip {background-color:#FF9502;}
                .color:nth-child(15) .chip {background-color:#FFFFFF;}
                .color:nth-child(16) .chip {background-color:#767676;}
                .color:nth-child(17) .chip {background-color:#1a191b;}
                .color:nth-child(18) .chip {background-color:#000000;}


            .menurow {display:flex;flex-wrap:wrap;margin-top:12px;}
                .menubtn {width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

                .nullcolor {width:28px;height:28px;border-radius:50%;box-sizing:border-box;position:relative;
                    box-shadow:inset 0 0 0 3px  var(--null);
                    background: linear-gradient(to right, var(--null) 3px, transparent 3px);
                    background-position: 12.5px; /* width / 2 - line /2 */
                    transform: rotate(45deg);
                }


            .rainbowcolor {position:relative;width:28px;height:28px;border-radius:50%;box-sizing:border-box;background:white;background-image: linear-gradient(217deg, rgba(255,0,0,1), rgba(255,0,0,0) 70.71%), linear-gradient(127deg, rgba(0,255,0,1), rgba(0,255,0,0) 70.71%), linear-gradient(336deg, rgba(0,0,255,1), rgba(0,0,255,0) 70.71%);}

            
            .stepper {}
                .stepper .step {width:100%;height:48px;display:flex;align-items:center;justify-content:center;}
                    .step svg {width:24px;height:24px;}
                        .step svg * {fill:var(--icons);}

                .stepvalue {position: absolute;top: 50%;width: 100%;text-align: center;height:24px;pointer-events:none;margin-top:-12px;font-size:18px;font-weight:500;}

            
            .select {height:100%;overflow-y:auto;scroll-snap-type: y mandatory;}
                .selectitem {height:48px;display:flex;align-items:center;justify-content:center;text-align:center;font-size:18px;font-weight:500;opacity:.5;scroll-snap-align: center;cursor:pointer;}
                    .selectitem.current {opacity: 1;}

                    .stepper .selectitem:first-child {padding-top:72px;}
                    .stepper .selectitem:last-child {padding-bottom:72px;}


                body .range {width:100% !important;display:block;height:48px;}


        .menurowtitle {font-size:12px;text-transform:uppercase;color:var(--secondarytext);font-weight:500;letter-spacing:0.5px;}
                .slidervalue {float:right;font-size:12px;font-weight:500;}


        .fontsize {font-feature-settings: "tnum";}




        
         .colorpicker  {width:200px;border-radius:4px;display:inline-block;background-color:rgb(37, 37, 37);box-shadow:inset 0 0 0 2px rgb(62, 62, 62);position: relative;z-index: 2;}
         .colorgrid  {width:208px;height:208px;box-shadow:inset 0 0 0 2px rgba(0,0,0,.05);position:relative;
            background-image:linear-gradient(to top, #000, rgba(204, 154, 129, 0)), linear-gradient(to right, #fff, rgba(204, 154, 129, 0));
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);

            border-radius:calc(var(--toolbarradius) - 6px);
        }
         .colorpanel  {position:relative;}
         input.hue  {margin:8px 8px 0;height:24px;width: 136px;margin-left: 56px;}
         input.alpha  {height:24px;width:136px;margin-left: 56px;}
         .hue::-webkit-slider-runnable-track  {background: linear-gradient(to right, red 0%, #ff0 17%, lime 33%, cyan 50%, blue 66%, #f0f 83%, red 100%) !important;}
         .alpha::-webkit-slider-runnable-track  {background-image:  linear-gradient(to left, #20CC89, transparent), url(./imgs/alpha.png) !important;}
         .colorpicker .handle  {width:8px;height:8px;border:3px solid white;box-shadow:0 0 0 3px #333;position:absolute;top:0;left:0;border-radius:50%;transition:background 125ms ease-in-out;}

         .thecolor  {width:32px;height:32px;position:absolute;top:12px;left:12px;border-radius: 2px;overflow: hidden;box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);}
         .thecolor::after  {content: '';position:absolute;top:0;left:0;right:0;bottom:0;z-index:-2;background:url(./imgs/alpha.png);}
         .oldcolor  {width:50%;position:absolute;top:0;left:0;bottom:0;background:#20CC89;box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);}

        .cube .colorgrid {width:344px;padding-bottom:344px;height:0;}


        .colorvalues {}
          .colorvalues input {width:100%;margin-right:8px;}
            .colorvalues input.hexinput {width:92px;}

        .cubewrap {position:relative;}

          .cubewrap .handle {position: absolute;top: 0;left: 0;border-radius: 50%;border: 3px solid white;box-shadow: 0 0 0 2px rgba(0,0,0,.05);width:20px;height:20px;transition: border-color 125ms ease-in-out;box-sizing:border-box;}

          .oldcolor {right:0;left:auto;}

        .colorslide {margin-bottom:12px;border-radius:calc(var(--toolbarradius) - 8px);margin-top:12px;height:36px;}
            .colorslide input {height:48px;margin-top:-6px;width:100%;}


        .cubeeye {width: 48px;height: 48px;position: absolute;right: 48px;top: -2px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
            .cubeeye svg {width:24px;height:24px;}
                .cubeeye svg * {fill:var(--icon);}
                .cubeeye:hover svg * {fill:var(--iconcurrent);}
                .cubeeye:active svg * {fill:var(--iconcurrent);}

        .svgiconcolor {cursor:pointer;}
            .svgiconcolor svg {width:24px;height:24px;}
                .svgiconcolor svg * {fill:var(--icon);}
                .svgiconcolor:hover svg * {fill:var(--iconcurrent);}
                .svgiconcolor:active svg * {fill:var(--iconcurrent);}

        .dropper {position:absolute;right:12px;}
            .dropper svg {width:24px;height:24px;}
                .dropper svg * {fill:var(--icon);}

                .dropper:hover svg * {fill:var(--iconcurrent);}
                .dropper:active svg * {fill:var(--iconcurrent);}

        #hide {position:fixed;top:0;right:0;padding:14px 12px;z-index:834573894753895;opacity:.54;cursor:pointer;transition:all 150ms ease-in-out;}
            #hide:hover {opacity:.7;}
            #hide:active {opacity:.9;}

        #layers {height:100%;pointer-events:none;position:relative;z-index:2;}
            #layers > * {pointer-events:all;}


        .toast {position:fixed;top:12px;right:212px;z-index:999999999999;background:var(--panel);border-radius:var(--toolbarradius);box-shadow: 0 4px 20px var(--shadow2);display:flex;padding:8px;align-items:center;}
            .hidetweak .toast {right:12px;}

            .toast .message {font-weight:600;padding-left:4px;}
            .toast .dismiss {cursor:pointer;padding:0 12px;height:48px;font-weight:600;background:rgba(255,255,255,.05);border-radius:calc(var(--toolbarradius) - 4px);display:flex;align-items:center;margin-left:12px;}
                .toast .dismiss:hover {background:rgba(255,255,255,.075);}
                .toast .dismiss:active {background:rgba(255,255,255,.1);}


        .tnum {font-feature-settings:'tnum';}

        .btn {width:48px;height:48px;display:flex;align-items:center;justify-content:center;}
            .btn svg {width:24px;height:24px;}
                .btn svg * {fill:white;}



        .colorwheel2 {}
        .pie {
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-top: 80px solid red;
            transform: rotate(0);
            transform-origin: bottom center;
            position:absolute;top:0;left:0;
        }

        .pie:nth-child(1) {transform: rotate(0deg);}
        .pie:nth-child(2) {transform: rotate(12deg);}
        .pie:nth-child(3) {transform: rotate(24deg);}
        .pie:nth-child(4) {transform: rotate(36deg);}
        .pie:nth-child(5) {transform: rotate(48deg);}
        .pie:nth-child(6) {transform: rotate(60deg);}
        .pie:nth-child(7) {transform: rotate(72deg);}
        .pie:nth-child(8) {transform: rotate(84deg);}
        .pie:nth-child(9) {transform: rotate(96deg);}
        .pie:nth-child(10) {transform: rotate(108deg);}
        .pie:nth-child(11) {transform: rotate(120deg);}
        .pie:nth-child(12) {transform: rotate(132deg);}
        .pie:nth-child(13) {transform: rotate(144deg);}
        .pie:nth-child(14) {transform: rotate(156deg);}
        .pie:nth-child(15) {transform: rotate(168deg);}
        .pie:nth-child(16) {transform: rotate(180deg);}
        .pie:nth-child(17) {transform: rotate(192deg);}
        .pie:nth-child(18) {transform: rotate(204deg);}
        .pie:nth-child(19) {transform: rotate(216deg);}
        .pie:nth-child(20) {transform: rotate(228deg);}
        .pie:nth-child(21) {transform: rotate(240deg);}
        .pie:nth-child(22) {transform: rotate(252deg);}
        .pie:nth-child(23) {transform: rotate(264deg);}
        .pie:nth-child(24) {transform: rotate(276deg);}
        .pie:nth-child(25) {transform: rotate(288deg);}
        .pie:nth-child(26) {transform: rotate(300deg);}
        .pie:nth-child(27) {transform: rotate(312deg);}
        .pie:nth-child(28) {transform: rotate(324deg);}
        .pie:nth-child(29) {transform: rotate(336deg);}
        .pie:nth-child(30) {transform: rotate(348deg);}


        .colorwheel {position:relative;top:0;left:0;margin-left:0;width:264px;height:264px;border-radius:50%;overflow:hidden;transform:translateZ(0);color:white;}
        .colorblur {position:absolute;width:160px;height:160px;transform:translate(60px, -50%) scale(2);left:50%;top:50%;-webkit-filter:blur(28px);}

        .piecover {position:absolute;top:24px;left:24px;right:24px;bottom:24px;background:var(--panel);border-radius:50%;}
        .spin {position:absolute;top:0;left:0;right:0;bottom:0;cursor:pointer;}
        .spinhandle {width:16px;height:16px;position:absolute;left:50%;transform:translateX(-50%);top:4px;border-radius:50%;background:transparent;border:2px solid white;box-sizing:border-box;box-shadow:0 0 0 2px rgba(0,0,0,.05);}
        /* .spintri {-webkit-clip-path: polygon(50% 0%, 0% 100%, 100% 100%);-moz-clip-path: polygon(50% 0%, 0% 100%, 100% 100%);clip-path: polygon(50% 0%, 0% 100%, 100% 100%);background:red;position:absolute;top:24px;left:40px;right:40px;bottom: 76px;background-image:linear-gradient(45deg, white, transparent 70%), linear-gradient(-45deg, black, transparent 70%);} */
        .spintri {background:red;position:absolute;top:28px;left:28px;right:28px;bottom: 28px;background-image:linear-gradient(to top, #000, rgba(204, 154, 129, 0)), linear-gradient(to right, #fff, rgba(204, 154, 129, 0));border-radius:50%;}

            .trihandle {position:absolute;top:-8px;left:-8px;width:12px;height:12px;position:absolute;transform:translate(134px, 44px);border-radius:50%;background:transparent;border:2px solid white;box-sizing:border-box;box-shadow:0 0 0 2px rgba(0,0,0,.05);pointer-events:none;}
    </style>
</head>
<body class="rectanglex brush_tool ">
    <div id=toolbar>
        <div class=handle>
            <div class=fakehandle>
                <svg class=close xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 11h12v2H6z"/></svg>
                <svg class=open xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>
        <div class=tools>
            <div class=tool>
                <div class=toolbtn id=select_tool data-tool=select>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:28px;" viewBox="0 0 24 24">
                        <path style="transform: rotate(-20deg);transform-origin: center;" d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                    </svg> -->
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path style="transform: rotate(-20deg);transform-origin: center;" d="M12 7.27l4.28 10.43-3.47-1.53-.81-.36-.81.36-3.47 1.53L12 7.27M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M28.1,16.6c0-0.5-0.3-0.9-0.8-1.1L9.8,9c-0.5-0.2-1-0.1-1.3,0.3C8.2,9.6,8,10.1,8.2,10.6l6.4,17.5c0.2,0.5,0.6,0.8,1.1,0.8	c0,0,0,0,0.1,0c0.5,0,0.9-0.3,1.1-0.7l2.8-5.8l5.5,5.6c0.2,0.2,0.6,0.4,0.9,0.4c0.3,0,0.6-0.1,0.9-0.4c0.5-0.5,0.5-1.3,0-1.8	l-5.5-5.6l5.9-2.9C27.8,17.5,28.1,17.1,28.1,16.6z M19,19.1c-0.2,0.1-0.4,0.1-0.5,0.3c-0.1,0.1-0.2,0.3-0.3,0.5L16,24.5l-4.5-12.2	l12.2,4.5L19,19.1z"/>
                    </svg>
                </div>
                <div class="options contextpanel">
                    <div class=optionwrap>
                        <div class="option marqueeselect current" data-menu=smenu> 
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
                        </div><div class="option morebtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn data-tool=rectangle id=shape_tool2>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 4H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H6V6h12v12z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M7,8v22h22V8H7z M26,27H10V11h16V27z"/>
                    </svg>
                </div>
                <div class="options contextpanel">
                    <!-- <div class=controls>
                        <div class=control id=shapecolor>
                            <div class=label>Color</div>
                            <div class=option>
                                <div class=fill id=shapefill style="background: rgb(255, 59, 48);"></div>
                            </div>
                        </div>
                    </div> -->
                    <div class=optionwrap>
                        <div class="option shapetype" data-menu=shapemenu>
                            <div class="shapeicon square"></div>
                        </div><div class="option fillcolor shapefillactual" data-menu=bgmenu2> 
                            <div class="fill shape2fill" id=shapefill style="background:rgb(255, 59, 48);"></div>
                        </div><div class="option shapeborder shapeborderactual" data-menu=bmenu>
                            <div class="border"></div>
                        </div><div class="option morebtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn data-tool=type id=type_tool2>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 17v2h14v-2H5zm4.5-4.2h5l.9 2.2h2.1L12.75 4h-1.5L6.5 15h2.1l.9-2.2zM12 5.98L13.87 11h-3.74L12 5.98z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" >
                        <polygon points="29,10 7,10 7,13 16.5,13 16.5,27.5 19.5,27.5 19.5,13 29,13 "/>
                    </svg>
                </div>
                <div class="options contextpanel">
                    <!-- <div class=controls>
                        <div class=control id=font>
                            <div class=label>Font</div>
                            <div class=option>Helvetica</div>
                        </div>
                        <div class=control>
                            <div class=label>Size</div>
                            <div class="option stepped">24</div>
                        </div>
                        <div class=control>
                            <div class=label>Color</div>
                            <div class=option id=textfill2>Blue</div>
                        </div>
                    </div> -->
                    <div class=optionwrap>
                        <div class="option typeface" data-menu=tfmenu>
                            <div class=flyout>
                                <div class=label>Helvetica</div>
                            </div>
                        </div><div class="option fontsize" data-menu=fsmenu>
                            <div class=flyout>
                                <div class=label>24</div><div class=icon>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M7,10l5-5l5,5H7z"/>
                                        <path d="M7,14l5,5l5-5H7z"/>
                                    </svg>
                                </div>
                            </div>
                        </div><div class="option textcolor textcoloractual" data-menu=tcmenu>
                            <div class="fill textfill" style="background:white;"></div>
                        </div><div class="option morebtn">
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg> -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tool active">
                <div class=toolbtn data-tool=brush>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:28px;" viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"/></svg> -->
                    <!-- <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24"><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg> -->
                    <!-- <svg xmlns="http://www.w3.org/2000/svg"  style="width:28px;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M13.9,33c-0.4,0-0.9-0.2-1.2-0.6c-0.5-0.7-0.4-1.6,0.3-2.1c0.7-0.5,1.1-1.5,1.4-2.7c-3.1-1.4-5-4-5.5-7.2		c-0.7-5.1,3-8.6,6-11.5c1.7-1.6,3.4-3.2,3.4-4.4C18.3,3.6,19,3,19.8,3c0.8,0,1.5,0.7,1.4,1.6C21.1,7,19.1,8.9,16.9,11		c-2.8,2.6-5.6,5.4-5.1,8.9c0.3,2.3,1.8,3.7,3.1,4.5c0.5-3.3,1-7.1,4.3-8.3c2.6-1,5.3-0.1,6.9,2.2c1.7,2.6,1.5,5.9-0.5,8.1		c-1.8,1.9-5.1,2.7-8.3,2.1c-0.4,1.7-1.1,3.2-2.4,4.2C14.5,32.9,14.2,33,13.9,33z M17.8,25.5c2.3,0.4,4.6,0,5.6-1.1		c1.2-1.3,1-3.2,0.2-4.4c-0.4-0.6-1.4-1.8-3.3-1.1c-1.6,0.6-2,2.8-2.4,6C17.8,25.1,17.8,25.3,17.8,25.5z"/>
                    </svg>
                </div>
                <div class="options contextpanel" style="max-width: 208px;">
                    <!-- <div class=controls>
                        <div class=control id=brushsize>
                            <div class=label>Size</div>
                            <div class=option>
                                <div class=size>
                                    <div class=actual id=brushactual></div>
                                </div>
                            </div>
                        </div>
                        <div class=control id=brushcolor>
                            <div class=label>Color</div>
                            <div class=option>
                                <div class=fill id=brushfill></div>
                            </div>
                        </div>
                    </div> -->
                    <div class=optionwrap>
                        <div class="option brushsize brushsizeactual" data-menu=bsmenu>
                            <div class="size" style="margin:0;">
                                <div class="actual brushactual2"></div>
                            </div>
                        </div><div class="option brushcolor brushcoloractual" data-menu=bcmenu>
                            <div class="fill brushfill2" id=brushfill2></div>
                        </div><div class="option morebtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn data-tool=upload>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <polygon points="29,16.5 19.5,16.5 19.5,7 16.5,7 16.5,16.5 7,16.5 7,19.5 16.5,19.5 16.5,29 19.5,29 19.5,19.5 29,19.5 "/>
                    </svg>
                </div>
                <div class="options contextpanel">
                    <div class=optionwrap>
                        <div class="option uploadfileactual" data-menu=umenu style="padding: 0 12px;"> 
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg> -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                        </div><div class="option importfileactual" data-menu=imenu style="padding: 0 12px;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
                        </div><div class="option morebtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn id=canvas_tool data-tool=canvas>
                        <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:24px;" viewBox="0 0 22 22"><path d="M25-378H41v16H25Zm2,2v12H39v-12Zm-5-5h2v2H22Zm0,20h2v2H22Zm20,0h2v2H42Zm0-20h2v2H42Z" transform="translate(-22 381)" fill="#fff" fill-rule="evenodd"/></svg> -->
                        <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                            <g transform="translate(-59 -557)">
                                <polygon points="68,570.5 65,570.5 65,563 72.5,563 72.5,566 68,566"/>
                                <polygon points="89,570.5 86,570.5 86,566 81.5,566 81.5,563 89,563"/>
                                <polygon points="72.5,587 65,587 65,579.5 68,579.5 68,584 72.5,584"/>
                                <polygon points="89,587 81.5,587 81.5,584 86,584 86,579.5 89,579.5"/>
                            </g>
                        </svg>
                </div>
                <div class="options contextpanel">
                    <div class=optionwrap>
                        <div class="option canvasfillactual" data-menu=bgmenu3> 
                            <div class="fill canvasfill2" id=canvasfill style="background: linear-gradient(to right, var(--null) 3px, transparent 3px) 12.5px;box-shadow: inset 0 0 0 3px var(--null);transform: rotate(45deg);"></div>
                        </div><div class="option canvasborder canvasborderactual" data-menu=cbmenu>
                            <div class="border" style="border-color:grey;"></div>
                        </div><div class="option morebtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:28px;" viewBox="0 0 20 20"><path d="M15.95 10.78c.03-.25.05-.51.05-.78s-.02-.53-.06-.78l1.69-1.32c.15-.12.19-.34.1-.51l-1.6-2.77c-.1-.18-.31-.24-.49-.18l-1.99.8c-.42-.32-.86-.58-1.35-.78L12 2.34c-.03-.2-.2-.34-.4-.34H8.4c-.2 0-.36.14-.39.34l-.3 2.12c-.49.2-.94.47-1.35.78l-1.99-.8c-.18-.07-.39 0-.49.18l-1.6 2.77c-.1.18-.06.39.1.51l1.69 1.32c-.04.25-.07.52-.07.78s.02.53.06.78L2.37 12.1c-.15.12-.19.34-.1.51l1.6 2.77c.1.18.31.24.49.18l1.99-.8c.42.32.86.58 1.35.78l.3 2.12c.04.2.2.34.4.34h3.2c.2 0 .37-.14.39-.34l.3-2.12c.49-.2.94-.47 1.35-.78l1.99.8c.18.07.39 0 .49-.18l1.6-2.77c.1-.18.06-.39-.1-.51l-1.67-1.32zM10 13c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M8,28V8h20l-6.4,6.4h-7.2v7.2L8,28z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <div id=advancedpanel class="panel draggable">
        <div class="pan brushpanel">
            <div class=row>
                <div class=input>
                    <input type=text value="BLue" />
                    <div class=label>Color</div>
                </div>
            </div>
            <div class=row>
                <div class=input>
                    <input type=text value="Open Sans" />
                    <div class=label>Size</div>
                </div>
            </div>
        </div>
        <div class="pan typepanel">
            <div class=row>
                <div class=input>
                    <input type=text value="Open Sans" />
                    <div class=label>Font</div>
                </div>
            </div>
            <div class=row>
                <div class=input>
                    <input type=text value=Bold />
                    <div class=label>Style</div>
                </div>
                <div class=input style="width:50%;">
                    <input type=number value=24 />
                    <div class=label>Size</div>
                </div>
            </div>
            <div class=row style="margin-top: 8px;">
                <div class=input>
                    <div class=buttons>
                        <button class=selected>Left</button><button>Center</button><button>Right</button>
                    </div>
                    <div class=label>Alignment</div>
                </div>
            </div>
            <div class=row>
                <div class=input>
                    <input type=number value=0 />
                    <div class=label>Kern</div>
                </div>
                <div class=input>
                    <input type=number value=40 />
                    <div class=label>Line</div>
                </div>
                <div class=input>
                    <input type=number value=0 />
                    <div class=label>Break</div>
                </div>
            </div>
        </div>
    </div>

    <div id=brush_context class=contextpanel>
        <div class="option" id="brushsize">
            <div class="size" style="margin:0;">
                <div class="actual brushactual2" id="brushactual"></div>
            </div>
        </div><div class="option" id=brushcolor>
            <div class="fill brushfill2" id="brushfill"></div>
        </div>
    </div>

    <div id=panels style="display:none;">
        <div class="panel shapes_panel" id=shapes_panel style="border-radius: var(--toolbarradius);padding: 2px 4px;">
            <div class="minishape rx" data-type=rectanglex><div class="square shapeicon"></div></div><div class="minishape cx" data-type=circlex><div class="circle shapeicon"></div></div>
        </div>
        <div class=panel id=fontsize_panel style="padding:4px;border-radius:32px;margin-left:18px;transform:translateY(4px);">
            <div class=slider data-y=136>
                <div class=knob style="top: 136px; transform: translateX(-50%) scale(0.3);"></div>
            </div>
        </div>
        <div class=panel id=brushsize_panel style="padding:4px;border-radius:32px;margin-left:18px;transform:translateY(4px);">
            <div class=slider data-y=136>
                <div class=knob style="top: 136px; transform: translateX(-50%) scale(0.3);"></div>
            </div>
        </div>
        <div class=panel id=brushcolor_panel data-id=brush style="margin-left: -80px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=shapecolor_panel data-id=shape style="margin-left: -80px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=textcolor_panel data-id=text style="margin-left: -80px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=shape2color_panel data-id=shape2 style="margin-left: -80px;width:456px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=font_panel style="opacity:0;transform:translateY(8px);height:364px;width:356px;">
            <div class=slide>
                <div class=list>
                    <div class="item current">Helvetica</div>
                    <div class=item>San Francisco</div>
                    <div class=item>Futura</div>
                    <div class=item>Segoe</div>
                    <div class=item>Avant Garde</div>
                    <div class=item>DIN</div>
                    <div class=item>Avenir</div>
                    <div class=item>Frutiger</div>
                </div>
            </div>
            <div class=slide>
                <div class=row>
                    <div class=input>
                        <input type=text value="Open Sans" />
                        <div class=label>Font</div>
                    </div>
                </div>
                <div class=row>
                    <div class=input>
                        <input type=text value=Bold />
                        <div class=label>Style</div>
                    </div>
                    <div class=input style="width:50%;">
                        <input type=number value=24 />
                        <div class=label>Size</div>
                    </div>
                </div>
                <div class=row style="margin-top: 8px;">
                    <div class=input>
                        <div class=buttons>
                            <button class=selected>Left</button><button>Center</button><button>Right</button>
                        </div>
                        <div class=label>Alignment</div>
                    </div>
                </div>
                <div class=row>
                    <div class=input>
                        <input type=number value=0 />
                        <div class=label>Kern</div>
                    </div>
                    <div class=input>
                        <input type=number value=40 />
                        <div class=label>Line</div>
                    </div>
                    <div class=input>
                        <input type=number value=0 />
                        <div class=label>Break</div>
                    </div>
                </div>
            </div>
            <div class=page>
                <div class=dot onclick="dots.call(this,event,0)"></div>
                <div class="dot current" onclick="dots.call(this,event,1)"></div>
            </div>
        </div>

        <div id=shape_context class=contextpanel>
            <div class=optionwrap>
                <!-- <div class=option>
                    <div class=recticon></div>
                </div> -->
                <div class="option fillcolor" data-menu=bgmenu> <!-- id=shape2color -->
                    <div class="fill shape2fill" style="background:rgb(255, 59, 48);"></div>
                </div><div class="option shapeborder" data-menu=bordermenu>
                    <div class="border" id="shapeborder"></div>
                </div><div class="option shapeup">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
                </div><div class="option shapeback">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
                </div><div class="option lock" onclick="this.classList.toggle('unlock');">
                    <svg xmlns="http://www.w3.org/2000/svg" class=locked viewBox="0 0 24 24"><path d="M18,8H17V6A5,5,0,0,0,7,6V8H6a2,2,0,0,0-2,2V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V10A2,2,0,0,0,18,8ZM9,6a3,3,0,0,1,6,0V8H9Zm9,14H6V10H18Z"/></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class=unlocked viewBox="0 0 24 24"><path d="M18,8h-1V6c0-2.8-2.2-5-5-5S7,3.2,7,6h2c0-1.7,1.3-3,3-3s3,1.3,3,3v2H6c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12 c1.1,0,2-0.9,2-2V10C20,8.9,19.1,8,18,8z M18,20H6V10h12V20z"/></svg>
                </div><div class="option morebtn">
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            
                <div class="content"></div>
            </div>
        </div>

        <div id=img_context class=contextpanel>
            <!-- <div class="option fillcolor" data-menu=bgmenu>
                <div class="fill shape2fill" style="background:rgb(255, 59, 48);"></div>
            </div><div class="option shapeborder" data-menu=bordermenu>
                <div class="border" id="shapeborder"></div>
            </div> -->
            <div class="option shapeup">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
            </div><div class="option shapeback">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
            </div><div class="option lock" onclick="this.classList.toggle('unlock');">
                <svg xmlns="http://www.w3.org/2000/svg" class=locked viewBox="0 0 24 24"><path d="M18,8H17V6A5,5,0,0,0,7,6V8H6a2,2,0,0,0-2,2V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V10A2,2,0,0,0,18,8ZM9,6a3,3,0,0,1,6,0V8H9Zm9,14H6V10H18Z"/></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class=unlocked viewBox="0 0 24 24"><path d="M18,8h-1V6c0-2.8-2.2-5-5-5S7,3.2,7,6h2c0-1.7,1.3-3,3-3s3,1.3,3,3v2H6c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12 c1.1,0,2-0.9,2-2V10C20,8.9,19.1,8,18,8z M18,20H6V10h12V20z"/></svg>
            </div><div class="option morebtn">
                <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg> -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        
            <div class="content"></div>
        </div>

        <div class="panel" id=border_panel>
            <!-- <div class="slider horizontal">
                slider
            </div> -->
            <div class="swatches">
                <div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div>
            </div>
        </div>

        <div id=text_context class=contextpanel>
            <div class=optionwrap>
                <div class="option typeface" data-menu=tfmenu>
                    <div class=flyout>
                        <div class=label>Helvetica</div>
                    </div>
                </div><div class="option fontsize" data-menu=fsmenu>
                    <div class=flyout>
                        <div class=label>24</div><div class=icon>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M7,10l5-5l5,5H7z"/>
                                <path d="M7,14l5,5l5-5H7z"/>
                            </svg>
                        </div>
                    </div>
                </div><div class="option textcolor" data-menu=textcolormenu>
                    <div class="fill textfill" id="textfill" style="background:white;"></div>
                </div><div class="option shapeup">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
                </div><div class="option shapeback">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
                </div><div class="option lock" onclick="this.classList.toggle('unlock');">
                    <svg xmlns="http://www.w3.org/2000/svg" class=locked viewBox="0 0 24 24"><path d="M18,8H17V6A5,5,0,0,0,7,6V8H6a2,2,0,0,0-2,2V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V10A2,2,0,0,0,18,8ZM9,6a3,3,0,0,1,6,0V8H9Zm9,14H6V10H18Z"/></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class=unlocked viewBox="0 0 24 24"><path d="M18,8h-1V6c0-2.8-2.2-5-5-5S7,3.2,7,6h2c0-1.7,1.3-3,3-3s3,1.3,3,3v2H6c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12 c1.1,0,2-0.9,2-2V10C20,8.9,19.1,8,18,8z M18,20H6V10h12V20z"/></svg>
                </div><div class="option showkeyboard">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
                </div><div class="option morebtn">
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            </div>
        </div>

        <div id=moremenu>
            <div class=mitem>Copy</div>
            <div class="mitem duplicate">Duplicate</div>
            <div class="mitem delete">Delete</div>
            <div class="mitem mlevel">Comment</div>
            <div class=mitem>Export</div>
            <div class="mitem mlevel">Align</div>
            <div class=mgap></div>
            <div class="mitem mlevel">Properties</div>
            <div class="mitem mlevel">Share</div>
            <div class="mitem mlevel">Link To</div>
        </div>

        <div id=moremenu2>
            <div class=mitem>Save Default</div>
            <div class="mitem ">Copy Style</div>

            <!-- <div class=mgap></div> -->
            <div class="mitem mlevel">Properties</div>
            <div class="mitem ">Reset</div>
        </div>

        <div id=bgmenu>
            <div class=menutitle>Background Color</div>
            <!-- <div class=menutabs>
                Transparent   Current    color select
            </div> -->
            
        </div>

        <div id=smenu>
            <div class="btn"> 
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
            </div>
            <div class="btn" >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.6 6.62c-1.44 0-2.8.56-3.77 1.53L12 10.66 10.48 12h.01L7.8 14.39c-.64.64-1.49.99-2.4.99-1.87 0-3.39-1.51-3.39-3.38S3.53 8.62 5.4 8.62c.91 0 1.76.35 2.44 1.03l1.13 1 1.51-1.34L9.22 8.2C8.2 7.18 6.84 6.62 5.4 6.62 2.42 6.62 0 9.04 0 12s2.42 5.38 5.4 5.38c1.44 0 2.8-.56 3.77-1.53l2.83-2.5.01.01L13.52 12h-.01l2.69-2.39c.64-.64 1.49-.99 2.4-.99 1.87 0 3.39 1.51 3.39 3.38s-1.52 3.38-3.39 3.38c-.9 0-1.76-.35-2.44-1.03l-1.14-1.01-1.51 1.34 1.27 1.12c1.02 1.01 2.37 1.57 3.82 1.57 2.98 0 5.4-2.41 5.4-5.38s-2.42-5.37-5.4-5.37z"/></svg>
            </div>
        </div>

        <div id=bgmenu2>
            <div class=menutitle>Background Color</div>
        </div>

        <div id=bgmenu3>
            <div class=menutitle>Background Color</div>
        </div>

        <div id=shapemenu>
            <!-- <div class=menutitle>Shape</div> -->
            <div class="minishape rx" data-type=rectanglex><div class="square shapeicon"></div></div><div class="minishape cx" data-type=circlex><div class="circle shapeicon"></div></div>
        </div>

        <div id=bsmenu>
            <!-- <div class=menutitle>Brush Size</div> -->
            <div class="slider" data-y="136">
                <div class="knob" style="top: 136px; transform: translateX(-50%) scale(0.3);"></div>
            </div>
        </div>

        <div id=bcmenu>
            <div class=menutitle>Brush Color</div>
        </div>

        <div id=tcmenu>
            <div class=menutitle>Text Color</div>
        </div>

        <div id=fsmenu style="min-width:80px;">
            <!-- <div class=menutitle>Font Size</div> -->
            
        </div>

        <div id=umenu>
            <div class=menutitle>Upload</div>
        </div>

        <div id=imenu>
            <div class=list style="margin:-12px -4px -12px;border:none;">
                <div class="item">Google Drive</div>
                <div class=item>Dropbox</div>
                <div class=item>Box</div>
                <div class=item>OneDrive</div>
                <div class=item>iCloud Drive</div>
            </div>
        </div>

        <div id=tfmenu>
            <!-- <div class=menutitle>Typeface</div> -->
            <div class=list style="margin:-12px -4px -12px;border:none;height:286px;">
                <div class="item current">Helvetica</div>
                <div class=item>San Francisco</div>
                <div class=item>Futura</div>
                <div class=item>Segoe</div>
                <div class=item>Avant Garde</div>
                <div class=item>DIN</div>
                <div class=item>Avenir</div>
                <div class=item>Frutiger</div>
            </div>
        </div>

        <div id=bordermenu>
            <div class=menutitle>Border Style</div>

            <div class=menurow style="justify-content: space-between;padding:4px 8px 0;">
                <div class=menurowtitle>Border Thickness</div>
                <div class=slidervalue></div>
                <!-- <input type=range class="range borderwidth" min=0 max=24 value=0 /> -->
                <div class="slider hslider" data-x=5 data-y=2 data-min=0 data-max=24 data-value=0 data-callback=borderwidth>
                    <div class=track></div>
                    <div class=knob style="left: 4px; transform: translateY(-50%) scale(0.142857);"></div>
                </div>
            </div>

            <div class=menurowtitle style="padding:0 8px;">Border Color</div>
    
        </div>

        <div id=bmenu>
            <div class=menutitle>Border Style</div>

            <div class=menurow style="justify-content: space-between;padding:4px 8px 0;">
                <div class=menurowtitle>Border Thickness</div>
                <div class=slidervalue></div>
                <!-- <input type=range class="range borderwidth" min=0 max=24 value=0 /> -->
                <div class="slider hslider" data-x=5 data-y=2 data-min=0 data-max=24 data-value=0 data-callback=borderwidth>
                    <div class=track></div>
                    <div class=knob style="left: 4px; transform: translateY(-50%) scale(0.142857);"></div>
                </div>
            </div>

            <div class=menurowtitle style="padding:0 8px;">Border Color</div>
    
        </div>

        <div id=cbmenu>
            <div class=menutitle>Border Color</div>
        </div>

        <div id=textcolormenu>
            <div class=menutitle>Text Color</div>
 
        </div>

        <div id=stepper_temp>
            <div class="step stepup">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M4.1,16L12,8l7.9,7.9H4.1z"/>
                </svg>                    
            </div>
            <div class="stepdown step">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M20.1,8L12.2,16L4.2,8H20.1z"/>
                </svg>
            </div>
            <div class=stepvalue>00</div>
        </div>

        <div id=colorswatches>
            <div class=colors>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
            </div>
            <div class=menurow>
                <div class="menubtn transparentcolor color">
                    <div class=nullcolor></div>
                </div>
                <div class="menubtn selectcolor" data-menu=huecube>
                    <div class=rainbowcolor></div>
                </div>
                <div class="menubtn selectcolor dropper" data-menu=huecube>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42zM6.92 19L5 17.08l8.06-8.06 1.92 1.92L6.92 19z"/></svg>
                </div>
            </div>
        </div>

        <div class="colorwrap2 colorwheel2" id=colorwheel>

            <div class="relative" style="height:264px;">
                <div class="colorwheel" data-deg="357.4438499214217">
                    <div class="colorrotate" style="transform: rotate(72deg);
                    width: 100%;height: 100%;">
                        <div class="colorblur">
                            <div class="pie" style="border-top-color:#ffff00;"></div>
                            <div class="pie" style="border-top-color:#d1ff00;"></div>
                            <div class="pie" style="border-top-color:#a2ff00;"></div>
                            <div class="pie" style="border-top-color:#73ff00;"></div>
                            <div class="pie" style="border-top-color:#3fff00;"></div>
                            <div class="pie" style="transform: rotate(60deg);border-top-color:#11ff00;"></div>
                            <!--<div class=pie style="border-top-color:#00ff1d;"></div>-->
                            <div class="pie" style="border-top-color:#00ff4c;"></div>

                            <div class="pie" style="border-top-color:#00ff80;"></div>
                            <div class="pie" style="border-top-color:#00ffae;"></div>
                            <div class="pie" style="border-top-color:#00ffdd;"></div>
                            <div class="pie" style="border-top-color:#00f3ff;"></div>
                            <div class="pie" style="border-top-color:#00bfff;"></div>
                            <div class="pie" style="border-top-color:#0091ff;"></div>
                            <div class="pie" style="border-top-color:#0062ff;"></div>

                            <div class="pie" style="border-top-color:#0033ff;"></div>
                            <div class="pie" style="border-top-color:#0000ff;"></div>
                            <div class="pie" style="border-top-color:#2e00ff;"></div>
                            <div class="pie" style="border-top-color:#5d00ff;"></div>
                            <div class="pie" style="border-top-color:#8f00ff;"></div>
                            <!--<div class=pie style="transform: rotate(240deg);border-top-color:#bf00ff;"></div>-->
                            <div class="pie" style="border-top-color:#ee00ff;"></div>

                            <div class="pie" style="border-top-color:#ff00e2;"></div>
                            <div class="pie" style="border-top-color:#ff00b3;"></div>
                            <div class="pie" style="border-top-color:#ff0080;"></div>
                            <div class="pie" style="border-top-color:#ff0051;"></div>
                            <div class="pie" style="border-top-color:#ff0022;"></div>
                            <div class="pie" style="border-top-color:#ff0c00;"></div>
                            <div class="pie" style="border-top-color:#ff3f00;"></div>

                            <div class="pie" style="border-top-color:#ff6e00;"></div>
                            <div class="pie" style="border-top-color:#ff9d00;"></div>
                            <div class="pie" style="border-top-color:#ffcc00;"></div>
                        </div>
                    </div>
                    <div class="piecover bg3"></div>
                    <div class="spin" style="transform: rotate(357.444deg);">
                        <div class="spinhandle"></div>
                        <!--<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 138.56 120">
                        <polygon points="69.28 0 138.56 120 0 120 69.28 0"/>
                        </svg>-->
                        <div class="spintri" style="background-color: rgb(255, 0, 11);">
                        </div>
                        <div class="trihandle" style="background-color: rgb(185, 136, 139); transform: translate(106.576px, 147.415px);" data-s="25.686865474112068" data-l="63.01339482140872"></div>
                    </div>
                </div>
                <!--linear-gradient(to right, red 0%, #ff0 17%, lime 33%, cyan 50%, blue 66%, #f0f 83%, red 100%);-->
            </div>
        </div>

        <div class="colorwrap2 cube " id=huecube>
            <div class="cubewrap">
                <div class="colorgrid" style="background-color:hsla(260, 100%, 50%, 1);" data-alpha="1" data-hue="260" data-s="100" data-l="50">
                    <div tabindex="0" class="handle colorhalo" style="transform: translate(254px, 16px);"></div>
                </div>
                <div class="cubeslides">
                    <div class="rotateslides">
                    <div class="colorslide regular clip hue" style="width:100%;background: linear-gradient(to right, red 0%, #ff0 17%, lime 33%, cyan 50%, blue 66%, #f0f 83%, red 100%);">
                        <input type="range" class="nocolor hue2 hueslide huecubeslide" value="260" max="360" style="margin-left: -8px;margin-right: -8px;width: calc(100% + 16px);padding:0;">
                    </div>
                    <div class="colorslide regular clip alpha alphacubeslide" style="width:100%;background: linear-gradient(to left, hsla(260, 100%, 50%, 1), hsla(260, 100%, 50%, 0)), url(./imgs/alpha.png);">
                        <input type="range" class="nocolor alpha2 alphaslide alphacubeslide2" value="100" max="100">
                    </div>
                    </div>
                </div>
                <div style="position:relative;">
                    <div class="thecolor" style="background-color:hsla(260, 100%, 50%, 1);position:absolute;left:0;width:36pxpx;height:36pxpx;border-radius:50%;top:4px;">
                        <div class="oldcolor" style="background-color:hsla(260, 100%, 50%, 1);"></div>
                    </div>
                    <div class="colorvalues" style="padding: 0 0 4px 48px;">
                    <input type="text" placeholder="0" value="#5501ff" class="quiet hexinput" style="font-feature-settings: 'tnum';">
                    
                    <div style="display:none"><input type="number" placeholder="0" value="260" class="quiet redinput"><input type="number" placeholder="0" value="100" class="quiet greeninput"><input type="number" placeholder="0" value="50" class="quiet blueinput"><input type="number" placeholder="0" value="100" class="quiet alphainput"></div>
                        
                    <div class="btn cubeeye">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42zM6.92 19L5 17.08l8.06-8.06 1.92 1.92L6.92 19z"/></svg>
                    </div>
                    <div class="addbutton addswatch svgiconcolor " style="position:absolute;top:-2px;right:0;height: 48px;width:48px;display: flex;align-items: center;  justify-content: center;  cursor: pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" style="padding:7px;">
                        <path d="M14.5,8H10V3.5A0.5,0.5,0,0,0,9.5,3h-1a0.5,0.5,0,0,0-.5.5V8H3.5a0.5,0.5,0,0,0-.5.5v1a0.5,0.5,0,0,0,.5.5H8v4.5a0.5,0.5,0,0,0,.5.5h1a0.5,0.5,0,0,0,.5-0.5V10h4.5A0.5,0.5,0,0,0,15,9.5v-1A0.5,0.5,0,0,0,14.5,8Z"></path>
                        </svg>
                    </div>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <canvas id="canvas2" style="cursor: crosshair; position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; width: 100%; height: 100%;z-index:1;"></canvas>

    <div id=hide title="Hide/Show Tweak Panel">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </div>
    <div id=tweaks>
        <h4>Tweaks </h4>
        <div class=tweak>
            <label><input type=checkbox value=light class=tweakr /><div class=toggle></div> Light</label>
        </div>
        <div class=tweak>
            <label><input type=checkbox value=ui2 id=ui2t class=tweakr onchange="document.getElementById('ui3t').checked=false;" /><div class=toggle></div> Solid Toolbar</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=horizontal id=hui class=tweakr onchange="document.getElementById('ui3t').checked=false;" /><div class=toggle></div> Horizontal Toolbar</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=ui3 id=ui3t class=tweakr onchange="document.getElementById('ui2t').checked=false;document.getElementById('hui').checked=false;" /><div class=toggle></div> Horizontal Bar 2</label>
        </div>

        <!-- <div class=tweak>
            <label><input type=checkbox value=ui4 id=ui4t class=tweakr onchange="" /><div class=toggle></div> UI 4</label>
        </div> -->

        <div class=tweak>
            <label><input type=checkbox value=advanced class=tweakr /><div class=toggle></div> Advanced Panel</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=insert class=tweakr /><div class=toggle></div> Insert</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=grid class=tweakr id=bggrid onchange="document.getElementById('bgdots').checked=false;" /><div class=toggle></div> Grid</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=dotgrid class=tweakr id=bgdots onchange="document.getElementById('bggrid').checked=false;" /><div class=toggle></div> Dot Grid</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=highlight class=tweakr /><div class=toggle></div> Grid Markers</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=hidebrush class=tweakr /><div class=toggle></div> Brush Context</label>
        </div>

        <div class=tweaked>
            <div class=tweak>
                <div class=label><span>Grid Size</span><div class=value>48</div></div>
                <input type=range class=tooltweak min=24 max=960 value=48 step=12 data-id=grid oninput="gridtweak.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Button Size</span><div class=value>60</div></div>
                <input type=range class=tooltweak min=16 max=76 value=60 step=4 data-id=toolbtn oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Button Gap</span><div class=value>12</div></div>
                <input type=range class=tooltweak min=0 max=32 value=12 step=2 data-id=toolgap oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Button Radius</span><div class=value>50</div></div>
                <input type=range class=tooltweak min=0 max=50 value=50 step=2 data-id=toolradius oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Tool Panel Radius</span><div class=value>12</div></div>
                <input type=range class=tooltweak min=0 max=32 value=12 step=2 data-id=toolbarradius oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Icon Scale</span><div class=value>52</div></div>
                <input type=range class=tooltweak min=0 max=100 value=52 step=2 data-id=toolicons oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Selection Gap</span><div class=value>0</div></div>
                <input type=range class=tooltweak min=0 max=24 value=0 step=2 data-id=selectgap oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Selection Thickness</span><div class=value>2</div></div>
                <input type=range class=tooltweak min=1 max=4 value=2 step=1 data-id=selectwidth oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Selection White Inlay</span><div class=value></div></div>
                <label style="padding:0;"><input type=checkbox class=tweakr value="selectwhite" id=selectwhite onchange="document.getElementById('selectblack').checked=false;" /><div class=toggle></div> </label>
            </div>
            <div class=tweak>
                <div class=label><span>Selection Black Inlay</span><div class=value></div></div>
                <label style="padding:0;"><input type=checkbox class=tweakr value="selectblack" id=selectblack onchange="document.getElementById('selectwhite').checked=false;" /><div class=toggle></div> </label>
            </div>
            <div class=tweak>
                <div class=label><span>Handle Spacing</span><div class=value>-4</div></div>
                <input type=range class=tooltweak min=-24 max=24 value=-4 step=2 data-id=handlegap oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Handle Size</span><div class=value>8</div></div>
                <input type=range class=tooltweak min=4 max=24 value=8 step=2 data-id=handlesize oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Color</span><div class="value"></div></div>
                <input type=color id=toolbarhex onchange="toolbarcolor.call(this,event)" value="#282931" />
            </div>
            <div class=tweak>
                <div class=label><span>Workspace Color</span><div class=value></div></div>
                <input type=color onchange="canvascolor.call(this,event)" value="#323440" />
            </div>
            <div class=tweak>
                <div class=label><span>Selection Color</span><div class=value></div></div>
                <input type=color onchange="selectioncolor.call(this,event)" value="#00CEFF" />
            </div>
            <div class=tweak>
                <div class=label><span>Handle Color</span><div class=value></div></div>
                <input type=color onchange="handlecolor.call(this,event)" value="#00CEFF" />
            </div>
            <div class=tweak>
                <div class=label><span>Icon Color - <span id=iconcontrast></span></span><div class=value></div></div>
                <input type=color id=iconcolor onchange="iconcolor.call(this,event)" value="#BBBBBB" />
            </div>
            <div class=tweak>
                <div class=label><span>Tool Selection Color </span><div class=value></div></div>
                <input type=color onchange="toolselectioncolor.call(this,event)" value="#1b1b1c" />
            </div>

        </div>
    </div>

    <div id=keyboard class=draggable>
        <div class=row>
            <div class=key>q</div><div class=key>w</div><div class=key>e</div><div class=key>r</div><div class=key>t</div><div class=key>y</div><div class=key>u</div><div class=key>i</div><div class=key>o</div><div class=key>p</div><div class="key del">Del</div>
        </div>
        <div class=row>
            <div class=key style="margin-left: 16px;">a</div><div class=key>s</div><div class=key>d</div><div class=key>f</div><div class=key>g</div><div class=key>h</div><div class=key>j</div><div class=key>k</div><div class=key>l</div><div class=key>'</div><div class="key return">Return</div>
        </div>
        <div class=row>
            <div class="key shift">Shift</div><div class=key>z</div><div class=key>x</div><div class=key>c</div><div class=key>v</div><div class=key>b</div><div class=key>n</div><div class=key>m</div><div class=key>,</div><div class=key>.</div><div class=key>?</div>
        </div>
        <div class=row>
            <!-- <div class="key num">&123</div> --><div class="key space">Space</div>
        </div>
    </div>



    <div class="toolbar minimized toolbar4">
        <div class="handle fob">
            <div class=fakehandle>
                <svg class=close xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 11h12v2H6z"/></svg>
                <svg class=open xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>

            <div class=menu>
                <div class=item>Select</div>
                <div class=item>Shapes</div>
                <div class=item>Text</div>
                <div class=item>Draw</div>
                <div class=item>Components</div>
                <div class=item>Canvas</div>
                <div class=item>Settings</div>
            </div>

            <div class=submenu>
                brush size color opacity
                <div class="suboption brushsize"></div>
                <div class="suboption brushcolor"></div>
                <div class="suboption brushopacity"></div>
            </div>
        </div>

        <style>
            .toolbar {position:fixed;z-index:99999999;top:calc(100% - 64px);left:16px;}
            .fob {left:0;top:0;}
            .fob .fakehandle {width:36px;height:36px;background:#0262FD;box-shadow:0 3px 30px rgba(0,0,0,.25);}
            .fob .fakehandle svg {width: 24px;height: 36px;}

            .menu {position:absolute;bottom:56px;left:8px;padding: 4px 0;background:white;border-radius:6px;box-shadow:0 3px 40px rgba(0,0,0,.3);width:200px;min-height:200px;transition:all 150ms ease-in-out;opacity:0;pointer-events:none;transform:translateY(8px);}
            .toolbar:not(.minimized) .menu {opacity:1;pointer-events:all;transform:translateY(0);}

            .menu .item {font-size:16px;color:black;font-weight:600;}

            .submenu {position:absolute;top:0;left:56px;padding:0 4px;background:white;border-radius:6px;width:200px;height:48px;box-sizing:border-box;opacity:0;}
                .suboption {width:48px;height:100%;float:left;opacity:0;}


            input[type=color] {width: 100%;height: 36px;display: block;padding: 0;border: none;}
        </style>
    </div>

    <div id=layers></div>

    <script>
        TEXTSIZE = 24;
        TEXTCOLOR = 'white';
        TYPEFACE = 'Helvetica';
        LAYERSCALE = 1;
        GRIDSIZE = 48;
        DELTASCALE = 1;

        function toolbarcolor(e){
            var n = 'tweaked_toolbar';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;
            var rgb = hex2rgb(v);
            console.log(rgb);
            var hsl = rgb2hsl(rgb);
            console.log(hsl)

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var hsv = hsl2hsv(hsl);

            var s2 = hsv[1];
            var v2 = hsv[2];

            var v2a = Math.max(v2 - .15, 0);
            var v2b = Math.max(v2 - .25, 0);
            var v2c = Math.max(v2 - .1, 0);

            var hsl1 = hsv2hsl([hsv[0], s2, v2a]);
            var hsl2 = hsv2hsl([hsv[0], s2, v2b]);
            var hsl3 = hsv2hsl([hsv[0], s2, v2c]);

            //var hover = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) - 4) + '%)';
            // var press = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) - 6) + '%)';
            // var pressed = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) - 14) + '%)';

            var hover = 'hsl(' + hsl[0] + ',' + hsl3[1] + '%,' + hsl3[2] + '%)';
            var press = 'hsl(' + hsl[0] + ',' + hsl1[1] + '%,' + hsl1[2] + '%)';
            var pressed = 'hsl(' + hsl[0] + ',' + hsl2[1] + '%,' + hsl2[2] + '%)';

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --tool: ' + v + ';';//
            
            css += '--toolhover: ' + hover + ';';
            css += '--toolpress: ' + press + ';--toolselect: ' + press + ';--toolselect3: ' + hover + ';--panel: ' + press + ';--toolselect2: ' + pressed + ';';
            // css += '--ui: ' + rgb[0] + ',' + rgb[1] + ',' + rgb[2];
            css += '}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);

            console.log(v);

            iconcolor.call(document.getElementById('iconcolor'), e);
        }

        function hsv2hsl(hsv) {
            var h = hsv[0];
            var s = hsv[1] || 0;
            var v = hsv[2] || 0;

            var l = (2 - s) * v / 2;
            var ss = l && l < 1 ? s * v / ( l < 0.5 ? l * 2 : 2- l * 2) : s;

            return [h, ss * 100, l * 100];
        }
        function iconcolor(e){
            var n = 'tweaked_icons';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;
            var rgb = hex2rgb(v);
            console.log(rgb);
            var hsl = rgb2hsl(rgb);
            console.log(hsl)

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var l = 20;
            var b = brightness(rgb);
            //var b  = luminanace(rgb[0], rgb[1], rgb[2]);
            console.log(b, 'LUMS');

            var thex = document.getElementById('toolbarhex').value;
            var trgb = hex2rgb(thex);

            var rast = contrast(rgb, trgb);

            var arast = contrast(hsl2rgb([hsl[0],hsl[1],hsl[2] + l]), trgb);

            console.log(rast, arast);

            if ( rast < 1 ){
                rast = 1/rast;
            }

            if ( arast < 1 ){
                arast = 1/arast;
            }

            console.log(rast, arast);
            
            if ( arast < rast ){ 
                l = -20;
            }

            document.getElementById('iconcontrast').innerText = Math.round(rast * 100) / 100;

            var current = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) + l) + '%)';

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --icon: ' + v + ';';
            css += '--iconcurrent: ' + current + ';';
            css += '}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function canvascolor(e){
            var n = 'tweaked_canvas';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--canvas: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);

            var rgb = hex2rgb(v);

            var con = contrast(rgb, [255,255,255]);
            var con2 = contrast(rgb, [0,0,0]);

            if ( con < 1 ){
                con = 1/con;
            }

            if ( con2 < 1 ){
                con2 = 1/con2;
            }

            console.log(con,con2)

            if ( con < con2 ){
                document.body.classList.add('darkgrid');
            } else {
                document.body.classList.remove('darkgrid');
            }
        }

        function selectioncolor(e){
            var n = 'tweaked_select';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--select: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function toolselectioncolor(e){
            var n = 'tweaked_toolselect';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--toolselect2: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function handlecolor(e){
            var n = 'tweaked_handlecolor';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--handlecolor: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function handlegap(e){
            var n = 'tweaked_handlecolor';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--handlegap: ' + v + 'px;}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function tweakedtools(e){
            var n = 'tweaked_css';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var t = document.getElementsByClassName('tooltweak');

            var s = document.createElement('style');
            s.className = n;
            var css = ':root{';

            for(var i=0;i<t.length;i++){
                var a = t[i];
                var p = a.getparent('tweak');
                var l = p.getElementsByClassName('value')[0];
                var d = a.dataset.id;
                var v = a.value;

                var x = 'px';
                if ( d == 'toolradius' || d == 'toolicons' ){
                    x = '%';
                }

                css += '--' + d +  ':' + v + x + ';';

                if ( this === a ){
                    l.empty();
                    l.appendChild(document.createTextNode(v));
                }
            }

            css += '}';

            s.appendChild(document.createTextNode(css));
            
            document.head.appendChild(s);

            console.log(v);
        }

        function luminanace(rgb) {
            var a = rgb.map(function (v) {
                v /= 255;
                return v <= 0.03928 ? v / 12.92 : Math.pow( (v + 0.055) / 1.055, 2.4 );
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }

        function brightness(rgb){
            return ((rgb[0] * 299) + (rgb[1] * 587) + (rgb[2] * 114)) / 1000;
        }

        function contrast(rgb1, rgb2) {
            return (luminanace(rgb1) + 0.05) / (luminanace(rgb2) + 0.05);
        }

        function hex2rgb(hex){
            if (/^#/.test(hex)){
                hex = hex.slice(1);
            }
            if (hex.length !== 3 && hex.length !== 6 ){
                throw new Error("Invaild hex String");
            }
            
            var digit = hex.split("");
            
            if (digit.length === 3){
                digit = [ digit[0], digit[0], digit[1], digit[1], digit[2], digit[2] ];
            }
            var r = parseInt( [digit[0], digit[1] ].join(""), 16 );
            var g = parseInt( [digit[2], digit[3] ].join(""), 16 );
            var b = parseInt( [digit[4], digit[5] ].join(""), 16 );

            return [r,g,b];
        }

        function hsl2rgb(hsl){
            var h = hsl[0] / 359;
            var s = hsl[1] / 100;
            var l = hsl[2] / 100;

            var r, g, b;

            if(s == 0){
                r = g = b = l; // achromatic
            } else {
                var hue2rgb = function hue2rgb(p, q, t){
                    if(t < 0) t += 1;
                    if(t > 1) t -= 1;
                    if(t < 1/6) return p + (q - p) * 6 * t;
                    if(t < 1/2) return q;
                    if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                }

                var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                var p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }

            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function rgb2hsl(rgb){
            var r = rgb[0];
            var g = rgb[1];
            var b = rgb[2];
            r /= 255, g /= 255, b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, l = (max + min) / 2;

            if(max == min){
                h = s = 0; // achromatic
            }else{
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch(max){
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
        }

        function dots(e, x){
            var p = this.getparent('panel');
            var ss = p.getElementsByClassName('slide');
            var s = ss[x];
            var l = s.offsetLeft;
            var w = s.offsetWidth;

            var d = p.getElementsByClassName('dot current');
            d.removeclass('current');

            this.classList.add('current');

            for(var i=0;i<ss.length;i++){
                var a = ss[i];
                a.style.transition = 'transform 150ms ease-in-out';
                a.style.transform = 'translateX(' + (l + w) + 'px)';
            }

            p.dataset.x = (l+w);
        }

        function tools(e){
            var tool = this.dataset.tool;

            if ( !tool ){
                return;
            }

            tool += '_tool';

            if ( document.body.classList.contains(tool) ){

                return;
            }

            document.body.className = document.body.className.replace(/\w*_tool/g, '');

            document.body.classList.add(tool);
        }

        function tooltoggle(e){
            this.classList.toggle('toggled');
    
            if ( this.getElementsByClassName('toolbtn')[0].dataset.tool == 'upload'){
                this.classList.add('toggled');
            }

            closepanel();
        }

        function toolhandler(e){
            tools.call(this, e);

            var t = this.getparent('tool');
            if ( t.classList.contains('active')){
                tooltoggle.call(t, e);
                return;
            }

            if ( document.documentElement.classList.contains('ui3') || this.dataset.tool == 'upload' ){
                tooltoggle.call(t, e);
            }

            var tb = t.getparent('toolbar');
            var c = tb.getElementsByClassName('tool active');

            c.removeclass('toggled');
            c.removeclass('active');

            t.classList.add('active');

            closepanel();

            var bc = document.getElementById('brush_context');

            bc.style.opacity = 0;
            bc.style.pointerEvents = 'none';
            bc.style.transform = 'translateY(6px)';

            if ( this.dataset.tool != 'select'){
                blurall();
            }
        }

        function closepanel(){
            var ps = document.getElementsByClassName('panel2');

            for(var i=0;i<ps.length;i++){
                var p = ps[i];
                p.addEventListener('transitionend', removethis);

                p.style.opacity = 0;
                p.style.transform = 'translateY(8px)';
            }
        }

        function draggable(e){
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var tar = e.target;
            var t = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var offset = this.offset();

            var ox = offset.x;
            var oy = offset.y;

            var nx = ox;
            var ny = oy;

            var moved = false;

            t.style.left = t.style.top = 0;
            t.style.right = t.style.bottom = 'auto';

            t.style.transform = 'translate(' + ox + 'px, ' + oy + 'px)';

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                nx = x - sx;
                ny = y - sy;

                nx += ox;
                ny += oy;

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                } else if ( !moved ){
                    return;
                }

                e.preventDefault();
                e.stopPropagation();

                t.style.transform = 'translate(' + Math.round(nx) + 'px, ' + Math.round(ny) + 'px)';
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( !moved ){
                    //tar.click();
                }

                console.log(nx,ny);

                t.style.transform = 'translate(0, 0)';

                t.style.left = Math.round(nx) + 'px';
                t.style.top = Math.round(ny) + 'px';
            }

            window.addEventListener('touchmove', move, {passive:false});
            window.addEventListener('touchend', end, {passive:false});

            window.addEventListener('mousemove', move, {passive:false});
            window.addEventListener('mouseup', end), {passive:false};
        }

        function handlehandler(e){
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var _h = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var t = this.getparent('toolbar');

            if ( !t ){
                return;
            }

            var off = t.offset();

            var ox = off.x;
            var oy = off.y;

            var hoff= this.offset();
            var tox = hoff.x;
            var toy = hoff.y;

            var moved = false;

            closepanel();

            var diffx = ox - tox;

            if ( tox < ox ){
                //ox = tox;
            }

            t.style.transform = 'translate(' + ox + 'px, ' + oy + 'px)';

            t.style.left = 0;
            t.style.top = 0;
            t.style.marginTop = 0;

            var ww = window.innerWidth;
            var wh = window.innerHeight;

            var w = off.w;
            var h = off.h;

            var gap = 16;


            var tx1 = gap + diffx;// + 44;
            var tx2 = ww - gap - w;

            var ty1 = gap;
            var ty2 = wh - gap - h;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                var nx = x - sx;
                var ny = y - sy;

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                } else if ( !moved ){
                    return;
                }

                e.preventDefault();
                e.stopPropagation();

                nx += ox;
                ny += oy;

                if ( nx < tx1 ){
                    nx = tx1;
                } else if ( nx > tx2 ){
                    nx = tx2;
                }

                if ( ny < ty1 ){
                    ny = ty1;
                } else if ( ny > ty2 ){
                    ny = ty2;
                }

                if ( nx > ww * .75 && !document.documentElement.classList.contains('ui3') ){
                    t.classList.add('swap');
                } else {
                    t.classList.remove('swap');
                }

                t.style.transform = 'translate(' + nx + 'px, ' + ny + 'px)';

                t.dataset.x = nx;
                t.dataset.y = ny;
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( !moved && _h.classList.contains('handle') ){
                    toggletoolbar.call(t, e);
                }
            }

            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('touchend', end, {passive: false});

            window.addEventListener('mousemove', move, {passive: false});
            window.addEventListener('mouseup', end, {passive: false});
        }

        function toggletoolbar(e){
            e.preventDefault();
            e.stopPropagation();
            console.log('toggle');

            this.classList.toggle('minimized');

            var a = document.getElementsByClassName('tool current toggled')[0];
            if ( a ){
                a.classList.remove('toggled');
            }

            var p = document.getElementsByClassName('panel2');
            p.remove();
        }

        function removethis(e){
            console.log('remove');
            if ( this && this.parentNode ){
                this.parentNode.removeChild(this);
            }
        }

        function panelhandler(e){
            var ep = document.getElementsByClassName('panel2');

            if (ep[0]){
                closepanel();
                return;
            }

            var id = this.id;
            var pid = id + '_panel';
            var p = document.getElementById(pid);

            if ( !p ){
                return;
            }

            var c = p.cloneNode(true);

            var bounds = this.getBoundingClientRect();
            var x = bounds.x;
            var y = bounds.y;

           
            c.style.left = x + 'px';

            c.removeAttribute('id');

            c.classList.add('panel2');

            document.body.appendChild(c);


            //var off = c.offsetTop;

            if ( y < c.offsetHeight + 24 ){
                c.style.top = y + 56 + 'px';
            } else {
                c.style.top = (y - (c.offsetHeight + 12 )) + 'px';
            }


            c.offsetLeft;

            c.style.opacity = 1;
            c.style.transform = 'translateY(0)';


        }

        function swipehandler(e){
            //e.preventDefault();
            //e.stopPropagation();
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var tar = ev.target;
            var _h = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var p = this.getparent('panel');
            var ss = p.getElementsByClassName('slide');
            var w = p.offsetWidth;

            var ox = Number(p.dataset.x) || 0;
            var oy = Number(p.dataset.y) || 0;

            var moved = false;

            var nx = 0;
            var ny = 0;

            p.classList.remove('moving');

            var scrolling = false;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                nx = x - sx;
                ny = y - sy;

                if ( scrolling ){
                    //e.preventDefault();
                    //e.stopPropagation();
                    return;
                }

                if ( !moved && Math.abs(ny) - 5 > Math.abs(nx) ){
                    //e.preventDefault();
                    //e.stopPropagation();

                    scrolling = true;

                    return;
                }

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                    p.classList.add('moving');
                    
                } else if ( !moved ){
                    return;
                }

                if ( moved ){
                    e.preventDefault();
                    e.stopPropagation();
                }
                

                nx += ox;
                ny += oy;

                if ( nx > w ){
                    nx =  (w/2) + ((nx) / (Math.abs(nx/w)+1) );
                } else if ( nx < 0 ){
                    nx =  ((nx) / (Math.abs(nx/(w/4))+1) );
                }

                for(var i=0;i<ss.length;i++){
                    var a = ss[i];
                    a.style.transition = 'none';
                    a.style.transform = 'translateX(' + nx + 'px)';
                }

                //t.style.transform = 'translate(' + nx + 'px, ' + ny + 'px)';

                //t.dataset.x = nx;
                //t.dataset.y = ny;
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( scrolling){
                    return;
                } else if ( !moved  ){
                    console.log('clicked');

                    //tar.click();
                } else {

                    var oc = p.getElementsByClassName('dot current');
                    oc.removeclass('current');

                    if ( nx > w/2 ){
                        nx = w;

                        oc = p.getElementsByClassName('dot')[0];

                    } else if ( nx <= w/2 ){
                        nx = 0;
                        
                        
                        oc = p.getElementsByClassName('dot')[1];
                    }

                    if ( oc ){
                        oc.classList.add('current');
                    }

                    p.dataset.x = nx;

                    for(var i=0;i<ss.length;i++){
                        var a = ss[i];
                        a.style.transition = 'all 150ms ease-in-out';
                        a.style.transform = 'translateX(' + nx + 'px)';
                    }
                }
            }

            window.addEventListener('touchmove', move, {passive:false});
            window.addEventListener('touchend', end, {passive:false});

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function getdegree(ccx,ccy, wi, hi){
          var xxx = (wi/2) - ccx;
          var yyy = (hi/2) - ccy;
          console.log(xxx,yyy);

          var xx = Math.abs(xxx);
          var yy = Math.abs(yyy);

          var hh = Math.sqrt(Math.pow(xx, 2) + Math.pow(yy, 2));

          var arc = xx / hh;

          console.log(xx,yy,hh,arc);

          var arcsin = Math.asin(arc);

          var degrees = arcsin * (180/Math.PI);
          console.log(arcsin);
          console.log(degrees);


          if ( xxx <= 0 && yyy < 0){
            degrees = 180 - degrees;
          } else if ( xxx > 0 && yyy < 0 ){
            degrees = 180 + degrees;
          } else if ( xxx > 0 ){
            degrees = 360 - degrees;
          }

          console.log(degrees);

          return degrees;
        }

        function spin(e){
          e.preventDefault();
          var target = e.target;
          var spintri = target.getparent('spintri');
          var sx = e.pageX;
          var sy = e.pageY;
          var od = Number(this.dataset.deg) || 0;
          var _this = this;
          var w = this.offsetWidth;
          var h = this.offsetHeight;

          var _spin = this.getElementsByClassName('spin')[0];

          var w2 = w/2;
          var h2 = h/2

          var deg = 0;
          var moved = 0;

          var offtop = 0;
          var offleft = 0;
          var scroll = 0;

          console.log(e.target);

          var meow = this;

          while(meow){
            if ( meow.tagName !== 'SECTION'){
              offtop += meow.offsetTop;
              offleft += meow.offsetLeft;
              scroll += meow.scrollTop;
            }

            meow = meow.parentElement;
          }

          var correctionx = 0;//387;//same as below
          var correctiony = 0;//not sure why??

          console.log(offleft, offtop);

          //offleft = document.getElementById('proppanel').offsetLeft + 28;
          var cx = sx - offleft + correctionx;
          var cy = sy - offtop + correctiony;
          console.log(cx, cy);

          if ( spintri ){
            trilambda.call(target, e, cx, cy, od, offleft, offtop, correctionx, correctiony);
            return;
          }

          var deg = getdegree(cx, cy, w, h);


          _spin.style.transform = 'rotate(' + deg + 'deg)';
          _this.dataset.deg = deg;
          

          //var lr = w2 - cx;

          // var deg = 0;

          // //if ( lr >= 0 ){
          //   deg = -(lr / w2) * 90;
          // //} else {
          //   //deg = -(lr / w2) * 90;
          // //}

          // var tr = cy - h2;
          // if ( tr >= 0 ){
          //   var td = (tr / h2) * 90;
          //   if ( lr > 0 ){
          //     deg = -td  -90;
          //   } else {
          //      deg = td + 90;
          //   }
          // }



          var tri = this.getElementsByClassName('spintri')[0];
          var handle = this.getElementsByClassName('trihandle')[0];
          var sat = handle.dataset.s || 90;
          var lum = handle.dataset.l || 50;

          tri.style.transform = 'rotate(-' + deg + 'deg)';

          tri.style.backgroundColor = 'hsl(' + deg + ', 100%, 50%)';

          handle.style.backgroundColor = 'hsl(' + deg + ', ' + sat + '%, ' + lum + '%)';

          var cw = this.getparent('colorwrap2');
          //setval.call(cw, e, deg,sat,lum);

          window.addEventListener('mousemove', spinning);
          window.addEventListener('mouseup', spun);

          function spinning(e){
            var x = e.pageX;
            var y = e.pageY;

            var moved = 1;

            //deg = x - sx + od + (y - sy);

            //_this.style.transform = 'rotate('+ deg + 'deg)';
            //_this.dataset.deg = deg;

            var cx = x - offleft + correctionx;
            var cy = y - offtop + correctiony;
            console.log(cx, cy);

            //var lr = w2 - cx;

            var deg = getdegree(cx, cy, w, h);

            _spin.style.transform = 'rotate(' + deg + 'deg)';
            _this.dataset.deg = deg;

            tri.style.transform = 'rotate(-' + deg + 'deg)';


            tri.style.backgroundColor = 'hsl(' + deg + ', 100%, 50%)';
            handle.style.backgroundColor = 'hsl(' + deg + ', ' + sat + '%, ' + lum + '%)';

            console.log(deg);

            //setval.call(cw, e, deg,sat,lum);
          }

          function spun(e){
            window.removeEventListener('mousemove', spinning);
            window.removeEventListener('mouseup', spun);

            if ( !moved ){

            }

          }
        }

        function trilambda(e, x, y, a, ol, ot, cnx, cny){
          console.log('lambda lambda lambda');

          var tri = this.parentNode.getElementsByClassName('trihandle')[0];

          //x -= 141;
          //y -= 35;
          // var aa = a * (Math.PI/180);

          // var cos = Math.cos;
          // var sin = Math.sin;

          //var y2 = Math.abs(y * Math.cos(aa) - x * Math.sin(aa));
          //var x2 = y * Math.sin(aa) + x * Math.cos(aa);

          // var x2 = (x - 132) * cos(aa) - (y - 132) * sin(aa)  + 132;
          // var y2 = (x - 132) * sin(aa) + (y - 132) * cos(aa)  + 132;


          var radians = (Math.PI / 180) * a,
            cos = Math.cos(radians),
            sin = Math.sin(radians),
            cx = 132,
            cy = 132,
            x2 = (cos * (x - cx)) + (sin * (y - cy)) + cx,
            y2 = (cos * (y - cy)) - (sin * (x - cx)) + cy;


          console.log(x, y, a, x2, y2);


          tri.style.transform = 'translate(' + x2 + 'px, ' + y2 + 'px)';


          var s = Math.max(Math.min(100 - (((y2 - 30) / 158 ) * 100), 100), 0);
          var l = Math.max(Math.min(100-((x2-40) / 180) * 100, 100), 0);

          tri.dataset.s = s;
          tri.dataset.l = l;
          tri.style.backgroundColor = 'hsl(' + a + ',' + s+'%,' + l +'%)';

          var cw = this.getparent('colorwrap2');
          //setval.call(cw, e, a,s,l);

          function moving(e){
            var tar = e.target;
            if ( !tar || !tar.classList.contains('spintri') ){
              return;
            }
            var x = e.pageX;
            var y = e.pageY;
            x = x - ol + cnx;
            y = y - ot + cny;

            var x2 = (cos * (x - cx)) + (sin * (y - cy)) + cx;
            var y2 = (cos * (y - cy)) - (sin * (x - cx)) + cy;

            tri.style.transform = 'translate(' + x2 + 'px, ' + y2 + 'px)';

            var s = Math.max(Math.min(100 - (((y2 - 30) / 158 ) * 100), 100), 0);
            var l = Math.max(Math.min(100-((x2-40) / 180) * 100, 100), 0);

            console.log('COLOR', s, l);

            tri.dataset.s = s;
            tri.dataset.l = l;
            tri.style.backgroundColor = 'hsl(' + a + ',' + s+'%,' + l +'%)';

            //setval.call(cw, e, a,s,l);
          }

          function mouseup(){
            window.removeEventListener('mousemove', moving);
            window.removeEventListener('mouseup', mouseup);
          }


          window.addEventListener('mousemove', moving);
          window.addEventListener('mouseup', mouseup);

        }

        function menuhandler(e){
            var m = this.getparent('menu');
            
        }

        function listhandler(e){
            var l = this.getparent('list');
            if ( !l ){
                menuhandler.call(this, e);
                return;
            }
            var p = l.getparent('panel') || l.getparent('contextmenu');

            if ( !p || p.classList.contains('moving') ){
                return;
            }

            var c = l.getElementsByClassName('item current');

            c.removeclass('current');

            this.classList.add('current');

            if ( this.getparent('tfmenu') ){
                var v = this.innerText;

                var x = document.getElementsByClassName('contextpanel opened')[0];
                var x2 = x.getElementsByClassName('typeface')[0];
                var x3 = x2.getElementsByClassName('label')[0];

                var ow = x.getElementsByClassName('optionwrap')[0];

                ow.classList.add('notransition');

                x3.innerText = v;

                var xx = x.getElementsByClassName('option');

                var l = xx.length - 1;

                TYPEFACE = v;

                ow.offsetLeft;
                
                var ox = -( ow.offsetWidth - xx[l].offsetWidth );

                //alert(ox);

                ow.style.marginLeft = ox + 'px';

                ow.offsetLeft;

                ow.classList.remove('notransition');
            }

            //closepanel();
        }

        function tweak(e){
            var v = this.value;
            console.log(v);
            if ( v == 'ui3' ){
                document.documentElement.classList.remove('ui2');
                document.documentElement.classList.remove('horizontal');
            } else if ( v == 'ui2' ){
                document.documentElement.classList.remove('ui3');
            } else if ( v == 'horizontal' ){
                document.documentElement.classList.remove('ui3');
            } else if ( v == 'dotgrid' ){
                document.documentElement.classList.remove('grid');
            } else if ( v == 'grid' ){
                document.documentElement.classList.remove('dotgrid');
            } else if ( v == 'selectblack'){
                document.documentElement.classList.remove('selectwhite');
            } else if ( v == 'selectwhite'){
                document.documentElement.classList.remove('selectblack');
            }
            document.documentElement.classList.toggle(v);
        }

        function sliderhandler(e){
            e.preventDefault();
            e.stopPropagation();

            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }
            var s = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var _t = this;

            var ox = Number(this.dataset.x) || 0;
            var oy = Number(this.dataset.y) || 0;

            var moved = false;

            var nx = 0;
            var ny = 0;

            var k = this.getElementsByClassName('knob')[0];

            var dx = this.classList.contains('hslider') ? true : false;

            var size = dx ? 32 : 40;

            var w = this.offsetWidth;
            var h = this.offsetHeight;

            var t = dx ? w - size : h - size;


            var max = Number(this.dataset.max) || 0;
            var min = Number(this.dataset.min) || 0;

            var callback = this.dataset.callback;

            var minknob = dx ? 4 : 8;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                nx = x - sx;
                ny = y - sy;

                if ( !moved && (Math.abs(nx) > 4 ||  Math.abs(ny) > 4) ){
                    moved = true;
                } else if (!moved){
                    return;
                }
                
                nx += ox;
                ny += oy;

                var d = dx ? nx : ny;

                d = Math.min(Math.max(minknob, d), t);

                var z = (d - minknob) / (t - minknob);

                if ( !dx ){
                    z = 1-z;
                }


                // d = Math.max(8, Math.min(d, t));

                // var z = ((t - d) + 8) / t;

                // console.log(z, 'z');

                // if ( dx ){
                //     z = 1-z;
                // }

                // z = ((28 * z) + 8) / 36;

                var size2 = dx ? 28 : 32;

                var stx = dx ? 4 : 8;

                var scale = (((size2-stx) * z) + stx) / size2;

                var az = 36 * scale;
                
                

                console.log(az);

                s.dataset.x = Math.max(Math.min(nx, t), minknob);
                s.dataset.y = Math.max(Math.min(ny, t), minknob);

                var vv = Math.round(((max - min) * z) + min);


                s.dataset.value = vv;

                var sv = s.parentElement.getElementsByClassName('slidervalue')[0];
                if (sv ){
                    sv.innerText = vv;
                }

                if ( dx ){
                    k.style.left = d + 'px';
                    //z = 1 - z;
                    k.style.transform = 'translateY(-50%) scale(' + scale + ')';
                } else {
                    k.style.top = d + 'px';
                    k.style.transform = 'translateX(-50%) scale(' + scale + ')';
                }

                if ( _t.getparent('bmenu') ){
                    BORDERWIDTH = vv;

                    return;
                }

                if ( !dx ){

    
                    var ba = document.getElementById('brushactual');
                    var ba2 = document.getElementsByClassName('brushactual2')[0];

                    ba.style.width = ba.style.height = ba2.style.width = ba2.style.height = ba.parentElement.offsetHeight * scale + 'px';

                    BRUSHSIZE = az;
                }


                // if ( range ){
                //     var vv = ((max - min) * z) + min;
                //     range.value = Math.round(vv);
                // }                

                if ( callback ){
                    window[callback].call(s, e);
                }


            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( !moved ){
                    console.log('clicked');

                    var ev = e.touches ? e.touches[0] : e;
                    var x = sx;
                    var y = sy;

                    var off = s.offset();
                    var nx = off.x;
                    var ny = off.y;


                    nx = sx - nx - 16;
                    ny = sy - ny - 16;

                    var d = dx ? nx : ny;

                    d = Math.min(Math.max(minknob, d), t);

                    var z = (d - minknob) / (t - minknob);

                    if ( !dx ){
                        z = 1-z;
                    }


                    // d = Math.max(8, Math.min(d, t));

                    // var z = ((t - d) + 8) / t;

                    // console.log(z, 'z');

                    // if ( dx ){
                    //     z = 1-z;
                    // }

                    // z = ((28 * z) + 8) / 36;

                    var size2 = dx ? 28 : 32;

                    var stx = dx ? 4 : 8;

                    var scale = (((size2-stx) * z) + stx) / size2;

                    var az = 36 * scale;
                    
                    BRUSHSIZE = az;

                    console.log(az)

                    if ( dx ){
                        k.style.left = d + 'px';
                        //z = 1 - z;
                        k.style.transform = 'translateY(-50%) scale(' + scale + ')';
                    } else {
                        k.style.top = d + 'px';
                        k.style.transform = 'translateX(-50%) scale(' + scale + ')';
                    }

                    if ( !dx ){
                        var ba = document.getElementById('brushactual');
                        var ba2 = document.getElementsByClassName('brushactual2')[0];

                        ba.style.width = ba.style.height = ba2.style.width = ba2.style.height = ba.parentElement.offsetHeight * scale + 'px';
                    }

                    s.dataset.x = nx;
                    s.dataset.y = ny;

                    // if ( range ){
                    //     var vv = ((max - min) * z) + min;
                    //     range.value = Math.round(vv);
                    // }

                    var vv = Math.round(((max - min) * z) + min);


                    s.dataset.value = vv;

                    var sv = s.parentElement.getElementsByClassName('slidervalue')[0];
                    if (sv ){
                        sv.innerText = vv;
                    }

                    if ( callback ){
                        window[callback].call(s, e);
                    }

                } else {

                    if ( !dx ){
                        var temp = document.getElementById('brushsize_panel');
                        temp.empty();
                        var cc = s.cloneNode(true);

                        temp.appendChild(cc);
                    }

                    var bs = s.getparent('bsmenu');

                    if ( bs ){
                        var bs2 = document.getElementById('bsmenu');
                        bs2.empty();

                        var sc = s.cloneNode(true);

                        bs2.appendChild(sc);
                    }
                }

                closepanel();
            }

            window.addEventListener('touchmove', move);
            window.addEventListener('touchend', end);

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function swatchhandler(e){

            console.log('ugh')
            var c = window.getComputedStyle(this,null).backgroundColor;

            var id = this.getparent('panel').dataset.id;

            window[id + 'color'] = c;

            console.log(id);

            console.log(c);

            var qs = document.querySelector('.current .' + id + 'fill');
            if ( qs ){
                qs.style.background = c;

                var tw = qs.getparent('textwrap');
                var rc = qs.getparent('rectangle');

                if ( tw ){
                    var ta = tw.getElementsByClassName('textarea')[0];
                    ta.style.color = c;
                } else if (rc){
                    rc.style.backgroundColor = c;
                }
            }

            if ( id == 'brush'){
                document.getElementsByClassName('brushfill2')[0].style.background = c;
                BRUSHCOLOR = c;
            }

            if ( id == 'shape' ){
                var s2 = document.getElementById('shape2fill');
                if ( s2 ){
                    s2.style.background = c;
                }
            }

            if ( id == 'shape2' ){
                var ugh = document.getElementsByClassName('contextpanel visible')[0];
                var cid = ugh.id;
                var sh = document.getElementById(cid + 'rect');
                sh.style.background = c;

                ugh.getElementsByClassName('shape2fill')[0].style.background = c;

                //shapecolor = c;

                //document.getElementById('shapefill').style.backgroundColor = c;
            }

            if ( id == 'text' ){
                var ugh = document.getElementsByClassName('contextpanel visible')[0];
                var cid = ugh.id;
                var sh = document.getElementById(cid + 'rect');
                sh.getElementsByClassName('textarea')[0].style.color = c;

                ugh.getElementsByClassName('textfill')[0].style.background = c;

                //TEXTCOLOR = c;

                document.getElementById('textfill2').style.backgroundColor = c;
            }

            var pan = document.getElementById(id + 'fill');
            if ( pan ){
                pan.style.background = c;
            }

            closepanel();
        }

        function typetool(e){

            console.log('TYPETOOL');
            

            //blurelm.call(this, e);

            var p = e.target.getparent('textarea');
            var b = e.target.getparent('toolbar');
            var pp = e.target.getparent('panel');
            var tw = e.target.getparent('tweaks');

            var mw = e.target.getparent('menuwrap');

            var op = e.target.getparent('option');

            if ( p || b || pp || tw || mw || op ){
                return;
            }

            blurall();

            e = e.touches ? e.touches[0] : e;

            var w = document.createElement('div');
            var t = document.createElement('textarea');

            t.className = 'textarea';

            t.style.color = TEXTCOLOR;
            t.style.fontSize = TEXTSIZE + 'px';

            w.className = 'textwrap current layeritem';

            var x = e.pageX;
            var y = e.pageY;

            w.style.top = y - 24 + 'px';
            w.style.left = x + 'px';
            t.style.width = TEXTSIZE * 2 + 'px';
            t.style.height = TEXTSIZE + 12 + 'px';
            w.style.zIndex = 1337;

            var ops = document.getElementById('text_context').cloneNode(true);
            //ops.removeAttribute('id');

            var cid = 's' + Date.now() + '-' + Math.floor(Math.random()*1000);

            ops.id = cid;
            w.dataset.context = cid;
            
            w.id = cid + 'rect';

            document.body.appendChild(ops);

            ops.dataset.w = ops.offsetWidth;


            t.addEventListener('input', autoexpand);

            // t.onblur = function(){
            //     t.getparent('textwrap').classList.remove('current');
            //     t.readOnly = true;
            // }

            // var ops = document.getElementById('text_context').cloneNode(true);
            // ops.removeAttribute('id');

            w.appendChild(t);
            // w.appendChild(ops);

            document.getElementById('layers').appendChild(w);

            t.focus();

            document.getElementById('select_tool').click();

            t.parentElement.classList.add('current');

            setcontextpanel.call(w);

            //if ( e.touches ){
                //showkeyboard.call(w, e);
            //}

            document.getElementsByClassName('contextpanel visible')[0].getElementsByClassName('textfill')[0].style.background = TEXTCOLOR;
            document.getElementsByClassName('contextpanel visible')[0].getElementsByClassName('fontsize')[0].getElementsByClassName('label')[0].innerText = TEXTSIZE;
            document.getElementsByClassName('contextpanel visible')[0].getElementsByClassName('typeface')[0].getElementsByClassName('label')[0].innerText = TYPEFACE;
        }

        function keyboardshowhide(e){
            var k = document.getElementById('keyboard');

            if ( k && k.classList.contains('show') ){
                hidekeyboard();
            } else {
                showkeyboard.call(document.getElementsByClassName('layeritem current')[0], e);
            }
        }

        function showkeyboard(e){
            var off = this.offset(true);
            var x = off.x;
            var y = off.y;
            var h = off.h;
            var w = off.w;

            var k = document.getElementById('keyboard');

            var nx = x + (w/2) - ( k.offsetWidth/2);

            var ny = y + h + 80;

            if ( nx < 16 ){
                nx = 16;
            } else if ( nx > window.innerWidth - k.offsetWidth - 16 ){
                nx = window.innerWidth - k.offsetWidth - 16;
            }

            if ( ny > window.innerHeight  - k.offsetHeight - 16 ){
                ny = y - k.offsetHeight - 16 - 64;
            }

            k.style.top = ny + 'px';
            k.style.left = nx + 'px';
            k.style.transform = 'translateX(0)';

            k.classList.add('show');
        }

        function hidekeyboard(){
            var k = document.getElementById('keyboard');
            k.classList.remove('show');
        }

        function autoexpand(e){
            var v = this.value;

            var d = document.createElement('div');
            d.innerText = v;
            d.style.display = 'inline';
            d.style.whiteSpace = 'nowrap';
            d.style.fontSize = window.getComputedStyle(this).fontSize;

            document.body.appendChild(d);
            

            var w = d.offsetWidth;
            var h = d.offsetHeight;

            this.style.width = w + 9 + 'px';

            this.style.height = 0;
            var s = this.scrollHeight;

            this.style.height = s - 16 - 8 + 'px';

            d.parentNode.removeChild(d);

            if ( document.getElementsByClassName('contextpanel visible sublevel')[0] ){
                return;
            }

            setcontextpanel.call(this.getparent('textwrap'));
        }

        function blurall(e){
            var c = document.getElementsByClassName('layeritem current');
            c.removeclass('current');

            hidekeyboard();
    
            hidecontext();

            removebounding();
        }

        function blurelm(e){
            console.log('BLUR')
            var a = document.activeElement;//.blur();
            var c = document.getElementsByClassName('layeritem current');
            console.log(c[0]);
            if ( !c[0] || c[0] && (c[0] == a || this.getparent('current')) ){
                return;
            }
            console.log(a);
            a.blur();

            var ta = c[0].getElementsByClassName('textarea')[0];

            if ( ta ){
                ta.blur();
                ta.readOnly = true;
            }
            c.removeclass('current');

            hidecontext();
            hidekeyboard();

            var bc = document.getElementById('brush_context');

            bc.style.opacity = 0;
            bc.style.pointerEvents = 'none';
            bc.style.transform = 'translateY(6px)';

            removebounding();
        }

        function removebounding(e){
            var bb = document.getElementsByClassName('boundingbox');

            while(bb[0]){
                // bb[0].object.bounds = null;

                // console.log(bb[0].object);
                // bb[0].object['bounds'] = null;
                // console.log(bb[0].object['bounds']);

                // delete bb[0].object.bounds;
                bb[0].parentNode.removeChild(bb[0]);
            }
        }

        function hidecontext(){
            var p = document.getElementsByClassName('contextpanel visible');
            p.removeclass('visible');

            removemenu(); // closemenu();
        }

        function removemenu(){
            var m = document.getElementsByClassName('menuwrap');
            m.remove();
        }

        function texthandler(e){
            e.stopPropagation();
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var ta = this.getElementsByClassName('textarea')[0];

            blurelm.call(this, e);

            var sx = ev.pageX;
            var sy = ev.pageY;

            var t = this;

            var ox = Number(t.dataset.x) || 0;
            var oy = Number(t.dataset.y) || 0;

            var moved = false;

            var nx = 0;
            var ny = 0;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                var nx = x - sx;
                var ny = y - sy;

                if ( document.activeElement === ta ){ //if ( ta.readOnly === false ){
                    return;
                }

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                    //e.preventDefault();
                    e.stopPropagation();
                
                    hidecontext();
                } else if ( !moved ){
                    return;
                }

                nx += ox;
                ny += oy;

                t.style.transform = 'translate(' + nx + 'px, ' + ny + 'px)';

                t.dataset.x = nx;
                t.dataset.y = ny;
            }

            function end(e){
                e.preventDefault();
                e.stopPropagation();

                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                var off = t.offset();
                var ol = off.x;
                var ot = off.y;

                t.style.transform = 'translate(0px, 0px)';

                t.dataset.x = 0;
                t.dataset.y = 0;
                
                t.style.left = ol + nx + 'px';
                t.style.top = ot + ny + 'px';

                if ( !moved ){
                    console.log('clicked');

                    if ( !t.classList.contains('current')){

                        t.classList.add('current');
                        ta.readOnly = false;
                        ta.focus();

                        if ( e.touches ){

                            showkeyboard.call(t);
                        }
                    }

                    setcontextpanel.call(t);
                }
            }

            window.addEventListener('touchmove', move);
            window.addEventListener('touchend', end);

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function stopprop(e){
            e.preventDefault();
            e.stopPropagation();
        }

        function shapez(e){
            var b = this.classList.contains('shapeback');
            var r = document.getElementsByClassName('layeritem current')[0];
            var o = r.nextElementSibling;

            if ( b ){
                o = r.previousElementSibling;
                if ( o ){
                    r.parentNode.insertBefore(r, o);
                }
            } else if ( o ) {
                r.parentNode.insertBefore(r, o.nextElementSibling);
            }
        }

        function setcontextpanel(x){

            if ( !this || !this.className ){
                return;
            }

            contextfollow.call(this);
            var cid = this.dataset.context;

            var c = document.getElementById(cid);

            c.offsetLeft;

            c.classList.add('visible');
        }

        function contextfollow(){
            var off = this.offset();
            var x = off.x;
            var y = off.y;
            var w = off.w;
            var h = off.h;

            var st = window.pageYOffset || document.documentElement.scrollTop;
            var sl = window.pageXOffset || document.documentElement.scrollLeft;

            var cx = x - sl;
            var cy = y - st;

            var gap = 16;
            var thres = 16;

            //var y2 = y + h;

            var cid = this.dataset.context;

            var c = document.getElementById(cid);
            var cw = Number(c.dataset.w) || c.offsetWidth;
            var ch = c.offsetHeight;

            var ox = (w/2) - ( cw/2 );

            x = x + ox;

            var ww = window.innerWidth;
            var wh = window.innerHeight;

            console.log(cx, x, sl, cx + cw + ox, ww - thres);

            if ( cx < thres ){
                x = sl + thres;
            } else if ( cx + cw + ox > ww - thres ){
                x = ww - thres - cw + sl;
            }

            c.style.left = Math.round(x) + 'px';


            console.log(x,y, 'xy')


            // if ( hh - y2 >= 80 ){
            //     y = y2 + 16;
            // } else {
            //     if ( y > 80 ){
            //         y = y - 64;
            //     } else {
            //         y = Math.max(y, 0) + 16;
            //     }
            // }

            var y2 = y + h + gap;

            if ( cy > wh - h - ch - (gap*2) ){
                y2 = y - ch - gap;

                if ( cy < 80 ){
                    y2 = y + gap - cy;
                }
            }
            

            c.style.top = Math.round(y2) + 'px';

            // c.classList.remove('visible');
            c.classList.remove('opened');

            // console.log(c.firstElementChild);
            
            // c.firstElementChild.style.marginLeft = 0;
            // c.firstElementChild.style.tranform = 'none';
        
            removemenu();
        }

        function animationdone(e){
            this.removeEventListener('transitionend', animationdone);

            this.parentNode.removeChild(this);
        }

        function closemenu(e){

            console.log(e);
            e = e || {};
            var t = e.target || document.body;
            
            if ( t.classList.contains('delete') || t.getparent('contextmenu') || t.getparent('overflowmenu') || t.getparent('tweaks') || (t.getparent('option') && (e.type == 'mousedown' || e.type == 'touchstart')  ) ){
                return;
            }

            if ( e.target && e.type == 'click' ){
                e.preventDefault();
                e.stopPropagation();
            }
            
            var sub = document.getElementsByClassName('subsublevel');


            if ( sub[0] ){
                var am = document.getElementsByClassName('menuwrap visible');
                //am.remove();
               while(am[0]){
                    var amm = am[0];
                    amm.classList.add('remove');
                    amm.addEventListener('transitionend', animationdone);
                    amm.classList.remove('visible');
                }

                sub[sub.length-1].classList.add('visible');
                sub[sub.length-1].classList.remove('subsublevel');

                return;
            }
            

            // document.body.removeEventListener('mousedown', closemenu);
            // document.body.removeEventListener('touchstart', closemenu);
            // document.body.removeEventListener('click', closemenu);

            document.body.removeEventListener('mouseup', closemenu);
            document.body.removeEventListener('touchend', closemenu);

            var o = document.getElementsByClassName('contextpanel opened');
            o.removeclass('opened');

            var m = document.getElementsByClassName('menuwrap visible');

            while(m[0]){
                var mm = m[0];
                mm.classList.add('remove');
                mm.addEventListener('transitionend', animationdone);
                mm.style.transform = 'translateX(100%)';
                mm.classList.remove('visible');
            }
            //m.remove();

            var o = document.getElementsByClassName('contextpanel sublevel');

            if ( !o[0] ){
                return;
            }

            var o1 = o[0].getElementsByClassName('option')[0];

            o[0].classList.add('opened');
            
            o.removeclass('sublevel');

            var o2 = o1.getparent('optionwrap');

            if ( o2 ){
                o1 = o2;
            }

            o1.style.marginLeft = 0;

            o1.offsetLeft;

            o.removeclass('opened');

            var aa = document.getElementsByClassName('layeritem current')[0];

            if ( aa ){
                setTimeout(function(){
                    setcontextpanel.call(aa);
                }, 0);
            }

        }

        function backbtn(e){
            var b = document.createElement('div');
            b.className = 'backbtn';

            b.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>';

            return b;
        }

        function preclosemenu(e){
            var t = e.target;

            console.log(t, 'TARGET----');

            if ( !t.getparent('menuwrap') ){
                document.body.addEventListener('mouseup', closemenu);
                document.body.addEventListener('touchend', closemenu);
            }
        }

        function colormenu(e){
            e.preventDefault();
            e.stopPropagation();
            var c = this.getparent('contextpanel');
            var o = c.classList.contains('opened');
            if ( o ){
                return;
            
            }

            var shell = this.dataset.menu;

            if ( this.classList.contains('morebtn')){
                shell = 'moremenu';
            }

            var swap = false;

            if ( document.getElementById('toolbar').classList.contains('swap') ){
                swap = true;
            }

             c.classList.add('opened');

            var p = document.createElement('div');
            var m = document.getElementById(shell);

            var tool = this.getparent('tool') ? ' toolmenu' : '';
            var xx = false;
            if ( tool ){
                p.style.position = 'fixed';
                xx = true;
            }
            
            var coff = c.offset(xx);
            var x = coff.x;
            var y = coff.y;
            var w = coff.w;
            var h = coff.h;

           

            if ( shell == 'moremenu' && c.classList.contains('options') ){
                m = document.getElementById('moremenu2');
            }

            var s = document.getElementById('colorswatches').cloneNode(true);
            s.removeAttribute('id');

            p.className = 'menuwrap';

            
            m = m.cloneNode(true);

            m.removeAttribute('id');

            

            m.className = 'contextmenu ' + shell + tool;

            s.style.width = '336px';
            
            //m.appendChild(backbtn());
            // m.appendChild(s);

            p.appendChild(m);
            
            // document.body.addEventListener('mousedown', closemenu);
            // document.body.addEventListener('touchstart', closemenu);
            //document.body.addEventListener('click', closemenu);

            document.body.addEventListener('mousedown', preclosemenu);
            document.body.addEventListener('touchstart', preclosemenu);

            document.body.appendChild(p);

            if ( shell == 'bordermenu' ){
                m.appendChild(s);

                var bw = p.getElementsByClassName('hslider')[0];
                var kn = bw.getElementsByClassName('knob')[0];
                var sv = bw.parentElement.getElementsByClassName('slidervalue')[0];
                var rec = document.getElementsByClassName('layeritem current')[0];
                //bw.value = rec.dataset.border || 0;

                var com = window.getComputedStyle(rec);

                var ma = Number(bw.dataset.max);
                var mi = Number(bw.dataset.min);


                var br = Number(rec.dataset.border) || Number(com.borderWidth.replace('px', '')) || 0;

                sv.innerText = br;

                var z = (br / ma);
                var scale = ((24 * z) + 4) / 28;

                var lx = Math.max((bw.offsetWidth - 32) * z, 4);

                kn.style.left = lx + 'px';
                kn.style.transform = 'translateY(-50%) scale(' + scale +')';

                bw.dataset.x = lx;

                var bc = com.borderColor;

                var chips = p.getElementsByClassName('chip');
                for(var i=0;i<chips.length;i++){
                    var cc = chips[i];
                    if ( bc == window.getComputedStyle(cc).backgroundColor ){
                        cc.parentElement.classList.add('current');
                        break;
                    }
                }

            } else if ( shell == 'bmenu' ){
                m.appendChild(s);

                var bw = p.getElementsByClassName('hslider')[0];
                var kn = bw.getElementsByClassName('knob')[0];
                var sv = bw.parentElement.getElementsByClassName('slidervalue')[0];
                var rec = this.getElementsByClassName('border')[0];//document.getElementsByClassName('layeritem current')[0];
                //bw.value = rec.dataset.border || 0;

                var ma = Number(bw.dataset.max);
                var mi = Number(bw.dataset.min);

                var br = BORDERWIDTH; //Number(rec.dataset.border) || 0;

                sv.innerText = br;

                var z = (br / ma);
                var scale = ((24 * z) + 4) / 28;

                var lx = Math.max((bw.offsetWidth - 32) * z, 4);

                kn.style.left = lx + 'px';
                kn.style.transform = 'translateY(-50%) scale(' + scale +')';

                bw.dataset.x = lx;

                var bc = window.getComputedStyle(rec).borderColor;

                var chips = p.getElementsByClassName('chip');
                for(var i=0;i<chips.length;i++){
                    var cc = chips[i];
                    if ( bc == window.getComputedStyle(cc).backgroundColor ){
                        cc.parentElement.classList.add('current');
                        break;
                    }
                }

            } else if ( shell == 'bgmenu' ){
                m.appendChild(s);

                var rec = document.getElementsByClassName('layeritem current')[0];
                var bc = window.getComputedStyle(rec).backgroundColor;
                var chips = p.getElementsByClassName('chip');

                for(var i=0;i<chips.length;i++){
                    var cc = chips[i];
                    if ( bc == window.getComputedStyle(cc).backgroundColor ){
                        cc.parentElement.classList.add('current');
                        break;
                    }
                }
            } else if ( shell == 'textcolormenu' ){
                m.appendChild(s);

                var rec = document.getElementsByClassName('layeritem current')[0].getElementsByClassName('textarea')[0];
                var bc = window.getComputedStyle(rec).color;
                var chips = p.getElementsByClassName('chip');

                for(var i=0;i<chips.length;i++){
                    var cc = chips[i];
                    if ( bc == window.getComputedStyle(cc).backgroundColor ){
                        cc.parentElement.classList.add('current');
                        break;
                    }
                }
            } else if ( shell == 'fsmenu' ){
                var step = stepper2.call(this, e);
                step.classList.add('menud');
                
                m.appendChild(step);
            } else if ( shell == 'bgmenu2' || shell == 'bgmenu3' || shell == 'bcmenu' || shell == 'tcmenu' ){
                m.appendChild(s);

                var bc = window.getComputedStyle(this.getElementsByClassName('fill')[0]).backgroundColor;
                var chips = p.getElementsByClassName('chip');

                for(var i=0;i<chips.length;i++){
                    var cc = chips[i];
                    if ( bc == window.getComputedStyle(cc).backgroundColor ){
                        cc.parentElement.classList.add('current');
                        break;
                    }
                }
            } else if ( shell == 'cbmenu' ){
                m.appendChild(s);

                var bc = window.getComputedStyle(this.getElementsByClassName('border')[0]).borderColor;
                var chips = p.getElementsByClassName('chip');

                for(var i=0;i<chips.length;i++){
                    var cc = chips[i];
                    if ( bc == window.getComputedStyle(cc).backgroundColor ){
                        cc.parentElement.classList.add('current');
                        break;
                    }
                }
            } else if ( shell == 'tfmenu' ){
                var v = this.innerText;

                var op = p.getElementsByClassName('item');

                for(var i=0;i<op.length;i++){
                    var o = op[i];

                    if ( o.innerText == v ){
                        o.classList.add('current');
                    } else {
                        o.classList.remove('current');
                    }
                }

            } else if ( shell == 'umenu' ){
                var s = document.createElement('input');
                s.type = 'file';
                s.multiple = true;

                s.onchange = function(e) {
                    var files = e.target.files; // FileList object

                    // Loop through the FileList and render image files as thumbnails.
                    for (var i = 0, f; f = files[i]; i++) {
                        // Only process image files.
                        if (!f.type.match('image.*')) {
                            continue;
                        }

                        var reader = new FileReader();

                        var ss = s;

                        reader.onload = (function(file) {
                            return function(e) {
                                //file.name

                                var src = e.target.result;
                                var img = document.createElement('img');

                                img.className = 'layeritem rectangle';
                                

                                img.style.position = 'absolute';
                                img.style.zIndex = 1337;


                                var ops = document.getElementById('img_context').cloneNode(true);
                                var cid = 's' + Date.now() + '-' + Math.floor(Math.random()*1000);

                                ops.id = cid;
                                img.dataset.context = cid;
                                
                                img.id = cid + 'img';

                                img.draggable = false;
                                img.style.userSelect = 'none';
                                img.style.userDrag = 'none';

                                document.body.appendChild(ops); 

                                img.onload = function() {
                                    
                                    var w = this.width || this.naturalWidth;
                                    var h = this.height || this.naturalHeight;


                                    img.style.top = (window.innerHeight / 2) - (h/2) + 'px';
                                    img.style.left = (window.innerWidth / 2) - (w/2) + 'px';


                                    document.getElementById('layers').appendChild(img);

                                    document.getElementById('select_tool').click();

                                    ops.dataset.w = ops.offsetWidth;

                                    

                                    ss.remove();

                                    blurall();

                                    setcontextpanel.call(img);

                                    this.classList.add('current');

                                    setboundingbox.call(this);
                                };

                                img.src = src;
                            };
                        })(f);

                        // Read in the image file as a data URL.
                        reader.readAsDataURL(f);
                    }
                }

                document.body.appendChild(s);

                s.click();

                p.remove();

                return;
            }

            var xx = c.getElementsByClassName('option');

            var l = xx.length - 1;
            var o = xx[0];

            var ox = -(c.offsetWidth - xx[l].offsetWidth);

            var o2 = o.getparent('optionwrap');

            if ( o2 ){
                o = o2;
            }

            o.style.marginLeft = ox + 'px';

            //p.offsetLeft;

            p.style.top = y + 'px';
            p.style.left = x + (w/2) - (p.offsetWidth / 2) + 'px';
            p.style.left = x + 48 + 12 + 'px';
            p.style.left = x + 48 + 12 + 'px';//x + w + 12 + 'px';

            if ( swap ){
                p.style.left = x + w - m.offsetWidth - 48 - 12 + 'px';
            }

            //p.style.transform = 'translateX(0px)';

            var ph = p.offsetHeight;

            var st = window.pageYOffset || document.documentElement.scrollTop;
            //var sl = window.pageXOffset || document.documentElement.scrollLeft;

            var edge = window.innerHeight - y - ph + st;

            if ( edge < 16 ){
                // if ( edge > -16 ){
                //     edge = window.innerHeight - 16;
                // }

                


                p.style.top = y + edge - 16 + 'px';
            }

            p.offsetLeft;

            c.classList.add('sublevel')

            p.classList.add('visible');
            
            p.offsetLeft;

            p.style.transform = 'translateX(0px)';//'translateX(' + ox + 'px)';

            if ( shell == 'fsmenu'){
                var sc = step.dataset.scroll;
                step.getElementsByClassName('select')[0].scrollTop = sc;
            }
        }

        // function moremenu(e){
        //     console.log('MORE  MEUN----', e);


        //     var o = this.classList.contains('opened');
        //     if ( o ){
        //         return;
        //     }

        //     var c = this.getparent('contextpanel');
        //     var coff = c.offset();
        //     var x = coff.x;
        //     var y = coff.y;
        //     var w = coff.w;
        //     var h = coff.h;

        //     this.classList.add('opened');

        //     var p = document.createElement('div');
        //     var m = document.getElementById('moremenu');

        //     if ( c.classList.contains('options') ){
        //         m = document.getElementById('moremenu2');
        //     }

        //     p.className = 'menuwrap';
            
        //     m = m.cloneNode(true);

        //     m.removeAttribute('id');

        //     m.className = 'overflowmenu';
            
        //     //m.appendChild(backbtn());

        //     p.appendChild(m);
            
        //     // document.body.addEventListener('mousedown', closemenu);
        //     // document.body.addEventListener('touchstart', closemenu);
        //     // document.body.addEventListener('click', closemenu);

        //     document.body.addEventListener('mousedown', preclosemenu);
        //     document.body.addEventListener('touchstart', preclosemenu);

        //     document.body.appendChild(p);

        //     var o = c.getElementsByClassName('option');

        //     var l = o.length - 1;
        //     o = o[0];
            
        //     var o2 = o.getparent('optionwrap');

        //     if ( o2 ){
        //         o = o2;
        //     }

        //     var ox = -(c.offsetWidth - 48);
        //     o.style.marginLeft = ox + 'px';

        //     //p.offsetLeft;

        //     p.style.top = y + 'px';
        //     p.style.left = x + (w/2) - (p.offsetWidth / 2) + 'px';
        //     p.style.left = x + 48 + 12 + 'px';
        //     p.style.left = x + w + 12 + 'px';

        //     p.style.transform = 'translateX(0px)';

        //     var ph = p.offsetHeight;

        //     var edge = window.innerHeight - y - ph;

        //     if ( edge < 16 ){
        //         p.style.top = y + edge - 16 + 'px';
        //     }


        //     p.offsetLeft;

        //     c.classList.add('sublevel')

        //     p.classList.add('visible');
            
        //     p.offsetLeft;

        //     p.style.transform = 'translateX(' + ox + 'px)';

        // }

        function deletecurrent(e){
            console.log('delete');
            e.preventDefault();
            e.stopPropagation();
            var d = document.getElementsByClassName('layeritem current');

            while(d[0]){
                var a = d[0];
                var cid = a.dataset.context;
                var bs = a.bounds;
                a.remove();
                var b = document.getElementById(cid);
                b.remove();

                if ( bs ){
                    bs.remove();
                }
            }

            var m = document.getElementsByClassName('menuwrap');
            m.remove();
            
            document.body.click();

            hidekeyboard();
        }

        function shift(e){
            var k = this.getparent('keyboard');
            k.classList.toggle('uppercase');
        }

        function key(e){
            var v = this.innerText;
            var a = document.getElementsByClassName('textwrap current')[0];

            a = a.getElementsByClassName('textarea')[0];

            switch(v.toLowerCase()){
                case 'space':
                    v = ' ';
                    break;
                case 'del': 
                    a.value = a.value.slice(0, -1);
                    return;
                case 'shift' :
                    return;
                case 'return' :
                    v = '\r\n';
                    break;
                case '&123' :
                    return;
                default:
            }

            a.value += v;
            a.focus();

            autoexpand.call(a, e);
        }

        function shape_tool2(e){
            var o = document.getElementsByClassName('shapes_panel panel2');

            if ( o[0] ){
                o.remove();
                return;
            }
            
            var s = document.getElementById('shapes_panel').cloneNode(true);

            s.removeAttribute('id');

            s.classList.add('panel2');

            var off = this.offset();
            var x = off.x + 72;
            var y = off.y - 2;

            s.style.top = y + 'px';
            s.style.left = x  + 'px';

            document.body.appendChild(s);
            s.offsetLeft;
            s.style.opacity = 1;
        }


        function type_tool2(e){
            console.log('type_tool2')
            if ( !document.documentElement.classList.contains('insert') ){
                return;
            }
            blurelm.call(this);

            typetool.call(this, {pageX: (window.innerWidth / 2) - 200,pageY: window.innerHeight / 2, touches: null, target: document.body })
        }

        function minishape(e){
            e.preventDefault();
            e.stopPropagation();
            console.log('ms');
            var t = this.dataset.type;

            document.body.classList.remove('rectanglex', 'circlex');
            document.body.classList.add(t);

            console.log('shape_tool2');
            if ( document.documentElement.classList.contains('insert') ){
                blurelm.call(this);
                insertrect();
            }


            var p = document.getElementsByClassName('option shapetype')[0];
            p = p.getElementsByClassName('shapeicon')[0];

            p.className = 'shapeicon ' + (t == 'rectanglex' ? 'square' : 'circle');


            closepanel();
        }

        function bordercontext(e){
            console.log('bordercontext')
            var p = this.getparent('contextpanel');
            var c = p .getElementsByClassName('content')[0];

            var b = document.getElementById('border_panel').cloneNode(true);

            b.removeAttribute('id');

            b.classList.remove('panel');

            //c.appendChild(b);

        }

        function colorsetting(e, color, menu){
            console.log(color, menu);

            e.preventDefault();
            e.stopPropagation();


            if ( menu.classList.contains('bcmenu') ){

                var bf = document.getElementsByClassName('brushfill2');
                for(var i=0;i<bf.length;i++){
                    bf[i].style.backgroundColor = color;
                }
                //window.brushcolor = color;
                BRUSHCOLOR = color;
            } else if ( menu.classList.contains('tcmenu') ){
                //document.getElementsByClassName('textcoloractual')[0].backgroundColor = color;
                var b = document.getElementsByClassName('textcoloractual');
                for(var i=0;i<b.length;i++){
                    var a = b[i].getElementsByClassName('textfill')[0];
                    a.style.backgroundColor = color;
                }

                TEXTCOLOR = color;
            } else if ( menu.classList.contains('bgmenu2') ){
                var b = document.getElementById('shapefill');//getElementsByClassName('shape2fill');
                //for(var i=0;i<b.length;i++){
                    var a = b;//[i];//.getElementsByClassName('textfill')[0];
                    a.style.background = color;

                    if ( color == 'transparent' || !color || color == 'rgba(0, 0, 0, 0)' ){
                        a.style.background = 'linear-gradient(to right, var(--null) 3px, transparent 3px) 12.5px';
                        a.style.boxShadow = 'inset 0 0 0 3px var(--null)';
                        a.style.transform = 'rotate(45deg)';
                    } else {
                        a.style.boxShadow =  'none';
                        a.style.transform = 'rotate(0)';
                    }
                //}

                SHAPECOLOR = color;
            } else if ( menu.classList.contains('bmenu') ){
                var b = document.getElementsByClassName('shapeborderactual');
                for(var i=0;i<b.length;i++){
                    var a = b[i].getElementsByClassName('border')[0];
                    a.style.borderColor = color;

                    if ( color == 'transparent' || !color || color == 'rgba(0, 0, 0, 0)' ){
                        a.style.borderColor = 'rgba(155, 155, 155, 0.15)';
                    }
                }

                SHAPEBORDERCOLOR = color;
            } else if (menu.classList.contains('cbmenu') ){

                var b = document.getElementsByClassName('canvasborderactual');
                for(var i=0;i<b.length;i++){
                    var a = b[i].getElementsByClassName('border')[0];
                    a.style.borderColor = color;

                    if ( color == 'transparent' || !color || color == 'rgba(0, 0, 0, 0)' ){
                        a.style.borderColor = 'rgba(155, 155, 155, 0.15)';
                    }
                }

                CANVASBORDERCOLOR = color;

            } else if ( menu.classList.contains('bgmenu3') ){
                var a = document.getElementById('canvasfill');

                a.style.background = color;

                if ( color == 'transparent' || !color || color == 'rgba(0, 0, 0, 0)' ){
                    a.style.background = 'linear-gradient(to right, var(--null) 3px, transparent 3px) 12.5px';
                    a.style.boxShadow = 'inset 0 0 0 3px var(--null)';
                    a.style.transform = 'rotate(45deg)';
                } else {
                    a.style.boxShadow =  'none';
                    a.style.transform = 'rotate(0)';
                }

                CANVASCOLOR = color;
            } 
        }

        function colorswatch(e){
            console.log('COLOR');
            console.log(e);
            var m = this.getparent('contextmenu') || document.getElementsByClassName('menuwrap subsublevel')[0] || document.getElementsByClassName('menuwrap')[0];
            var o = m.getElementsByClassName('color current');

            o.removeclass('current');

            this.classList.add('current');

            var c = this.getElementsByClassName('chip')[0] || this;
            var a = window.getComputedStyle(c).backgroundColor;

            console.log(a);

            var l = document.getElementsByClassName('layeritem current')[0];
            var id = l ? l.dataset.context : null;

            if ( !id || m.classList.contains('toolmenu') ){
                colorsetting.call(this, e, a, m);

                return;
            }

            var fill = true;

            if ( l.classList.contains('rectangle')) {
                if ( m.classList.contains('bordermenu')){
                    l.style.borderColor = a;
                    fill= false;
                } else {
                    l.style.backgroundColor = a;
                }
            } else if ( l.classList.contains('textwrap')){
                l.getElementsByClassName('textarea')[0].style.color = a;
            }

            var p = document.getElementById(id);

            if ( fill ){
                var f = p.getElementsByClassName('fill')[0];

                f.style.background = a;
                f.style.boxShadow = 'none';
            } else {
                var f = p.getElementsByClassName('border')[0];

                f.style.background = 'transparent';
                f.style.boxShadow = 'none';
                f.style.border = '4px solid ' + a;
            }

            if ( a === 'transparent' || a === 'rgba(0, 0, 0, 0)' || a === 'rgba(0,0,0,0)' ){
                f.style.background = 'linear-gradient(to right, var(--null) 3px, transparent 3px) 12.5px';
                if ( fill ){
                    f.style.boxShadow = 'inset 0 0 0 3px var(--null)';
                } else {
                    f.style.border = '3px solid var(--null)';
                    f.style.backgroundPosition = '9.5px';
                }
                f.style.transform = 'rotate(45deg)';
            }

            //closemenu();
        }

        function closestepper(e){
            e.preventDefault();
            e.stopPropagation();

           document.body.removeEventListener('click', closestepper);


            var t = e.target;

            if ( t && t.classList.contains('selectitem')){
                var y = t.offsetTop;
                var p = t.getparent('select');

                //t.classList.add('current');

                p.scrollTop = y - 72;

                console.log(y);


            }

            var s = document.getElementsByClassName('stepper');
            setTimeout(function(){s.remove();}, 0);
        }

        function stepper(e){
            var o = this.offset();
            var x = o.x;
            var y = o.y;
            var w = o.w;
            var h = o.h;

            var v = this.dataset.value || 24;

            var d = document.createElement('div');
            // var s = document.getElementById('stepper_temp');
            // s = s.cloneNode(true);

            // s.removeAttribute('id');

            d.className = 'stepper';

            d.style.position = 'fixed';
            d.style.left = x + 'px';
            d.style.top = y - (188/2 - 24) + 'px';
            d.style.background = 'var(--panel)';
            d.style.height = 188 + 'px';
            d.style.width = w + 'px';
            d.style.zIndex = 99999999999999999999;
            d.style.borderRadius = 'var(--toolbarradius)';


            var nums = document.createElement('div');
            nums.className = 'select';
            var num = 6;
            var x = null;
            for(var i=0;i<48;i++){
                var a = document.createElement('div');
                num += 2;
                a.className = 'selectitem';
                a.dataset.value = num;
                a.appendChild(document.createTextNode(num));

                if ( num == v ){
                    a.className += ' current';
                    x = a;
                }

                nums.appendChild(a);
            }

            nums.onscroll = selectscroll;

            //d.appendChild(s);

            d.appendChild(nums);

            document.body.appendChild(d);

            document.body.addEventListener('click', closestepper);

            nums.scrollTop = x.offsetTop - (nums.offsetHeight / 2 - 24);
        }

        function stepclick(e){
            var y = this.offsetTop;
            var p = this.getparent('select');

            //t.classList.add('current');

            var oy = 72 + p.offsetTop;

            p.scrollTop = (y - oy);
        }

        function stepper2(e){
            var v = this.dataset.value || TEXTSIZE;

            var d = document.createElement('div');


            d.className = 'stepper';

            d.style.height = '188px';
            d.style.width = 'calc(100% + 24px)';
            d.style.margin = '-12px -12px -12px';

            var nums = document.createElement('div');
            nums.className = 'select';
            var num = 8;
            var x = null;
            var ii = 0;
            for(var i=0;i<45;i++){
                var a = document.createElement('div');
                num += 2;
                a.className = 'selectitem';
                a.dataset.value = num;
                a.onclick = stepclick;
                a.appendChild(document.createTextNode(num));

                if ( num == v ){
                    a.className += ' current';
                    x = a;
                    ii = i;
                }                

                nums.appendChild(a);
            }

            nums.onscroll = selectscroll;

            d.appendChild(nums);

            nums.scrollTop = d.dataset.scroll = (ii * 48) + d.offsetTop;

            return d;
        }

        function selectscroll(e){
            console.log(this, this.scrollTop);

            var s = this.scrollTop + (this.offsetHeight / 2);

            var c = this.getElementsByClassName('selectitem');
            var o = this.getElementsByClassName('selectitem current');
            o.removeclass('current');

            var n = null;

            for(var i=0;i<c.length;i++){
                var a = c[i];
                var y = a.offsetTop;

                if ( y <= s ){
                    n = a;
                } else {
                    break;
                }

            }

            n.classList.add('current');

            var tool = this.getparent('toolmenu');

            var con = tool ? document.getElementsByClassName('options contextpanel opened')[0] : document.getElementsByClassName('contextpanel visible')[0];
            var step = con.getElementsByClassName('stepped')[0] || con.getElementsByClassName('fontsize')[0];
            var lab = step.getElementsByClassName('label')[0];

            lab.innerText = step.dataset.value = n.dataset.value;

           

            if ( tool ){
                TEXTSIZE = Number(n.dataset.value);
            } else {
                 var li = document.getElementsByClassName('layeritem current')[0];

                 if ( li  ){
                    var ta = li.getElementsByClassName('textarea')[0];

                    if ( ta ){
                        ta.style.fontSize = n.dataset.value + 'px';

                        autoexpand.call(ta, e);
                    }
                }
            }


            console.log(s, n);
        }

        function borderwidth(e){
            var v = Number(this.dataset.value);

            var c = document.getElementsByClassName('layeritem current')[0];
            // var handles = c.getElementsByClassName('resizehandle');

            // handles[0].style.margin = -v + 'px 0 0 -' + v + 'px' ;
            // handles[1].style.margin = -v + 'px -' + v + 'px 0 0';
            // handles[2].style.margin = '0 0 -' + v + 'px  -' + v + 'px';
            // handles[3].style.margin = '0 -' + v + 'px -' + v + 'px 0';

            if ( c && !this.getparent('toolmenu') ){
                c.style.borderWidth = v + 'px';
                c.dataset.border = v;
            } else {
                BORDERWIDTH = v;
            }
        }

        function selectcolor(e){

            var m = this.getparent('menuwrap');
            var off = m.offset();

            m.classList.add('subsublevel');
            m.classList.remove('visible');

            var c = document.getElementById('huecube');
            c = c.cloneNode(true);

            c.removeAttribute('id');

            var p = document.createElement('div');
            p.className = 'menuwrap';

            c.className += ' contextmenu ';


            var cs = c.getElementsByClassName('huecubeslide')[0];

            var halo = c.getElementsByClassName('colorhalo')[0];


            var rec = document.getElementsByClassName('layeritem current')[0];

            var hue = 300;

            if ( rec && rec.classList.contains('rectangle') ){
                var bg = window.getComputedStyle(rec).backgroundColor;

                if ( this.getparent('bordermenu') ){
                    var bg = window.getComputedStyle(rec).borderColor;
                }

                var hsl = color2hsl(bg);
                hue = hsl[0];

                var hsv = hsl2hsv(hsl);

                var gr = halo.getparent('colorgrid');
                var gw = gr.offsetWidth || 344;
                var gh = gr.offsetHeight || 344;


                gr.dataset.h = hsl[0];
                gr.dataset.s = hsl[1];
                gr.dataset.l = hsl[2];

                console.log(hsv);

                var s = hsv[1] || 0;
                var v = hsv[2] || 0;

                var xx = (s) * gw;
                var yy = (1 - (v)) * gh;

                console.log(s, gw, gh, v);

                console.log(xx,yy);

                halo.style.transform = 'translate(' + (xx-10) + 'px,' + (yy-10) + 'px)';


                var cw = gr.getparent('cubewrap');
                var oc = cw.getElementsByClassName('oldcolor')[0];

                oc.style.background = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + hsl[2] +'%)';
            }

            if ( cs ){

                cs.value = hue;
                huecubeslide.call(cs, event);
            }

            p.appendChild(c);

            var y = off.y ;

            p.style.left = off.x + 'px';
            p.style.top = y + 'px';
            

            document.body.appendChild(p);


            var ph = p.offsetHeight;

            var edge = window.innerHeight - y - ph;

            if ( edge < 16 ){
                // if ( edge > -16 ){
                //     edge = window.innerHeight - 16;
                // }
                p.style.top = y + edge - 16 + 'px';
            }

            p.offsetLeft;
            p.classList.add('visible');
        }

        function cubehandler(e){
            e.preventDefault();

            if ( e.which == 3 ){
                return;
            }

            e = e.touches ? e.touches[0] : e;

            var sx = e.pageX;
            var sy = e.pageY;

            var totalOffsetX = 0;
            var totalOffsetY = 0;
            var currentElement = this;
            var scroll = 0;


            do {
                totalOffsetX += currentElement.offsetLeft;
                totalOffsetY += currentElement.offsetTop;
                scroll += currentElement.scrollTop;
            }
            while(currentElement = currentElement.offsetParent)


            var g = this;
            var h = this.getElementsByClassName('handle')[0];
            var c = g.parentElement.getElementsByClassName('thecolor')[0];
            var a = g.parentElement.getElementsByClassName('alpha')[0];
            var w = this.offsetWidth;
            var wrap = this.getparent('cubewrap') || this.getparent('colorpicker');
            var swatch = document.getElementsByClassName('bgswatch popped')[0];

            //var hx = Number(h.dataset.x) || 0;
            //var hy = Number(h.dataset.y) || 0;

            var hsize = h.offsetWidth / 2;

            var hx = -(totalOffsetX - sx + hsize);
            var hy = sy - totalOffsetY - hsize + scroll;

            h.style.transform = 'translate(' + hx + 'px,' + hy + 'px)';
            if ( swatch ){
              swatch.dataset.x = hx;
              swatch.dataset.y = hy;
            }

            var ss = Math.round(((hx + hsize) / w ) * 100);
            g.dataset.s = ss;

            var b = Math.round(((g.offsetHeight - Math.min(Math.max(hy+6,0), g.offsetHeight) )/ g.offsetHeight) * 100);

            var l = (2 - ss / 100) * b / 2; // Ligh. range 0-100
            var s2 = Math.round( b * ss / ( l < 50 ? l * 2 : 200 - l * 2 ));
            l = Math.round( l );

            g.dataset.s = s2;
            g.dataset.l = l;

            c.style.backgroundColor =  'hsla(' + g.dataset.hue + ', ' + s2 + '%, ' + l + '%, ' + g.dataset.alpha + ')';

            var hsl = 'hsla(' + g.dataset.hue + ', ' + g.dataset.s + '%, ' + g.dataset.l + '%, 1)';

            a.style.backgroundImage = 'linear-gradient(to left, ' + hsl + ', transparent), url(./imgs/alpha.png)';

            setcubevalues.call(wrap, [g.dataset.hue, g.dataset.s, g.dataset.l, g.dataset.alpha]);

            if ( swatch ){
              swatch.style.background = 'hsl(' + g.dataset.hue + ', ' + s2 + '%, ' + l + '%)';
            }

            //setcolorvalues.call(c);

            if ( ss  < 15 && b > 85 ){
                h.style.borderColor = '#707070';
            } else  {
                h.style.borderColor = 'white';
            }

            h.style.backgroundColor = hsl;

            if ( document.body.classList.contains('brush_tool') ){
                BRUSHCOLOR = hsl;

                document.getElementById('brushfill2').style.background = hsl;
            }

            function move(e){
                e = e.touches ? e.touches[0] : e;
                var x = e.pageX;
                var y = e.pageY;

                //var dx = sx - x;
                //var dy = sy - y;

                var dx = -(totalOffsetX - x + hsize);
                var dy = y - totalOffsetY - hsize + scroll;

                console.log(dx);
                console.log(dy);

                dx = Math.min(Math.max( dx, -hsize), g.offsetWidth - hsize);
                dy = Math.min(Math.max( dy, -hsize), g.offsetHeight - hsize);

                h.style.transform = 'translate(' + dx + 'px,' + dy + 'px)';

                if ( swatch ){
                  swatch.dataset.x = dx;
                  swatch.dataset.y = dy;
                }

                //h.dataset.x = dx;
                //h.dataset.y = dy;


                var s = Math.round(((dx + hsize) / w ) * 100);
                console.log(s + ' SS');
                //g.dataset.s = s;

                var b2 = Math.round(((g.offsetHeight - Math.min(Math.max(dy +  hsize, 0), g.offsetHeight) )/ g.offsetHeight) * 100);


                var l2 = (2 - s / 100) * b2 / 2; // Ligh. range 0-100
                var s3 = Math.round( s * s / ( l2 < 50 ? l2 * 2 : 200 - l2 * 2 ));

                var s3 =  Math.round((b2 * s) / (l2 < 50 ? l2 * 2 : 200 - l2 * 2));
                l2 = Math.round( l2 );

                if (isNaN(s3)) {
                    s3 = 0;
                }

                g.dataset.s = s3;
                g.dataset.l = l2;

                c.style.backgroundColor =  'hsla(' + g.dataset.hue + ', ' + s3 + '%, ' + l2 + '%, ' + g.dataset.alpha + ')';

                var hsl = 'hsla(' + g.dataset.hue + ', ' + g.dataset.s + '%, ' + g.dataset.l + '%, 1)';

                a.style.backgroundImage = 'linear-gradient(to left, ' + hsl + ', transparent), url(./imgs/alpha.png)';

                //setcolorvalues.call(c);
                setcubevalues.call(wrap, [g.dataset.hue, g.dataset.s, g.dataset.l, g.dataset.alpha]);

                if ( s < 15 && b2 > 85 ){
                    h.style.borderColor = '#707070';
                } else  {
                    h.style.borderColor = 'white';
                }

                h.style.backgroundColor = hsl;


                console.log(hsl2hsv([Number(g.dataset.hue), s3, l2]));


                console.log(hsl);


                //  @todo brush color

                if ( document.body.classList.contains('brush_tool') ){
                    BRUSHCOLOR = hsl;

                    document.getElementById('brushfill2').style.background = hsl;
                }
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                e.preventDefault();
                e.stopPropagation();
            }

            window.addEventListener('touchmove', move);
            window.addEventListener('touchend', end);

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        // function hsl2hsv(hsl){

        //     var h = Number(hsl[0]);
        //     var s = Number(hsl[1]);
        //     var l = Number(hsl[2]);

        //     s = s / 100 || 0;
        //     l = l / 100 || 0;

        //     console.log(h, s, l, 'HSL');

        //     var ll = l * 2;
        //     var ss = ll <= 1 ? ll : 2 - ll;
        //     var v = (ll + ss ) / 2;
        //     s = (2 * ss) / ( ll + ss);

            
        //     console.log(h, s, v, 'HSV');

        //     return [h, s * 100, v * 100];
        // }

        function hsl2hsv(hsl){
            var h = Number(hsl[0]);
            var s = Number(hsl[1]);
            var l = Number(hsl[2]);

            s = s / 100 || 0;
            l = l / 100 || 0;

            var sat = s;
            sat *= l < .5 ? l : 1 - l;

            return [ h, (2 * sat / (l + sat)) || 0, (l + sat) || 0 ];
        }

        function color2hsl(x){
            if ( x.indexOf('rgb') >= 0 ){
                x = x.replace('rgb(', '').replace('rgba(', '').replace(')', '');
                x = x.split(',');

                var hsl = rgb2hsl(x);

                return hsl;
            } else if ( x.indexOf('#') >= 0 ){
                var rgb = hex2rgb(x);
                var hsl = rgb2hsl(rgb);

                return hsl;
            }
        }

        function hexinput(e){
          var v = this.value;
          if ( v.length < 6 ){
            return;
          }
          var rgb = hex2rgb(v);
          if ( !rgb ){
            return;
          }
          var p = this.getparent('colorwrap2') || this.getparent('colorpicker');
          var rs = p.getElementsByClassName('redslide')[0];
          var gs = p.getElementsByClassName('greenslide')[0];
          var bs = p.getElementsByClassName('blueslide')[0];

          if ( !rs ){
            rs = p.getElementsByClassName('redinput')[0];
            gs = p.getElementsByClassName('greeninput')[0];
            bs = p.getElementsByClassName('blueinput')[0];

            var hc = p.getElementsByClassName('huecubeslide')[0];
            var ch = p.getElementsByClassName('handle colorhalo')[0];

            if ( !rs ){
              return;
            }

            rs.value = rgb.r;
            gs.value = rgb.g;
            bs.value = rgb.b;

            var hsl = rgb2hsl(rgb.r,rgb.g,rgb.b);
            hc.value = hsl[0] * 360;

            var x = hsl[1] * 208 - 8;
            var y = (208 - (hsl[2] * 208)) - 8;
            ch.style.transform = 'translate(' + x + 'px,' + y + 'px)';

            ch.style.backgroundColor = '#' + v;

            return;
          }

          rs.value = rgb.r;
          gs.value = rgb.g;
          bs.value = rgb.b;

          //rgbslide.call(rs, e);
        }

        function alphainput(e){
          var v = this.value;
          var p = this.getparent('colorwrap2');
          var a = p.getElementsByClassName('alphaslide')[0];
          a.value = v;

          //rgbslide.call(a, e);
        }

        function setcubevalues(hsla){
          var ri = this.getElementsByClassName('redinput')[0];
          var gi = this.getElementsByClassName('greeninput')[0];
          var bi = this.getElementsByClassName('blueinput')[0];
          var hi = this.getElementsByClassName('hexinput')[0];

          var sw = document.getElementsByClassName('bgswatch popped')[0];

          var rgb = hsl2rgb(hsla);
          var hex = rgb2hex(rgb);


          ri.value = rgb[0];
          gi.value = rgb[1];
          bi.value = rgb[2];

          hi.value = hex;

          var h = hsla[0];
          var s = hsla[1];
          var l = hsla[2];
          var a = hsla[3] || 100;

          if ( a <= 1){
            a *= 100;
          }

          if ( sw ){
            sw.style.backgroundColor = 'rgba(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ',' + (a/100) +')';
            console.log(a);
            hi.value = hex.replace('#', '');
          }

          var f = document.getElementsByClassName('layeritem current')[0];

          var cx = document.getElementsByClassName('menuwrap subsublevel');
          cx = cx[cx.length-1];

          var me = cx.getElementsByClassName('contextmenu')[0].className;

          me = me.replace('contextmenu', '').trim();


          if ( f  ){
            if ( me == 'bordermenu' ){
                var sw = document.getElementsByClassName('contextpanel visible')[0];
                sw = sw.getElementsByClassName('border')[0];

              f.style.borderColor = sw.style.borderColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (a/100) + ')';
              sw.style.background = 'transparent';
            } else if ( me == 'bgmenu'){
                var sw = document.getElementsByClassName('contextpanel visible')[0];
                sw = sw.getElementsByClassName('fill')[0];

                f.style.backgroundColor = sw.style.backgroundColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (a/100) + ')';
            } else if ( me == 'textcolormenu'){
                var sw = document.getElementsByClassName('contextpanel visible')[0];
                sw = sw.getElementsByClassName('textfill')[0];
                f = f.getElementsByClassName('textarea')[0];
                f.style.color = sw.style.backgroundColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (a/100) + ')';


            }
          }
        }

        function huecubeslide(e){
          console.log(this.value);
          var v = this.value;
          var p = this.getparent('cubewrap') || this.getparent('colorpicker');
          var c = p.getElementsByClassName('colorgrid')[0];
          var h = c.getElementsByClassName('handle')[0];
          var a = p.getElementsByClassName('alpha')[0];
          var a2 = p.getElementsByClassName('alpha2')[0];
          var n = p.getElementsByClassName('thecolor')[0];
          // var f = document.getElementsByClassName('rectangle focused')[0];
          var av = a2.value;

          var s = c.dataset.s || 100;
          var l = c.dataset.l || 50;
          c.dataset.hue = v;
          c.style.backgroundColor =  'hsla(' + v + ', 100%, 50%, 1)';

          h.style.backgroundColor = 'hsla(' + v + ', ' + s + '%, ' + l + '%, 1)';

          n.style.backgroundColor = 'hsla(' + v + ', ' + s + '%, ' + l + '%, ' + (av/100) + ')';

          var hsla = 'hsla(' + v + ', ' + s + '%, ' + l + '%, ' + (av/100) + ')';

          // if ( f ){
          //   f.style.backgroundColor = 'hsla(' + v + ', ' + s + '%, ' + l + '%, ' + (av/100) + ')';
          // }

          a.style.backgroundImage = 'linear-gradient(to left, hsla(' + v + ', ' + s + '%, ' + l + '%, 1), transparent), url(./imgs/alpha.png)';

          var id = 'ugh' + Date.now();
          this.id = id;
          var omg = 'html #' + id + '::-webkit-slider-thumb {background:hsla(' + v + ', 100%, 50%, 1) !important;}';

          var sty = document.head.getElementsByClassName('sliderstyle3');

          while(sty[0]){
            sty[0].parentNode.removeChild(sty[0]);
          }

          sty = document.createElement('style');
          sty.innerHTML = omg;
          sty.className = 'sliderstyle3';
          document.head.appendChild(sty);

          setcubevalues.call(p, [v, s, l, av]);

          if ( document.body.classList.contains('brush_tool') ){
                BRUSHCOLOR = hsla;

                document.getElementById('brushfill2').style.background = hsla;
            }
        }

        function rgb2hex(rgb) {
            var r = rgb[0];
            var g = rgb[1];
            var b = rgb[2];
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function alphacubeslide(e){
          var v = this.value;
          var p = this.getparent('cubewrap') || this.getparent('colorpicker');
          var c = p.getElementsByClassName('colorgrid')[0];
          var n = p.getElementsByClassName('thecolor')[0];
          var ai = p.getElementsByClassName('alphainput')[0];

          var h = c.dataset.h || c.dataset.hue || 260;
          var s = c.dataset.s || 100;
          var l = c.dataset.l || 50;

          c.dataset.alpha = (v/100);

          n.style.backgroundColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (v/100) + ')';

          ai.value = v;

          var f = document.getElementsByClassName('rectangle focused')[0];



          var sw = document.getElementsByClassName('bgswatch popped')[0];
          var bord = sw ? sw.classList.contains('borderswatch') : false;

          if ( f ){
            if ( !bord ){
              f.style.backgroundColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (v/100) + ')';
            } else {
              f.style.borderColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (v/100) + ')';
            }
          }

          if ( sw ){
            sw.style.backgroundColor = 'hsla(' + h + ', ' + s + '%, ' + l + '%, ' + (v/100) + ')';
          }
        }

        function addswatch(e){
            var b = this.getparent('cubewrap');
            var hex = b.getElementsByClassName('hexinput')[0].value;

            console.log(hex);

            var c = document.getElementsByClassName('colors');

            for(var i=0;i<c.length;i++){

                var w = document.createElement('div');
                var p = document.createElement('div');

                w.className = 'color';

                if ( c[i].getparent('menuwrap')){
                    w.classList.add('current');
                }

                p.className = 'chip';
                p.style.backgroundColor = hex;

                w.appendChild(p);

                var o = c[i].getElementsByClassName('color current');
                o.removeclass('current');

                c[i].appendChild(w);

                //p.click();
            }

            closemenu();
        }

        function menuitem(e){
            closemenu.call(document.body, {});
        }

        function tweakstate(e){
            document.body.classList.toggle('hidetweak');
        }


        Attach.on('touchstart', '.colorwheel', spin);
        Attach.on('mousedown', '.colorwheel', spin);

        Attach.on('touchstart', '.handle', handlehandler);
        Attach.on('mousedown', '.handle', handlehandler);

        Attach.on('touchstart', '#toolbar', handlehandler);
        Attach.on('mousedown', '#toolbar', handlehandler);

        Attach.on('click', '.toolbtn', toolhandler);

        Attach.on('click', '#hide', tweakstate);


        Attach.on('click', '.control', panelhandler);

        Attach.on('click', '.contextpanel .option', panelhandler);

        Attach.on('click', '.stepped', stepper);

        Attach.on('click', '.item', listhandler);

        Attach.on('touchstart', '.panel', swipehandler);
        Attach.on('mousedown', '.panel', swipehandler);

        Attach.on('change', '.tweakr', tweak);

        Attach.on('mousedown', '.slider', sliderhandler);
        Attach.on('touchstart', '.slider', sliderhandler);

        Attach.on('click', '.swatch', swatchhandler);

        Attach.on('click', '.type_tool', typetool);

        //Attach.on('click', '.textarea', texthandler);

        Attach.on('mousedown', '.textwrap', texthandler);
        Attach.on('touchstart', '.textwrap', texthandler);

        Attach.on('mousedown', '.rectangle_tool', rectanglex);
        Attach.on('touchstart', '.rectangle_tool', rectanglex);

        Attach.on('mousedown', '.canvas_tool', rectanglex);
        Attach.on('touchstart', '.canvas_tool', rectanglex);

        Attach.on('mousedown', '.draggable', draggable);
        Attach.on('touchstart', '.draggable', draggable);

        Attach.on('mousedown', '.bhandle', bhandle);
        Attach.on('touchstart', '.bhandle', bhandle);

        Attach.on('mousedown', '.resizehandle', rectangleresize);
        Attach.on('touchstart', '.resizehandle', rectangleresize);
        
        Attach.on('mousedown', '.rectangle', rectanglemove);
        Attach.on('touchstart', '.rectangle', rectanglemove);

        //Attach.on('click', '.rectangle', ffocus);

        Attach.on('click', '.shapeup', shapez);
        Attach.on('click', '.shapeback', shapez);

        Attach.on('click', '.delete', deletecurrent);

        // Attach.on('click', '.morebtn', moremenu);

        Attach.on('click', '.fillcolor, .textcolor, .shapeborder, .fontsize, .typeface, .shapecoloractual, .shapeborderactual, .textcoloractual, .brushcoloractual, .brushsizeactual, .shapetype, .canvasborderactual, .canvasfillactual, .morebtn, .marqueeselect, .uploadfileactual, .importfileactual', colormenu);

        Attach.on('mousedown', '.select_tool', marquee);
        Attach.on('touchstart', '.select_tool', marquee);

        Attach.on('click' , '.shift', shift);

        Attach.on('click' , '.key', key);

        //Attach.on('click', '#shape_tool2', shape_tool2);
        Attach.on('click', '#type_tool2', type_tool2);

        Attach.on('click', '.minishape', minishape);

        //Attach.on('click', '.shapeborder', bordercontext);

        Attach.on('click', '.color', colorswatch);

        Attach.on('click', '.selectcolor', selectcolor);

        Attach.on('mousedown', '.colorgrid', cubehandler);
        Attach.on('touchstart', '.colorgrid', cubehandler);

        Attach.on('input', '.huecubeslide', huecubeslide);

        Attach.on('click', '.addswatch', addswatch);
        Attach.on('click', '.mitem', menuitem);

        Attach.on('click', '.showkeyboard', keyboardshowhide);


        //document.addEventListener('mousewheel', mousescroll, { passive:false });

        //Attach.on('mousedown', '.contextpanel', stopprop, true);

        canvassetup();

        window.onresize = resize;

        function resize(){
            screenrez();
            resize2();
        }

        window.addEventListener('mousedown', function(e){
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);


        document.body.addEventListener('mousedown', function(e){
            var t = e.target;
            if ( t == document.body || t.id == 'canvas2' ){
                document.body.addEventListener('mouseup', blurup);
            }
        });

        document.body.addEventListener('touchstart', function(e){
            var t = e.target;
            if ( t == document.body || t.id == 'canvas2' ){
                document.body.addEventListener('touchend', blurup);
            }
        });

        function blurup(e){
            var t = e.target;

            if ( t == document.body || t.id == 'canvas2' ){
                // var f = document.getElementsByClassName('current');
                // f.removeclass('current');

                blurelm.call(this,e);

                // var p = document.getElementsByClassName('contextpanel visible');
                // p.removeclass('visible');
            }

            document.body.removeEventListener('mouseup', blurup);
            document.body.removeEventListener('touchend', blurup);
        }

        function screenrez(){
            var r = document.getElementsByClassName('rez');
            var d = document.createElement('div');
            d.appendChild(document.createTextNode('Screen: ' + screen.width + ' x ' + screen.height + '\r\n Window: ' + window.innerWidth + ' x ' + window.innerHeight));
            

            d.className = 'rez';

            d.style.position = 'fixed';
            d.style.bottom = '8px';
            d.style.right = '208px';
            d.style.zIndex = 1337;
            d.style.background = 'rgba(255,255,255,.1)';
            d.style.color = '#fff';
            d.style.borderRadius = '4px';//'var(--toolbarradius)';
            d.style.whiteSpace = 'pre-line';
            d.style.padding = '4px 8px';
            d.style.fontSize = '12px';
            d.style.pointerEvents = 'none';

            r.remove();

            document.body.appendChild(d);
        }

        function gridtweak(e){
            var v = this.value;

            GRIDSIZE = v;

            var dotgrid2 = GRIDSIZE * DELTASCALE;

            var n = 'tweaked_dotgrid';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --dotgrid: ' + dotgrid2 + 'px; --grid: ' + dotgrid2 + 'px;}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);


            var p = this.getparent('tweak');
            if ( !p ){
                return;
            }
            var l = p.getElementsByClassName('value')[0];

            l.empty();
            l.appendChild(document.createTextNode(v));
        }

        function dotspacing(e){
            
            // if ( e.target.getparent('tweaks') || e.target.getparent('contextmenu') || ( !document.documentElement.classList.contains('dotgrid') && !document.documentElement.classList.contains('grid') ) ){
            //     return;
            // }

            if ( !e.ctrlKey && !e.metaKey ){
                return;
            }

            e.preventDefault();


            var l = document.getElementById('layers');
            var d = document.getElementById('canvas2');
            var ls = LAYERSCALE;

            console.log(e.deltaY);

            var delta = 1;
            var ds = 0.01;

            if ( e.deltaY < 0 ){
                delta = -1;
            }

            if (e.deltaY % 1 != 0){
                delta = delta * -1;
            }

            console.log(e);

            if ( DELTASCALE <= 0.01 ){ //|| delta < 0 && DELTASCALE == 0.01 
                ds = 0.0005 ;
            } else if ( DELTASCALE >= 2 ){
                ds = 0.1;
            }

            DELTASCALE = Math.max(DELTASCALE + (delta * ds), ds);

            //dotgrid2 += delta;
            var dotgrid2 = GRIDSIZE * DELTASCALE;

            dotgrid2 = Math.max(dotgrid2, 0.1);

            // if ( LAYERSCALE === 1 ){
            //     l.style.transformOrigin = d.style.transformOrigin = e.pageX + 'px ' + e.pageY + 'px';
            //     document.body.style.backgroundPosition = (e.pageX - 48) + 'px ' + (e.pageY - 48) + 'px';
            // }


            LAYERSCALE = ls = Math.max(ls + (delta * ds), ds);

            l.style.transform = d.style.transform = 'scale(' + ls + ')';


            setboundingposition();
            setcontextpanel.call(document.getElementsByClassName('layeritem current')[0]);
            

            var n = 'tweaked_dotgrid';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --dotgrid: ' + dotgrid2 + 'px; --grid: ' + dotgrid2 + 'px;}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);


            if ( LAYERSCALE !== 1 ){
                var zt = document.getElementsByClassName('zoomtoast');
                
                if ( zt ){
                    zt.remove();
                }
                
                var t = document.createElement('div');
                var d = document.createElement('div');
                var z = document.createElement('div');

                t.className = 'toast zoomtoast';
                d.className = 'dismiss resetzoom';
                z.className = 'zoom message tnum';

                d.onclick = resetzoom;

                var scale = 100 * LAYERSCALE;

                scale = Math.round(scale*100)/100;

                z.appendChild(document.createTextNode(scale + '%'));
                d.appendChild(document.createTextNode('Reset'));


                t.appendChild(z);
                t.appendChild(d);

                document.body.appendChild(t);
            }

        }

        function resetzoom(e){
            LAYERSCALE = DELTASCALE = 1;
            gridtweak.call({value : GRIDSIZE}, e);

            var l = document.getElementById('layers');
            var d = document.getElementById('canvas2');

            l.style.transform = d.style.transform = 'scale(1)';

            l.style.transformOrigin = d.style.transformOrigin = 'center';
            document.body.style.backgroundPosition = 'center';

            setboundingposition();
            setcontextpanel.call(document.getElementsByClassName('layeritem current')[0]);

            var zt = document.getElementsByClassName('zoomtoast');
            if ( zt ){
                zt.remove();
            }
        }

        window.addEventListener('mousewheel', dotspacing, {passive:false});


        // var hammertime = new Hammer(document.body, {});
        // hammertime.on('pan', function(ev) {
        //     console.log(ev);
        // });

   
        //var canvas = document.getElementById('canvas2');

        //var canvas2 = new fabric.Canvas('canvas2');

        // canvas2.on('mouse:wheel', function(opt) {
        //     var delta = opt.e.deltaY;
        //     var zoom = canvas2.getZoom();
        //     zoom = zoom + delta/200;
        //     if (zoom > 20) zoom = 20;
        //     if (zoom < 0.01) zoom = 0.01;
        //     canvas2.setZoom(zoom);
        //     opt.e.preventDefault();
        //     opt.e.stopPropagation();
        // })

        function zoomtest(e) {
            e.preventDefault();
            console.log(e.scale, 'SCALE', e.type);
        }

        document.addEventListener('gesturestart', zoomtest);
        document.addEventListener('gesturechange', zoomtest);
        document.addEventListener('gestureend', zoomtest);


        if ( location.href.indexOf('localhost') < 0 && location.hash != '#debug' ){
            console.log = function(){};
        }

        screenrez();




        window.scrollTo(200,200);

        
    </script>
    <!-- <script src="./fabric.js"></script> -->
</body>
</html>
