<!--

        ,----,                                                           
      ,/   .`|                                                           
    ,`   .'  :                    ,--,                                   
  ;    ;     /                  ,--.'|     ,---,                         
.'___,/    ,'  ,---.     ,---.  |  | :   ,---.'|                 __  ,-. 
|    :     |  '   ,'\   '   ,'\ :  : '   |   | :               ,' ,'/ /| 
;    |.';  ; /   /   | /   /   ||  ' |   :   : :      ,--.--.  '  | |' | 
`----'  |  |.   ; ,. :.   ; ,. :'  | |   :     |,-.  /       \ |  |   ,' 
    '   :  ;'   | |: :'   | |: :|  | :   |   : '  | .--.  .-. |'  :  /   
    |   |  ''   | .; :'   | .; :'  : |__ |   |  / :  \__\/: . .|  | '    
    '   :  ||   :    ||   :    ||  | '.'|'   : |: |  ," .--.; |;  : |    
    ;   |.'  \   \  /  \   \  / ;  :    ;|   | '/ : /  /  ,.  ||  , ;    
    '---'     `----'    `----'  |  ,   / |   :    |;  :   .'   \---'     
                                 ---`-'  /    \  / |  ,     .-./         
                                         `-'----'   `--`---'             
                                                                         
@johnny.hunter

-->
<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <meta name="google" content="notranslate"><!-- WTF chrome, it's not in german -->
    <meta http-equiv="Content-Language" content="en">
    <title>TEST</title>
    <link rel="icon" type="image/png" href="./favicon.png" />
    <script src="../js/gator.js"></script>
    <script src="../js/hammer.js"></script>
    <script src="../js/base.js"></script>
    <script src="./draw.js"></script>
    <script src="./shapes.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,500,500i,600,600i,700,700i,800" rel="stylesheet">
    <style>
        /*@font-face {
            font-family: '';
            font-weight: 200;
            src: url("./fonts/woff/.woff") format("woff");
        }*/

        :root {
            --canvas:#323440;
            --tool: #282931;
            --toolhover: #1e1f25;
            --toolpress: #1B1B1C;
            --toolselect: #1B1B1C;
            --icon:#bbb;
            --iconcurrent:#fff;
            --color:#fff;
            --incolor:#000;
            --ui:27, 26, 28;
            --shadow:rgba(var(--ui), .16);
            --shadow2:rgba(var(--ui), .4);
            --panel: rgb(var(--ui));
            --select: #00CEFF;

            --toolbtn: 60px;
            /* --toolbtnicon: 32px; */
            --toolgap: 12px;
            --toolradius: 50%;
            --toolicons: 52%;

            --toolbarradius: 12px;

            --hover:rgba(255, 255, 255, 0.025);
            --active:rgba(255, 255, 255, 0.05);

            --handlegap: -4px;
            --handlecolor: var(--select);
            --handlesize: 8px;

            --dotgrid: 48px;
            --dotsize: 1px;
            --dotcolor: rgba(255, 255, 255, 0.1);
            --gridcolor: rgba(255, 255, 255, 0.025);

            --dotcolor2: rgba(255, 255, 255, 0.35);
            --gridcolor2: rgba(255, 255, 255, 0.05);

            --panelicons: var(--icon); /* rgba(255, 255, 255, 0.85) */

            --toolselect2: #0f0f10;

            --null: rgb(66,66,66);
        }

        .light {
            --canvas:#f2f2f2;
            --tool: #fafafa;
            --toolhover: #fdfdfd;
            --toolpress: #fff;
            --toolselect: #fff;
            --icon:#777;
            --iconcurrent:#000;
            --color:#000;
            --incolor:#fff;

            --panel: #fafafa;

            --shadow:rgba(var(--ui), .08);
            --shadow2:rgba(var(--ui), .15);

            --dotcolor: rgba(0, 0, 0, 0.15);
            --gridcolor: rgba(0, 0, 0, 0.025);

            --dotcolor2: rgba(0, 0, 0, 0.35);
            --gridcolor2: rgba(0, 0, 0, 0.05);

            --toolselect2: #ddd;
        }

        .darkgrid {
            --dotcolor: rgba(0, 0, 0, 0.15);
            --gridcolor: rgba(0, 0, 0, 0.04);
        }

        * {margin:0;padding:0;-webkit-overflow-scrolling: touch;-ms-overflow-style: -ms-autohiding-scrollbar;outline:none;-webkit-tap-highlight-color: transparent;-webkit-touch-callout: none;}
        html, body {height:100%;}
        html {background:var(--canvas);cursor:pointer;}
        html, input, textarea, button {font-family:Barlow, sans-serif;color:var(--color);}

        body {cursor:pointer;}

        body.rectangle_tool, body.select_tool {cursor:crosshair;}

        ::-webkit-scrollbar {width:0;height:0;}
        ::-webkit-scrollbar-thumb {}

        input {border:none;border-bottom:2px solid var(--color);line-height:36px;font-size:18px;background:transparent;color:var(--color);padding:0 8px;font-weight:600;box-sizing:border-box;border-radius:0;}
            input[type=text], input[type=number] {display:block;width:100%;}

        button {background:transparent;color:var(--color);font-size:18px;font-weight:600;border:none;padding:4px 12px;border-radius:4px;}
            button.selected {background:var(--color);color:var(--incolor);}

        .buttons button {margin-right:20px;}

        #toolbar {position:fixed;top:50%;left:64px;margin-top:-252px;user-select:none;z-index:999999999999990;pointer-events:none;}

            .tools {transition:transform 150ms ease-in-out;}
            #toolbar.swap .tools {transform: translateX(calc(-100% - 60px));}

            .tool {width:var(--toolbtn);height:var(--toolbtn);margin-bottom:var(--toolgap);position:relative;transition:all 150ms ease-in-out;pointer-events:all;}
                .tool:last-child {margin-bottom:0;}
                .horizontal .tool:last-child {margin-right:0;}

                .horizontal .tool {float:left;margin-right:var(--toolgap);margin-bottom:0;}

                .toolbtn {width:100%;height:100%;background:var(--tool);transition:all 150ms ease-in-out;border-radius:var(--toolradius);box-shadow:0 2px 20px var(--shadow);cursor:pointer;position:relative;z-index:1337;}
                    .toolbtn:hover {background:var(--toolhover);}
                    .toolbtn:active {background:var(--toolselect);}

                .tool.active .toolbtn {background:var(--toolselect);box-shadow:0 2px 20px var(--shadow2);}

                .toolbtn svg {max-width:var(--toolicons);display:block;position:absolute;z-index:1337;top:50%;left:50%;transform:translate(-50%, -50%);}
                    .toolbtn svg * {fill:var(--icon);}
                    .active .toolbtn svg * {fill:var(--iconcurrent);}

                .options {height:40px;background:var(--tool);border-radius:0 20px 20px 0;width:calc(var(--toolbtn) - 20px);position:absolute;top:calc(50% - 20px);left:20px;overflow:hidden;opacity:0;pointer-events:none;transition:all 150ms ease-in-out;box-shadow:0 2px 20px rgba(0,0,0,0);}
                    .active .options {background:var(--toolselect);opacity:1;pointer-events:all;box-shadow:0 2px 20px var(--shadow2);}

                .toggled .options {width:348px;}

                .controls {padding-left:48px;}
                        .control {float:left;margin-right:24px;line-height:40px;cursor: pointer;}
                        .control .label {font-size:10px;text-transform:uppercase;color:#888;float:left;margin-right:12px;}
                        .control .option {float:left;}


                .panel {position:fixed;background:var(--toolselect);border-radius:20px;box-shadow:0 2px 20px var(--shadow2);transition:all 150ms ease-in-out;overflow:hidden;user-select:none;z-index:999999999999991;transform:translateY(6px);touch-action: manipulation;}

                    .slide {width:100%;height:316px;position:absolute;top:0;left:0;transition:all 150ms ease-in-out;}
                        .slide:nth-child(2) {left:-100%;}

                .list {height:300px;overflow-y:auto;padding:8px 0;margin:0 8px;border-bottom:1px solid rgba(255, 255, 255, 0.08);}
                    .item {line-height:48px;font-size:24px;padding:0 16px;border-radius:12px;font-weight:bold;user-select:none;cursor:pointer;transition:all 150ms ease-in-out;}
                        .item:hover {background:rgba(255, 255, 255, 0.06);}
                        .item:active {background:rgba(255, 255, 255, 0.1);}
                    .item.current {background:var(--color);color:var(--incolor);}
                       

                .row {padding:0 0 8px 24px;display:flex;}
                    .row:first-child {margin-top:24px;}

                .input {width:100%;margin-right:24px;}
                    .input .label {text-transform:uppercase;color:grey;font-size:12px;font-weight:800;letter-spacing:1px;padding:8px 8px;}

                .page {position:absolute;bottom:0;left:50%;transform:translateX(-50%);}
                .dot {width:48px;height:48px;position:relative;display: inline-block;float:left;border-radius:50%;cursor: pointer;}
                    .dot::after {content:'';width:8px;height:8px;border:2px solid white;position:absolute;top:calc(50% - 6px);left:calc(50% - 6px);border-radius:50%;}
                    .dot.current::after {background:white;}

            .handle {pointer-events: all !important;width:48px;height:48px;position:absolute;left:-48px;top:calc(50% - 24px);border-radius:50%;cursor:pointer;}
                .fakehandle {position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:28px;height:28px;background:var(--toolselect);border-radius:50%;box-shadow:0 2px 20px var(--shadow2);}
                    .fakehandle svg {width:16px;height:28px;display:block;margin:0 auto;}
                        .fakehandle svg * {fill:var(--icon);}
                    .fakehandle .open {display:none;}
                    .minimized .fakehandle .close {display:none;}
                    .minimized .fakehandle .open {display:block;}

                .ui2 .fakehandle, .ui3 .fakehandle {box-shadow:none;}

        #toolbar.minimized {pointer-events:none;}
        .ui2 #toolbar.minimized, .ui3 #toolbar.minimized {width:48px;height:48px;overflow:hidden;border-radius:8px;}
            #toolbar.minimized .tools {pointer-events:none;}
            #toolbar.minimized .tool {transform:translateX(-12px);opacity:0;pointer-events:none;}

            #toolbar.minimized .tool:nth-child(1) {transform:translate(-20px, 20px);}
            #toolbar.minimized .tool:nth-child(2) {transform:translate(-16px, 12px);}
            #toolbar.minimized .tool:nth-child(3) {transform:translate(-12px, 4px);}
            #toolbar.minimized .tool:nth-child(4) {transform:translate(-12px, -4px);}
            #toolbar.minimized .tool:nth-child(5) {transform:translate(-16px, -12px);}
            #toolbar.minimized .tool:nth-child(6) {transform:translate(-20px, -20px);}
            #toolbar.minimized .tool:nth-child(7) {transform:translate(-20px, -20px);}

            #toolbar.minimized .tool:nth-child(1) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(2) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(3) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(4) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(5) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(6) {transform:translate(-12px, 0);}
            #toolbar.minimized .tool:nth-child(7) {transform:translate(-12px, 0);}


        #tweaks {position:fixed;top:0;right:0;bottom:0;padding:8px;overflow-y:auto;width:200px;box-sizing:border-box;background:#f4f4f4;z-index:1336;color:#333;}
            #tweaks h4 {padding: 8px 8px 12px;font-weight: 600;}

        .ui2 .tools {background:var(--toolselect);box-shadow:0 3px 40px rgba(0,0,0,.4);padding:0 0 48px;border-radius:var(--toolbarradius);}
            .ui2 .tools::after {content:'';display:block;clear:both;}

            .ui2 .horizontal  .tools, .horiz.ui2 .tools {padding:0;}
            .ui2 .horizontal .handle {display:none;}

        .ui2 .tool {display:flex;}
            .ui2 .toolbtn {width:calc(100% - 8px);margin:4px auto;height:calc(100% - 8px);background:transparent;box-shadow:none;}

                .ui2 .tool.active .toolbtn {background:var(--toolselect2);}
                
            .ui2 .handle {bottom:0;top: auto;left: 0;}

            .ui2 .options {left:calc(var(--toolbtn) + 8px);border-radius:var(--toolbarradius);width:48px;height: auto;}

            .ui2 .horizontal .options {left:50%;margin-left:-24px;top:auto;bottom:calc(var(--toolbtn) + 12px);}

                .ui2 .controls {padding:0;float:none;margin:0;}
                .ui2 .controls * {float:none;}
                .ui2 .options .label {display:none;}
                .ui2 .control .option {width:48px;height:48px;display: flex;align-content: center;align-items: center;justify-content: center;justify-items: center;}
            .ui2 .option .fill {margin:0;}

        .ui3 .tools {height:48px;background:var(--toolselect);box-shadow:0 3px 40px rgba(0,0,0,.4);padding:0px 40px 0 0;border-radius:var(--toolbarradius);}
            .ui3 .tool {float:left;min-width:48px;height:40px;margin:4px 0 0;width:auto;border-radius:4px;}
            .ui3 .toolbtn {width:48px;float:left;margin:4px auto;height:calc(100% - 8px);background:transparent !important;box-shadow:none !important;}

        .ui3 .tool.active {background:#0f0f10;}
            

        .ui3 .handle {bottom:1px;top: auto;left: auto;right:0px;box-shadow:none;}

        .ui3 .options {position:relative;left:0;width:0;background:transparent;border-radius: 0;box-shadow:none;}
        .ui3 .controls {padding:0;}

        .ui3 .toggled .options {width:auto;}

        .size {width:28px;height:28px;margin-top:6px;border-radius:50%;box-shadow:inset 0 0 0 1px hsla(0, 0%, 100%, 0.5);position:relative;}
            .size .actual {position:absolute;top:50%;left:50%;width:8px;height:8px;background:white;border-radius:50%;transform:translate(-50%, -50%);}

        .option .fill {cursor:pointer;width:28px;height:28px;margin-top:6px;border-radius:50%;box-shadow:inset 0 0 0 1px hsla(0, 0%, 100%, 0.175);position:absolute;background:black;}
        .option .border {cursor:pointer;width:28px;height:28px;border-radius:50%;border:4px solid rgba(155, 155, 155, 0.15);box-sizing:border-box;}

        .slider {width:48px;height:200px;position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,.1);border-radius:24px;touch-action: manipulation;background:#212122;}
            .slider .knob {width:32px;height:32px;background:white;border-radius:0;position:absolute;top:20px;left:50%;transform:translate(-50%, 0);border-radius:50%;}

        .swatches {padding:12px;height:48px;}
        .swatches .swatch {width:48px;height:48px;display:inline-block;cursor:pointer;transition:all 150ms ease-in-out;position:relative;}
            .swatches .swatch:nth-child(1) {background:rgb(255,59,48);border-radius: 8px 0 0 8px;}
            .swatches .swatch:nth-child(2) {background:rgb(255,149,0);}
            .swatches .swatch:nth-child(3) {background:rgb(255,204,0);}
            .swatches .swatch:nth-child(4) {background:rgb(76,217,100);}
            .swatches .swatch:nth-child(5) {background:rgb(90,200,250);}
            .swatches .swatch:nth-child(6) {background:rgb(0,122,255);}
            .swatches .swatch:nth-child(7) {background:rgb(88,86,214);}
            .swatches .swatch:nth-child(8) {background:white;}
            .swatches .swatch:nth-child(9) {background:black;border-radius: 0 8px 8px 0;}

        .swatches .swatch:hover {transform:scale(1.1);z-index:3;}
        .swatches .swatch:active {transform:scale(1.05);}

        .ui1half {}

        .type_tool canvas, .type_tool {cursor:text !important;}

        .textwrap {position:absolute;}
        .textarea {cursor: default;user-select:none;pointer-events:none;padding:12px;resize:none;border-radius:4px;position:relative;min-width:48px;height:28px;z-index:1337;background:transparent;border:none;color:white;font-size:24px;}
            .textwrap:not(.current):hover .textarea {box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);}
            .current .textarea {box-shadow:0 0 0 2px var(--select);user-select:text;cursor:text;pointer-events:all;}
        

        .backbtn {width:48px;height:48px;background:var(--panel);border-radius:var(--toolbarradius);display:flex;align-content:center;align-items:center;justify-content:center;justify-items:center;position: absolute;top: 0;left: -56px;box-shadow: 0 2px 20px var(--shadow2);}
            .backbtn svg {width:24px;height:auto;display:block;transform:rotate(180deg);}
                .backbtn svg * {fill:var(--icon);}


        canvas {pointer-events:none;}
        .brush_tool canvas {pointer-events:all;}

        .rectangle {transition:box-shadow 150ms ease-in-out;cursor:pointer;cursor:grab;}
            .rectangle:active {cursor:grabbing;}

          .rectangle:hover, .rectangle.drawing {box-shadow: 0 0 0 2px var(--select);}
            .rectangle.current {box-shadow: 0 0 0 2px var(--select);z-index:7;}

            .resizehandle {border-radius:50%;position:absolute;background:var(--handlecolor);box-shadow:0 0 0 1px var(--handlecolor);width:var(--handlesize);height:var(--handlesize);display:none;transition:box-shadow 125ms ease-in-out;}
              .resizehandle:hover, .resizehandle.active {box-shadow:0 0 0 1px var(--handlecolor), inset 0 0 0 12px #fff;}
              .current .resizehandle {display:block;}

            .resizehandle::after {content:'';position:absolute;width:48px;height:48px;top:50%;left:50%;transform:translate(-50%, -50%);}

            .rectangle .resizehandle:nth-child(1) {top:var(--handlegap);left:var(--handlegap);cursor:nwse-resize;}
            .rectangle .resizehandle:nth-child(2) {top:var(--handlegap);right:var(--handlegap);cursor:nesw-resize;}
            .rectangle .resizehandle:nth-child(3) {bottom:var(--handlegap);left:var(--handlegap);cursor:nesw-resize;}
            .rectangle .resizehandle:nth-child(4) {bottom:var(--handlegap);right:var(--handlegap);cursor:nwse-resize;}

            .ellipse .resizehandle:nth-child(1) {top:-5px;left:50%;margin-left:-4px;cursor:ns-resize;}
            .ellipse .resizehandle:nth-child(2) {top:50%;margin-top:-4px;right:-5px;cursor:ew-resize;}
            .ellipse .resizehandle:nth-child(3) {bottom:-5px;left:50%;margin-left:-4px;cursor:ns-resize;}
            .ellipse .resizehandle:nth-child(4) {top:50%;margin-top:-4px;left:-5px;cursor:ew-resize;}

        .contextpanel {overflow:hidden;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 150ms ease-in-out, transform 150ms ease-in-out;background:var(--panel);border-radius:var(--toolbarradius);box-shadow:0 3px 20px var(--shadow);min-height:48px;position:absolute;top:-64px;left:50%;transform:translate(0, 4px);z-index:9999999999999;}
            .current:not(.drawing) .contextpanel, .current:not(.moving) .contextpanel, .contextpanel.visible {opacity:1;pointer-events:all;transform:translate(0, 0);}
            
            /* .contextpanel.visible.sublevel {opacity:0;pointer-events:none;transform:translate(-8px, 0);} */


            .contextpanel .option {cursor:pointer;min-width:48px;height:48px;box-sizing:border-box;display:inline-flex;vertical-align:top;align-content:center;align-items:center;justify-content:center;justify-items:center;}

            .contextpanel .option:first-child {transition:all 150ms ease-in-out;}
                .sublevel.contextpanel .option:first-child {margin-left:-240px;}

                .morebtn svg {transition:all 150ms ease-in-out;}
                .sublevel .morebtn svg {transform:rotate(180deg);}
    
            .contextpanel .option svg {width:24px;height:24px;}
                .contextpanel .option svg * {fill:var(--panelicons);}

            .contextpanel .option .fill {margin:0;}

            .contextpanel .option:hover {background-color:var(--hover);}
            .contextpanel .option:active {background-color:var(--active);}

            .recticon {width:24px;height:24px;border:3px solid rgba(255,255,255,.5);box-sizing:border-box;}


            .menuwrap {position:fixed;opacity:0;transition: all 150ms ease-in-out;user-select:none;z-index:999999999999991;transform: translateX(6px);touch-action: manipulation;}
                .menuwrap.visible {transform:translateX(0);opacity:1;}

            .overflowmenu {overflow:hidden;background: var(--toolselect);border-radius:var(--toolbarradius);padding:4px 0;box-shadow: 0 2px 20px var(--shadow2);}
                
                .mitem {cursor:pointer;min-height:48px;padding:8px 16px;display:flex;align-content:center;align-items:center;box-sizing:border-box;font-size:18px;}
                .mitem:hover {background-color:var(--hover);}
                .mitem:active {background-color:var(--active);}


        .flyout {padding:0 16px;font-size:18px;line-height:23px;}
            .flyout .label {display:inline-block;vertical-align:middle;height:24px;}
            .flyout .icon {display:inline-block;vertical-align:middle;height:24px;margin:0 -4px 0 4px;}
                .flyout .icon svg {display:block;}


        .toggle {width:40px;height:24px;border-radius:30px;background:grey;position:relative;background:rgba(0,0,0,.05);box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.02);cursor:pointer;transition:background 150ms ease-in-out;display: inline-block;margin-right:8px;vertical-align: middle;}
            .toggle::after {content:'';position:absolute;top:4px;left:4px;width:16px;height:16px;background:white;display:block;box-shadow:0 2px 4px rgba(0,0,0,.15);border-radius:50%;transition:transform 150ms ease-in-out;}
            label:hover .toggle {background: rgba(0, 0, 0, 0.08);}
            label:active .toggle {background: rgba(0, 0, 0, 0.12);}

            label:hover .toggle::after {box-shadow:0 2px 5px rgba(0,0,0,.18);}
            label:active .toggle::after {}


        :checked ~ .toggle {background:hsl(130, 65%, 57%);box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.0);}
        :checked ~ .toggle:after {transform:translateX(100%);}

            label:hover :checked ~ .toggle {background:hsl(130, 65%, 51%);}
            label:active :checked ~ .toggle {background:hsl(130, 65%, 48%);}


            label {user-select:none;}

        input.tweakr {display:none;}

        .tweak {cursor:pointer;}
            .tweak label {display:block;padding:8px;cursor:pointer;font-size: 14px;}


        .tweaked {padding: 16px 8px;}
            .tweaked .tweak {margin-bottom:20px;}

        .tweak .label {font-size:12px;display:flex;margin-bottom:8px;}
        .tweak span {width: 100%;}
        .tweak .value {font-size:12px;opacity:.54;text-align:right;}
        .tweak input[type=range] {padding:0 4px;width: 100%;height: 24px;border-radius:30px;background:grey;position:relative;background:rgba(0,0,0,.05);box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.02);cursor:pointer;transition:background 150ms ease-in-out;display: inline-block;margin-right:8px;vertical-align: middle;}

        .toolbar4, .ui4 #toolbar {display:none;}
        .ui4 .toolbar4 {display:block;}


        #advancedpanel {max-width: 320px;padding-bottom: 12px;opacity:0;pointer-events:none;position:fixed;top:50%;right:224px;transform:translateY(-50%);transition:opacity 150ms ease-in-out;}
            .advanced #advancedpanel {opacity:1;pointer-events:all;}

            #advancedpanel .pan {display:none;}
            .brush_tool #advancedpanel .brushpanel, .type_tool #advancedpanel .typepanel {display:block;}


        #keyboard {position:fixed;max-width:772px;width:100%;top:50%;left:50%;z-index:9999999999999999;background:#181819;padding:8px 8px 0px;border-radius:12px;box-shadow: 0 2px 20px var(--shadow2);opacity:0;pointer-events:none;transition:opacity 150ms ease-in-out;}
            #keyboard.show {opacity:1;transform:translateY(0);pointer-events:all;}
        #keyboard .row {display:flex;padding: 0 0 8px;margin:0;}
            #keyboard .key {display:flex;width:60px;height:60px;align-items:center;justify-content:center;font-size:24px;font-weight:600;background:#262627;margin-right:8px;cursor:pointer;}

                #keyboard .key:last-child {margin:0;}
               
                #keyboard .key.shift {width:92px;background:#303031;}

                #keyboard .key.space {width:704px;background:#303031;}

                #keyboard .key.return {width:76px;background:#303031;}
                #keyboard .key.del {width:92px;background:#303031;}
                #keyboard .key.num {background:#303031;}

                #keyboard .key:hover {background:#303031;}
                #keyboard .key:active {background:#434348;}

        #keyboard.uppercase .key {text-transform:uppercase;}
            #keyboard.uppercase .shift {background:#434348;}

        #keyboard .row:first-child .key:first-child {border-radius: 6px 0 0 0;}
        #keyboard .row:first-child .key:last-child {border-radius: 0 6px 0 0;}
        #keyboard .row:last-child .key:first-child {border-radius: 0 0 0 6px;}
        #keyboard .row:last-child .key:last-child {border-radius: 0 0 6px 0;}

        .minishape {width:48px;height:48px;display:inline-flex;align-items:center;justify-content:center;cursor: pointer;}

        .minishape .square, .minishape .circle {width:22px;height:22px;border-radius:2px;border:2px solid var(--icon);box-sizing:border-box;}
            .minishape .circle {border-radius:50%;}

            #brush_context {opacity:0;pointer-events:none;top:auto !important;}
            .brush_tool #brush_context {opacity:1;pointer-events:all;bottom:24px;left:24px;top:auto !important;transform:translateY(0);}
            
        
        .canvaslabel {position: absolute;top:-32px;left:-2px;padding:3px 8px 4px;background:#4E4D4D;color:white;border-radius:6px;white-space:nowrap;font-size:14px;font-weight:500;transition:all 150ms ease-in-out;}
            .current .canvaslabel {background:#433453;}

            .neartop .canvaslabel {top:4px;left:4px;}

            .canvasboard.current {border-color:#7754A1 !important;box-shadow:none;}


            input[type=range] {
            -webkit-appearance: none; /* Hides the slider so that custom slider can be made */
            width: 280px; /* Specific width is required for Firefox. */
            background: transparent; /* Otherwise white in Chrome */
            border:none;
            cursor:pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }

        input[type=range]:focus {
            outline: none; /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
            box-shadow:none;
        }

        input[type=range]::-webkit-slider-thumb {width: 16px;height: 16px;background: white;display: block;box-shadow: 0 2px 4px rgba(0,0,0,.15);border-radius: 50%;transition: all 150ms ease-in-out;}
        input[type=range]:hover::-webkit-slider-thumb {box-shadow:0 2px 2px rgba(0,0,0,.2);}
        input[type=range]:active::-webkit-slider-thumb {box-shadow:0 2px 2px rgba(0,0,0,.3);cursor:-webkit-grabbing;}
        input[type=range]:focus::-webkit-slider-thumb {}
            input[type=range]:hover:focus::-webkit-slider-thumb {}



        input[type=range]::-webkit-slider-runnable-track {}
        input[type=range]:focus::-webkit-slider-runnable-track {}


        .lock .locked {display:none;}
        .lock.unlock .unlocked {display:none;}
        .lock.unlock .locked {display:block;}


        .grid body {background-size: var(--dotgrid) var(--dotgrid);background-image: linear-gradient(to right, var(--gridcolor) 1px, transparent 1px), linear-gradient(to bottom, var(--gridcolor) 1px, transparent 1px);background-position: center;}
            .highlight.grid body {background-image: linear-gradient(to right, var(--gridcolor) 1px, transparent 1px), linear-gradient(to bottom, var(--gridcolor2) 1px, transparent 1px),linear-gradient(to right, var(--gridcolor2) 1px, transparent 1px), linear-gradient(to bottom, var(--gridcolor) 1px, transparent 1px);background-size:var(--dotgrid) var(--dotgrid), 1px calc(var(--dotgrid) * 9), calc(var(--dotgrid) * 9) 1px;}
        /* .dotgrid body {background: linear-gradient(90deg, var(--canvas) calc(var(--dotgrid) - var(--dotsize)), transparent 1%) center, linear-gradient(var(--canvas) calc(var(--dotgrid) - var(--dotsize)), transparent 1%) center, var(--dotcolor);background-size: var(--dotgrid) var(--dotgrid);} */
        .dotgrid body { background-image: radial-gradient(var(--dotcolor) var(--dotsize), transparent 0);background-size: var(--dotgrid) var(--dotgrid);background-position:center;}
            .highlight.dotgrid body {background-image: radial-gradient(circle, var(--dotcolor) var(--dotsize), transparent 0), radial-gradient(circle, var(--dotcolor2) var(--dotsize), transparent 0);background-size: var(--dotgrid) var(--dotgrid), calc(var(--dotgrid) * 9) calc(var(--dotgrid) * 9);}


            .highlight.dotgrid body {
            background-image:   radial-gradient(circle, var(--dotcolor2) var(--dotsize), transparent 0), 
                                radial-gradient(circle, var(--canvas) var(--dotsize), transparent 0), 
                                radial-gradient(circle, var(--canvas) var(--dotsize), transparent 0), 
                                radial-gradient(circle, var(--dotcolor) var(--dotsize), transparent 0);    
            
            background-size:    calc(var(--dotgrid) * 9) calc(var(--dotgrid) * 9), 
                                var(--dotgrid) calc(var(--dotgrid) * 9), 
                                calc(var(--dotgrid) * 9) var(--dotgrid), 
                                var(--dotgrid) var(--dotgrid);
            }


        .bgmenu {width:336px;padding:12px;background:var(--panel);box-shadow:0 3px 20px var(--shadow2);border-radius:var(--toolbarradius);}
            .menutitle {font-weight: 600;padding:2px 8px;}

        .colors {display: flex;flex-wrap: wrap;margin-top:12px;} 
            .colors .color {width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
                .color .chip {width:28px;height:28px;border-radius:50%;position:relative;box-shadow:inset 0 0 0 1px rgba(255, 255, 255, 0.1);}

                .color .chip::after, .menubtn > div::after {content:'';width:calc(100% + 8px);height:calc(100% + 8px);border:2px solid white;box-sizing:border-box;border-radius:50%;top:-4px;left:-4px;opacity:0;display:block;position:absolute;transition:opacity 150ms ease-in-out;}

                .color:hover .chip::after, .menubtn:hover > div::after {opacity:.5;}
                .color:active .chip::after, .color.current .chip::after, .menubtn:active > div::after, .menubtn.current > div::after {opacity:1;}

                .color:nth-child(1) .chip {background-color:#D50201;}
                .color:nth-child(2) .chip {background-color:#C51262;}
                .color:nth-child(3) .chip {background-color:#AB00FF;}
                .color:nth-child(4) .chip {background-color:#6300EA;}
                .color:nth-child(5) .chip {background-color:#314EFE;}
                .color:nth-child(6) .chip {background-color:#2B61FF;}
                .color:nth-child(7) .chip {background-color:#0091EA;}
                .color:nth-child(8) .chip {background-color:#00B8D4;}
                .color:nth-child(9) .chip {background-color:#00BFA5;}
                .color:nth-child(10) .chip {background-color:#00C853;}
                .color:nth-child(11) .chip {background-color:#63DD18;}
                .color:nth-child(12) .chip {background-color:#ADEA03;}
                .color:nth-child(13) .chip {background-color:#FFCC02;}
                .color:nth-child(14) .chip {background-color:#FF9502;}
                .color:nth-child(15) .chip {background-color:#FFFFFF;}
                .color:nth-child(16) .chip {background-color:#767676;}
                .color:nth-child(17) .chip {background-color:#1a191b;}
                .color:nth-child(18) .chip {background-color:#000000;}


            .menurow {display:flex;flex-wrap:wrap;margin-top:12px;}
                .menubtn {width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

                .nullcolor {width:28px;height:28px;border-radius:50%;box-sizing:border-box;position:relative;
                    box-shadow:inset 0 0 0 3px  var(--null);
                    background: linear-gradient(to right, var(--null) 3px, transparent 3px);
                    background-position: 12.5px; /* width / 2 - line /2 */
                    transform: rotate(45deg);
                }


            .rainbowcolor {position:relative;width:28px;height:28px;border-radius:50%;box-sizing:border-box;background:white;background-image: linear-gradient(217deg, rgba(255,0,0,1), rgba(255,0,0,0) 70.71%), linear-gradient(127deg, rgba(0,255,0,1), rgba(0,255,0,0) 70.71%), linear-gradient(336deg, rgba(0,0,255,1), rgba(0,0,255,0) 70.71%);}

    </style>
</head>
<body class="rectanglex brush_tool ">
    <div id=toolbar>
        <div class=handle>
            <div class=fakehandle>
                <svg class=close xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 11h12v2H6z"/></svg>
                <svg class=open xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>
        <div class=tools>
            <div class=tool>
                <div class=toolbtn id=select_tool data-tool=select>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:28px;" viewBox="0 0 24 24">
                        <path style="transform: rotate(-20deg);transform-origin: center;" d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                    </svg> -->
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path style="transform: rotate(-20deg);transform-origin: center;" d="M12 7.27l4.28 10.43-3.47-1.53-.81-.36-.81.36-3.47 1.53L12 7.27M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M28.1,16.6c0-0.5-0.3-0.9-0.8-1.1L9.8,9c-0.5-0.2-1-0.1-1.3,0.3C8.2,9.6,8,10.1,8.2,10.6l6.4,17.5c0.2,0.5,0.6,0.8,1.1,0.8	c0,0,0,0,0.1,0c0.5,0,0.9-0.3,1.1-0.7l2.8-5.8l5.5,5.6c0.2,0.2,0.6,0.4,0.9,0.4c0.3,0,0.6-0.1,0.9-0.4c0.5-0.5,0.5-1.3,0-1.8	l-5.5-5.6l5.9-2.9C27.8,17.5,28.1,17.1,28.1,16.6z M19,19.1c-0.2,0.1-0.4,0.1-0.5,0.3c-0.1,0.1-0.2,0.3-0.3,0.5L16,24.5l-4.5-12.2	l12.2,4.5L19,19.1z"/>
                    </svg>
                </div>
                <div class=options>
                    
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn data-tool=rectangle id=shape_tool2>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 4H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H6V6h12v12z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M7,8v22h22V8H7z M26,27H10V11h16V27z"/>
                    </svg>
                </div>
                <div class=options>
                    <div class=controls>
                        <div class=control id=shapecolor>
                            <div class=label>Color</div>
                            <div class=option>
                                <div class=fill id=shapefill style="background: rgb(255, 59, 48);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn data-tool=type id=type_tool2>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 17v2h14v-2H5zm4.5-4.2h5l.9 2.2h2.1L12.75 4h-1.5L6.5 15h2.1l.9-2.2zM12 5.98L13.87 11h-3.74L12 5.98z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" >
                        <polygon points="29,10 7,10 7,13 16.5,13 16.5,27.5 19.5,27.5 19.5,13 29,13 "/>
                    </svg>
                </div>
                <div class=options>
                    <div class=controls>
                        <div class=control id=font>
                            <div class=label>Font</div>
                            <div class=option>Helvetica</div>
                        </div>
                        <div class=control>
                            <div class=label>Size</div>
                            <div class=option>24</div>
                        </div>
                        <div class=control>
                            <div class=label>Color</div>
                            <div class=option id=textfill2>Blue</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tool active">
                <div class=toolbtn data-tool=brush>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:28px;" viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"/></svg> -->
                    <!-- <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24"><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg> -->
                    <!-- <svg xmlns="http://www.w3.org/2000/svg"  style="width:28px;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M13.9,33c-0.4,0-0.9-0.2-1.2-0.6c-0.5-0.7-0.4-1.6,0.3-2.1c0.7-0.5,1.1-1.5,1.4-2.7c-3.1-1.4-5-4-5.5-7.2		c-0.7-5.1,3-8.6,6-11.5c1.7-1.6,3.4-3.2,3.4-4.4C18.3,3.6,19,3,19.8,3c0.8,0,1.5,0.7,1.4,1.6C21.1,7,19.1,8.9,16.9,11		c-2.8,2.6-5.6,5.4-5.1,8.9c0.3,2.3,1.8,3.7,3.1,4.5c0.5-3.3,1-7.1,4.3-8.3c2.6-1,5.3-0.1,6.9,2.2c1.7,2.6,1.5,5.9-0.5,8.1		c-1.8,1.9-5.1,2.7-8.3,2.1c-0.4,1.7-1.1,3.2-2.4,4.2C14.5,32.9,14.2,33,13.9,33z M17.8,25.5c2.3,0.4,4.6,0,5.6-1.1		c1.2-1.3,1-3.2,0.2-4.4c-0.4-0.6-1.4-1.8-3.3-1.1c-1.6,0.6-2,2.8-2.4,6C17.8,25.1,17.8,25.3,17.8,25.5z"/>
                    </svg>
                </div>
                <div class=options style="max-width: 208px;">
                    <div class=controls>
                        <div class=control id=brushsize>
                            <div class=label>Size</div>
                            <div class=option>
                                <div class=size>
                                    <div class=actual id=brushactual></div>
                                </div>
                            </div>
                        </div>
                        <div class=control id=brushcolor>
                            <div class=label>Color</div>
                            <div class=option>
                                <div class=fill id=brushfill></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <polygon points="29,16.5 19.5,16.5 19.5,7 16.5,7 16.5,16.5 7,16.5 7,19.5 16.5,19.5 16.5,29 19.5,29 19.5,19.5 29,19.5 "/>
                    </svg>
                </div>
                <div class=options>
                    
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn id=canvas_tool data-tool=canvas>
                        <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:24px;" viewBox="0 0 22 22"><path d="M25-378H41v16H25Zm2,2v12H39v-12Zm-5-5h2v2H22Zm0,20h2v2H22Zm20,0h2v2H42Zm0-20h2v2H42Z" transform="translate(-22 381)" fill="#fff" fill-rule="evenodd"/></svg> -->
                        <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                            <g transform="translate(-59 -557)">
                                <polygon points="68,570.5 65,570.5 65,563 72.5,563 72.5,566 68,566"/>
                                <polygon points="89,570.5 86,570.5 86,566 81.5,566 81.5,563 89,563"/>
                                <polygon points="72.5,587 65,587 65,579.5 68,579.5 68,584 72.5,584"/>
                                <polygon points="89,587 81.5,587 81.5,584 86,584 86,579.5 89,579.5"/>
                            </g>
                        </svg>
                </div>
                <div class=options>
                    
                </div>
            </div>
            <div class=tool>
                <div class=toolbtn>
                    <!-- <svg xmlns="http://www.w3.org/2000/svg" style="width:28px;" viewBox="0 0 20 20"><path d="M15.95 10.78c.03-.25.05-.51.05-.78s-.02-.53-.06-.78l1.69-1.32c.15-.12.19-.34.1-.51l-1.6-2.77c-.1-.18-.31-.24-.49-.18l-1.99.8c-.42-.32-.86-.58-1.35-.78L12 2.34c-.03-.2-.2-.34-.4-.34H8.4c-.2 0-.36.14-.39.34l-.3 2.12c-.49.2-.94.47-1.35.78l-1.99-.8c-.18-.07-.39 0-.49.18l-1.6 2.77c-.1.18-.06.39.1.51l1.69 1.32c-.04.25-.07.52-.07.78s.02.53.06.78L2.37 12.1c-.15.12-.19.34-.1.51l1.6 2.77c.1.18.31.24.49.18l1.99-.8c.42.32.86.58 1.35.78l.3 2.12c.04.2.2.34.4.34h3.2c.2 0 .37-.14.39-.34l.3-2.12c.49-.2.94-.47 1.35-.78l1.99.8c.18.07.39 0 .49-.18l1.6-2.77c.1-.18.06-.39-.1-.51l-1.67-1.32zM10 13c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/></svg> -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                        <path d="M8,28V8h20l-6.4,6.4h-7.2v7.2L8,28z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <div id=advancedpanel class="panel draggable">
        <div class="pan brushpanel">
            <div class=row>
                <div class=input>
                    <input type=text value="BLue" />
                    <div class=label>Color</div>
                </div>
            </div>
            <div class=row>
                <div class=input>
                    <input type=text value="Open Sans" />
                    <div class=label>Size</div>
                </div>
            </div>
        </div>
        <div class="pan typepanel">
            <div class=row>
                <div class=input>
                    <input type=text value="Open Sans" />
                    <div class=label>Font</div>
                </div>
            </div>
            <div class=row>
                <div class=input>
                    <input type=text value=Bold />
                    <div class=label>Style</div>
                </div>
                <div class=input style="width:50%;">
                    <input type=number value=24 />
                    <div class=label>Size</div>
                </div>
            </div>
            <div class=row style="margin-top: 8px;">
                <div class=input>
                    <div class=buttons>
                        <button class=selected>Left</button><button>Center</button><button>Right</button>
                    </div>
                    <div class=label>Alignment</div>
                </div>
            </div>
            <div class=row>
                <div class=input>
                    <input type=number value=0 />
                    <div class=label>Kern</div>
                </div>
                <div class=input>
                    <input type=number value=40 />
                    <div class=label>Line</div>
                </div>
                <div class=input>
                    <input type=number value=0 />
                    <div class=label>Break</div>
                </div>
            </div>
        </div>
    </div>

    <div id=brush_context class=contextpanel>
        <div class="option" id="brushsize">
            <div class="size" style="margin:0;">
                <div class="actual brushactual2" id="brushactual"></div>
            </div>
        </div><div class="option" id=brushcolor>
            <div class="fill brushfill2" id="brushfill"></div>
        </div>
    </div>

    <div id=panels style="display:none;">
        <div class="panel shapes_panel" id=shapes_panel style="border-radius: var(--toolbarradius);padding: 2px 4px;">
            <div class="minishape" data-type=rectanglex><div class="square"></div></div><div class="minishape" data-type=circlex><div class="circle"></div></div>
        </div>
        <div class=panel id=fontsize_panel style="padding:4px;border-radius:32px;margin-left:18px;transform:translateY(4px);">
            <div class=slider data-y=136>
                <div class=knob style="top: 136px; transform: translateX(-50%) scale(0.3);"></div>
            </div>
        </div>
        <div class=panel id=brushsize_panel style="padding:4px;border-radius:32px;margin-left:18px;transform:translateY(4px);">
            <div class=slider data-y=136>
                <div class=knob style="top: 136px; transform: translateX(-50%) scale(0.3);"></div>
            </div>
        </div>
        <div class=panel id=brushcolor_panel data-id=brush style="margin-left: -80px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=shapecolor_panel data-id=shape style="margin-left: -80px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=textcolor_panel data-id=text style="margin-left: -80px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=shape2color_panel data-id=shape2 style="margin-left: -80px;width:456px;">
            <div class=swatches>
                <div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div><div class=swatch></div>
            </div>
        </div>
        <div class=panel id=font_panel style="opacity:0;transform:translateY(8px);height:364px;width:356px;">
            <div class=slide>
                <div class=list>
                    <div class="item current">Font 1</div>
                    <div class=item>Font 2</div>
                    <div class=item>Font 3</div>
                    <div class=item>Font 4</div>
                    <div class=item>Font 5</div>
                    <div class=item>Font 6</div>
                    <div class=item>Font 7</div>
                    <div class=item>Font 8</div>
                </div>
            </div>
            <div class=slide>
                <div class=row>
                    <div class=input>
                        <input type=text value="Open Sans" />
                        <div class=label>Font</div>
                    </div>
                </div>
                <div class=row>
                    <div class=input>
                        <input type=text value=Bold />
                        <div class=label>Style</div>
                    </div>
                    <div class=input style="width:50%;">
                        <input type=number value=24 />
                        <div class=label>Size</div>
                    </div>
                </div>
                <div class=row style="margin-top: 8px;">
                    <div class=input>
                        <div class=buttons>
                            <button class=selected>Left</button><button>Center</button><button>Right</button>
                        </div>
                        <div class=label>Alignment</div>
                    </div>
                </div>
                <div class=row>
                    <div class=input>
                        <input type=number value=0 />
                        <div class=label>Kern</div>
                    </div>
                    <div class=input>
                        <input type=number value=40 />
                        <div class=label>Line</div>
                    </div>
                    <div class=input>
                        <input type=number value=0 />
                        <div class=label>Break</div>
                    </div>
                </div>
            </div>
            <div class=page>
                <div class=dot onclick="dots.call(this,event,0)"></div>
                <div class="dot current" onclick="dots.call(this,event,1)"></div>
            </div>
        </div>

        <div id=shape_context class=contextpanel>
            <!-- <div class=option>
                <div class=recticon></div>
            </div> -->
            <div class="option fillcolor" data-menu=bgmenu> <!-- id=shape2color -->
                <div class="fill shape2fill" style="background:rgb(255, 59, 48);"></div>
            </div><div class="option shapeborder">
                <div class="border" id="shapeborder"></div>
            </div><div class="option shapeup">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
            </div><div class="option shapeback">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
            </div><div class="option lock" onclick="this.classList.toggle('unlock');">
                <svg xmlns="http://www.w3.org/2000/svg" class=locked viewBox="0 0 24 24"><path d="M18,8H17V6A5,5,0,0,0,7,6V8H6a2,2,0,0,0-2,2V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V10A2,2,0,0,0,18,8ZM9,6a3,3,0,0,1,6,0V8H9Zm9,14H6V10H18Z"/></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class=unlocked viewBox="0 0 24 24"><path d="M18,8h-1V6c0-2.8-2.2-5-5-5S7,3.2,7,6h2c0-1.7,1.3-3,3-3s3,1.3,3,3v2H6c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12 c1.1,0,2-0.9,2-2V10C20,8.9,19.1,8,18,8z M18,20H6V10h12V20z"/></svg>
            </div><div class="option morebtn">
                <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg> -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        
            <div class="content"></div>
        </div>

        <div class="panel" id=border_panel>
            <!-- <div class="slider horizontal">
                slider
            </div> -->
            <div class="swatches">
                <div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div><div class="swatch"></div>
            </div>
        </div>

        <div id=text_context class=contextpanel>
            <div class=option id=font>
                <div class=flyout>
                    <div class=label>Helvetica</div>
                </div>
            </div><div class=option>
                <div class=flyout>
                    <div class=label>24</div><div class=icon>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M7,10l5-5l5,5H7z"/>
                            <path d="M7,14l5,5l5-5H7z"/>
                        </svg>
                    </div>
                </div>
            </div><div class="option textcolor" data-menu=textcolormenu>
                <div class="fill textfill" id="textfill" style="background:white;"></div>
            </div><div class="option shapeup">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
            </div><div class="option shapeback">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
            </div><div class="option morebtn">
                <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg> -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        </div>

        <div id=moremenu>
            <div class=mitem>Copy</div>
            <div class="mitem delete">Delete</div>
            <div class=mitem>Comment</div>
            <div class=mitem>Pin</div>
        </div>

        <div id=bgmenu>
            <div class=menutitle>Background Color</div>
            <!-- <div class=menutabs>
                Transparent   Current    color select
            </div> -->
            
        </div>

        <div id=textcolormenu>
            <div class=menutitle>Text Color</div>
 
        </div>

        <div id=colorswatches>
            <div class=colors>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
                <div class=color>
                    <div class=chip></div>
                </div>
            </div>
            <div class=menurow>
                <div class="menubtn transparentcolor color">
                    <div class=nullcolor></div>
                </div>
                <div class="menubtn selectcolor">
                    <div class=rainbowcolor></div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas2" style="cursor: crosshair; position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; width: 100%; height: 100%;z-index:1;"></canvas>

    <div id=tweaks>
        <h4>Tweaks</h4>
        <div class=tweak>
            <label><input type=checkbox value=light class=tweakr /><div class=toggle></div> Light</label>
        </div>
        <div class=tweak>
            <label><input type=checkbox value=ui2 id=ui2t class=tweakr onchange="document.getElementById('ui3t').checked=false;" /><div class=toggle></div> Vertical Bar</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=ui3 id=ui3t class=tweakr onchange="document.getElementById('ui2t').checked=false;" /><div class=toggle></div> Horizontal Bar</label>
        </div>

        <!-- <div class=tweak>
            <label><input type=checkbox value=ui4 id=ui4t class=tweakr onchange="" /><div class=toggle></div> UI 4</label>
        </div> -->

        <div class=tweak>
            <label><input type=checkbox value=advanced class=tweakr /><div class=toggle></div> Advanced Panel</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=insert class=tweakr /><div class=toggle></div> Insert</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=grid class=tweakr id=bggrid onchange="document.getElementById('bgdots').checked=false;" /><div class=toggle></div> Grid</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=dotgrid class=tweakr id=bgdots onchange="document.getElementById('bggrid').checked=false;" /><div class=toggle></div> Dot Grid</label>
        </div>

        <div class=tweak>
            <label><input type=checkbox value=highlight class=tweakr /><div class=toggle></div> Grid Markers</label>
        </div>

        <div class=tweaked>
            <div class=tweak>
                <div class=label><span>Toolbar Button Size</span><div class=value>60</div></div>
                <input type=range class=tooltweak min=16 max=76 value=60 step=4 data-id=toolbtn oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Button Gap</span><div class=value>12</div></div>
                <input type=range class=tooltweak min=0 max=32 value=12 step=2 data-id=toolgap oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Button Radius</span><div class=value>50</div></div>
                <input type=range class=tooltweak min=0 max=50 value=50 step=2 data-id=toolradius oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Tool Panel Radius</span><div class=value>12</div></div>
                <input type=range class=tooltweak min=0 max=32 value=12 step=2 data-id=toolbarradius oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Icon Scale</span><div class=value>52</div></div>
                <input type=range class=tooltweak min=0 max=100 value=52 step=2 data-id=toolicons oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Handle Spacing</span><div class=value>-4</div></div>
                <input type=range class=tooltweak min=-24 max=24 value=-4 step=2 data-id=handlegap oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Handle Size</span><div class=value>8</div></div>
                <input type=range class=tooltweak min=4 max=24 value=8 step=2 data-id=handlesize oninput="tweakedtools.call(this, event)" />
            </div>
            <div class=tweak>
                <div class=label><span>Horizontal Toolbar</span><div class=value></div></div>
                <label style="padding:0;"><input type=checkbox class=tweakr value="horiz" onchange="document.body.classList.toggle('horizontal');" /><div class=toggle></div> </label>
            </div>
            <div class=tweak>
                <div class=label><span>Toolbar Color</span><div class="value"></div></div>
                <input type=color id=toolbarhex onchange="toolbarcolor.call(this,event)" value="#282931" />
            </div>
            <div class=tweak>
                <div class=label><span>Workspace Color</span><div class=value></div></div>
                <input type=color onchange="canvascolor.call(this,event)" value="#323440" />
            </div>
            <div class=tweak>
                <div class=label><span>Selection Color</span><div class=value></div></div>
                <input type=color onchange="selectioncolor.call(this,event)" value="#00CEFF" />
            </div>
            <div class=tweak>
                <div class=label><span>Handle Color</span><div class=value></div></div>
                <input type=color onchange="handlecolor.call(this,event)" value="#00CEFF" />
            </div>
            <div class=tweak>
                <div class=label><span>Icon Color - <span id=iconcontrast></span></span><div class=value></div></div>
                <input type=color id=iconcolor onchange="iconcolor.call(this,event)" value="#BBBBBB" />
            </div>
            <div class=tweak>
                <div class=label><span>Tool Selection Color </span><div class=value></div></div>
                <input type=color onchange="toolselectioncolor.call(this,event)" value="#1b1b1c" />
            </div>

        </div>
    </div>

    <div id=keyboard class=draggable>
        <div class=row>
            <div class=key>q</div><div class=key>w</div><div class=key>e</div><div class=key>r</div><div class=key>t</div><div class=key>y</div><div class=key>u</div><div class=key>i</div><div class=key>o</div><div class=key>p</div><div class="key del">Del</div>
        </div>
        <div class=row>
            <div class=key style="margin-left: 16px;">a</div><div class=key>s</div><div class=key>d</div><div class=key>f</div><div class=key>g</div><div class=key>h</div><div class=key>j</div><div class=key>k</div><div class=key>l</div><div class=key>'</div><div class="key return">Return</div>
        </div>
        <div class=row>
            <div class="key shift">Shift</div><div class=key>z</div><div class=key>x</div><div class=key>c</div><div class=key>v</div><div class=key>b</div><div class=key>n</div><div class=key>m</div><div class=key>,</div><div class=key>.</div><div class=key>?</div>
        </div>
        <div class=row>
            <div class="key num">&123</div><div class="key space">Space</div>
        </div>
    </div>



    <div class="toolbar minimized toolbar4">
        <div class="handle fob">
            <div class=fakehandle>
                <svg class=close xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 11h12v2H6z"/></svg>
                <svg class=open xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>

            <div class=menu>
                <div class=item>Select</div>
                <div class=item>Shapes</div>
                <div class=item>Text</div>
                <div class=item>Draw</div>
                <div class=item>Components</div>
                <div class=item>Canvas</div>
                <div class=item>Settings</div>
            </div>

            <div class=submenu>
                brush size color opacity
                <div class="suboption brushsize"></div>
                <div class="suboption brushcolor"></div>
                <div class="suboption brushopacity"></div>
            </div>
        </div>

        <style>
            .toolbar {position:fixed;z-index:99999999;top:calc(100% - 64px);left:16px;}
            .fob {left:0;top:0;}
            .fob .fakehandle {width:36px;height:36px;background:#0262FD;box-shadow:0 3px 30px rgba(0,0,0,.25);}
            .fob .fakehandle svg {width: 24px;height: 36px;}

            .menu {position:absolute;bottom:56px;left:8px;padding: 4px 0;background:white;border-radius:6px;box-shadow:0 3px 40px rgba(0,0,0,.3);width:200px;min-height:200px;transition:all 150ms ease-in-out;opacity:0;pointer-events:none;transform:translateY(8px);}
            .toolbar:not(.minimized) .menu {opacity:1;pointer-events:all;transform:translateY(0);}

            .menu .item {font-size:16px;color:black;font-weight:600;}

            .submenu {position:absolute;top:0;left:56px;padding:0 4px;background:white;border-radius:6px;width:200px;height:48px;box-sizing:border-box;opacity:0;}
                .suboption {width:48px;height:100%;float:left;opacity:0;}


            input[type=color] {width: 100%;height: 36px;display: block;padding: 0;border: none;}
        </style>
    </div>

    <div id=layers></div>

    <script>
        FONTSIZE = 24;
        FONTCOLOR = 'white';

        function toolbarcolor(e){
            var n = 'tweaked_toolbar';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;
            var rgb = hex2rgb(v);
            console.log(rgb);
            var hsl = rgb2hsl(rgb);
            console.log(hsl)

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var hover = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) - 4) + '%)';
            var press = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) - 6) + '%)';

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --tool: ' + v + ';';//
            
            css += '--toolhover: ' + hover + ';';
            css += '--toolpress: ' + press + ';--toolselect: ' + press + ';--panel: ' + press + ';';
            // css += '--ui: ' + rgb[0] + ',' + rgb[1] + ',' + rgb[2];
            css += '}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);

            console.log(v);

            iconcolor.call(document.getElementById('iconcolor'), e);
        }

        function iconcolor(e){
            var n = 'tweaked_icons';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;
            var rgb = hex2rgb(v);
            console.log(rgb);
            var hsl = rgb2hsl(rgb);
            console.log(hsl)

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var l = 20;
            var b = brightness(rgb);
            //var b  = luminanace(rgb[0], rgb[1], rgb[2]);
            console.log(b, 'LUMS');

            var thex = document.getElementById('toolbarhex').value;
            var trgb = hex2rgb(thex);

            var rast = contrast(rgb, trgb);

            var arast = contrast(hsl2rgb([hsl[0],hsl[1],hsl[2] + l]), trgb);

            console.log(rast, arast);

            if ( rast < 1 ){
                rast = 1/rast;
            }

            if ( arast < 1 ){
                arast = 1/arast;
            }

            console.log(rast, arast);
            
            if ( arast < rast ){ 
                l = -20;
            }

            document.getElementById('iconcontrast').innerText = Math.round(rast * 100) / 100;

            var current = 'hsl(' + hsl[0] + ',' + hsl[1] + '%,' + (Number(hsl[2]) + l) + '%)';

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --icon: ' + v + ';';
            css += '--iconcurrent: ' + current + ';';
            css += '}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function canvascolor(e){
            var n = 'tweaked_canvas';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--canvas: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);

            var rgb = hex2rgb(v);

            var con = contrast(rgb, [255,255,255]);
            var con2 = contrast(rgb, [0,0,0]);

            if ( con < 1 ){
                con = 1/con;
            }

            if ( con2 < 1 ){
                con2 = 1/con2;
            }

            console.log(con,con2)

            if ( con < con2 ){
                document.body.classList.add('darkgrid');
            } else {
                document.body.classList.remove('darkgrid');
            }
        }

        function selectioncolor(e){
            var n = 'tweaked_select';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--select: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function toolselectioncolor(e){
            var n = 'tweaked_toolselect';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--toolselect2: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function handlecolor(e){
            var n = 'tweaked_handlecolor';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--handlecolor: ' + v + ';}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function handlegap(e){
            var n = 'tweaked_handlecolor';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var v = this.value;

            var p = this.getparent('tweak');
            var av = p.getElementsByClassName('value')[0];
            av.empty();
            av.appendChild(document.createTextNode(v));

            var s = document.createElement('style');
            s.className = n;
            
            var css = ':root{--handlegap: ' + v + 'px;}';

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);
        }

        function tweakedtools(e){
            var n = 'tweaked_css';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var t = document.getElementsByClassName('tooltweak');

            var s = document.createElement('style');
            s.className = n;
            var css = ':root{';

            for(var i=0;i<t.length;i++){
                var a = t[i];
                var p = a.getparent('tweak');
                var l = p.getElementsByClassName('value')[0];
                var d = a.dataset.id;
                var v = a.value;

                var x = 'px';
                if ( d == 'toolradius' || d == 'toolicons' ){
                    x = '%';
                }

                css += '--' + d +  ':' + v + x + ';';

                if ( this === a ){
                    l.empty();
                    l.appendChild(document.createTextNode(v));
                }
            }

            css += '}';

            s.appendChild(document.createTextNode(css));
            
            document.head.appendChild(s);

            console.log(v);
        }

        function luminanace(rgb) {
            var a = rgb.map(function (v) {
                v /= 255;
                return v <= 0.03928 ? v / 12.92 : Math.pow( (v + 0.055) / 1.055, 2.4 );
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }

        function brightness(rgb){
            return ((rgb[0] * 299) + (rgb[1] * 587) + (rgb[2] * 114)) / 1000;
        }

        function contrast(rgb1, rgb2) {
            return (luminanace(rgb1) + 0.05) / (luminanace(rgb2) + 0.05);
        }

        function hex2rgb(hex){
            if (/^#/.test(hex)){
                hex = hex.slice(1);
            }
            if (hex.length !== 3 && hex.length !== 6 ){
                throw new Error("Invaild hex String");
            }
            
            var digit = hex.split("");
            
            if (digit.length === 3){
                digit = [ digit[0], digit[0], digit[1], digit[1], digit[2], digit[2] ];
            }
            var r = parseInt( [digit[0], digit[1] ].join(""), 16 );
            var g = parseInt( [digit[2], digit[3] ].join(""), 16 );
            var b = parseInt( [digit[4], digit[5] ].join(""), 16 );

            return [r,g,b];
        }

        function hsl2rgb(hsl){
            var h = hsl[0] / 359;
            var s = hsl[1] / 100;
            var l = hsl[2] / 100;

            var r, g, b;

            if(s == 0){
                r = g = b = l; // achromatic
            } else {
                var hue2rgb = function hue2rgb(p, q, t){
                    if(t < 0) t += 1;
                    if(t > 1) t -= 1;
                    if(t < 1/6) return p + (q - p) * 6 * t;
                    if(t < 1/2) return q;
                    if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                }

                var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                var p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }

            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function rgb2hsl(rgb){
            var r = rgb[0];
            var g = rgb[1];
            var b = rgb[2];
            r /= 255, g /= 255, b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, l = (max + min) / 2;

            if(max == min){
                h = s = 0; // achromatic
            }else{
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch(max){
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
        }

        function dots(e, x){
            var p = this.getparent('panel');
            var ss = p.getElementsByClassName('slide');
            var s = ss[x];
            var l = s.offsetLeft;
            var w = s.offsetWidth;

            var d = p.getElementsByClassName('dot current');
            d.removeclass('current');

            this.classList.add('current');

            for(var i=0;i<ss.length;i++){
                var a = ss[i];
                a.style.transition = 'transform 150ms ease-in-out';
                a.style.transform = 'translateX(' + (l + w) + 'px)';
            }

            p.dataset.x = (l+w);
        }

        function tools(e){
            var tool = this.dataset.tool;

            if ( !tool ){
                return;
            }

            tool += '_tool';

            if ( document.body.classList.contains(tool) ){

                return;
            }

            document.body.className = document.body.className.replace(/\w*_tool/g, '');

            document.body.classList.add(tool);
        }

        function tooltoggle(e){
            this.classList.toggle('toggled');

            closepanel();
        }

        function toolhandler(e){
            tools.call(this, e);

            var t = this.getparent('tool');
            if ( t.classList.contains('active')){
                tooltoggle.call(t, e);
                return;
            }

            if ( document.documentElement.classList.contains('ui3') ){
                tooltoggle.call(t, e);
            }

            var tb = t.getparent('toolbar');
            var c = tb.getElementsByClassName('tool active');

            c.removeclass('toggled');
            c.removeclass('active');

            t.classList.add('active');

            closepanel();

            var bc = document.getElementById('brush_context');

            bc.style.opacity = 0;
            bc.style.pointerEvents = 'none';
            bc.style.transform = 'translateY(6px)';
        }

        function closepanel(){
            var ps = document.getElementsByClassName('panel2');

            for(var i=0;i<ps.length;i++){
                var p = ps[i];
                p.addEventListener('transitionend', removethis);

                p.style.opacity = 0;
                p.style.transform = 'translateY(8px)';
            }
        }

        function draggable(e){
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }
            var tar = e.target;
            var t = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var offset = this.offset();

            var ox = offset.x;
            var oy = offset.y;

            var nx = ox;
            var ny = oy;

            var moved = false;

            t.style.left = t.style.top = 0;
            t.style.right = t.style.bottom = 'auto';

            t.style.transform = 'translate(' + ox + 'px, ' + oy + 'px)';

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                nx = x - sx;
                ny = y - sy;

                nx += ox;
                ny += oy;

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                } else if ( !moved ){
                    return;
                }

                e.preventDefault();
                e.stopPropagation();

                t.style.transform = 'translate(' + Math.round(nx) + 'px, ' + Math.round(ny) + 'px)';
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( !moved ){
                    //tar.click();
                }

                console.log(nx,ny);

                t.style.transform = 'translate(0, 0)';

                t.style.left = Math.round(nx) + 'px';
                t.style.top = Math.round(ny) + 'px';
            }

            window.addEventListener('touchmove', move, {passive:false});
            window.addEventListener('touchend', end, {passive:false});

            window.addEventListener('mousemove', move, {passive:false});
            window.addEventListener('mouseup', end), {passive:false};
        }

        function handlehandler(e){
            

            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var _h = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var t = this.getparent('toolbar');

            var off = t.offset();

            var ox = off.x;
            var oy = off.y;

            var hoff= this.offset();
            var tox = hoff.x;
            var toy = hoff.y;

            var moved = false;

            closepanel();

            var diffx = ox - tox;

            if ( tox < ox ){
                //ox = tox;
            }

            t.style.transform = 'translate(' + ox + 'px, ' + oy + 'px)';

            t.style.left = 0;
            t.style.top = 0;
            t.style.marginTop = 0;

            var ww = window.innerWidth;
            var wh = window.innerHeight;

            var w = off.w;
            var h = off.h;

            var gap = 16;


            var tx1 = gap + diffx;// + 44;
            var tx2 = ww - gap - w;

            var ty1 = gap;
            var ty2 = wh - gap - h;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                var nx = x - sx;
                var ny = y - sy;

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                } else if ( !moved ){
                    return;
                }

                e.preventDefault();
            e.stopPropagation();

                nx += ox;
                ny += oy;

                if ( nx < tx1 ){
                    nx = tx1;
                } else if ( nx > tx2 ){
                    nx = tx2;
                }

                if ( ny < ty1 ){
                    ny = ty1;
                } else if ( ny > ty2 ){
                    ny = ty2;
                }

                if ( nx > ww * .75 && !(document.documentElement.classList.contains('ui2') || document.documentElement.classList.contains('ui3')) ){
                    t.classList.add('swap');
                } else {
                    t.classList.remove('swap');
                }

                t.style.transform = 'translate(' + nx + 'px, ' + ny + 'px)';

                t.dataset.x = nx;
                t.dataset.y = ny;
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( !moved && _h.classList.contains('handle') ){
                    toggletoolbar.call(t, e);
                }
            }

            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('touchend', end, {passive: false});

            window.addEventListener('mousemove', move, {passive: false});
            window.addEventListener('mouseup', end, {passive: false});
        }

        function toggletoolbar(e){
            e.preventDefault();
            e.stopPropagation();
            console.log('toggle');

            this.classList.toggle('minimized');

            var a = document.getElementsByClassName('tool current toggled')[0];
            if ( a ){
                a.classList.remove('toggled');
            }

            var p = document.getElementsByClassName('panel2');
            p.remove();
        }

        function removethis(e){
            console.log('remove');
            if ( this && this.parentNode ){
                this.parentNode.removeChild(this);
            }
        }

        function panelhandler(e){
            var ep = document.getElementsByClassName('panel2');

            if (ep[0]){
                closepanel();
                return;
            }

            var id = this.id;
            var pid = id + '_panel';
            var p = document.getElementById(pid);

            if ( !p ){
                return;
            }

            var c = p.cloneNode(true);

            var bounds = this.getBoundingClientRect();
            var x = bounds.x;
            var y = bounds.y;

           
            c.style.left = x + 'px';

            c.removeAttribute('id');

            c.classList.add('panel2');

            document.body.appendChild(c);


            //var off = c.offsetTop;

            if ( y < c.offsetHeight + 24 ){
                c.style.top = y + 56 + 'px';
            } else {
                c.style.top = (y - (c.offsetHeight + 12 )) + 'px';
            }


            c.offsetLeft;

            c.style.opacity = 1;
            c.style.transform = 'translateY(0)';


        }

        function swipehandler(e){
            //e.preventDefault();
            //e.stopPropagation();
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var tar = ev.target;
            var _h = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var p = this.getparent('panel');
            var ss = p.getElementsByClassName('slide');
            var w = p.offsetWidth;

            var ox = Number(p.dataset.x) || 0;
            var oy = Number(p.dataset.y) || 0;

            var moved = false;

            var nx = 0;
            var ny = 0;

            p.classList.remove('moving');

            var scrolling = false;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                nx = x - sx;
                ny = y - sy;

                if ( scrolling ){
                    //e.preventDefault();
                    //e.stopPropagation();
                    return;
                }

                if ( !moved && Math.abs(ny) - 5 > Math.abs(nx) ){
                    //e.preventDefault();
                    //e.stopPropagation();

                    scrolling = true;

                    return;
                }

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                    p.classList.add('moving');
                    
                } else if ( !moved ){
                    return;
                }

                if ( moved ){
                    e.preventDefault();
                    e.stopPropagation();
                }
                

                nx += ox;
                ny += oy;

                if ( nx > w ){
                    nx =  (w/2) + ((nx) / (Math.abs(nx/w)+1) );
                } else if ( nx < 0 ){
                    nx =  ((nx) / (Math.abs(nx/(w/4))+1) );
                }

                for(var i=0;i<ss.length;i++){
                    var a = ss[i];
                    a.style.transition = 'none';
                    a.style.transform = 'translateX(' + nx + 'px)';
                }

                //t.style.transform = 'translate(' + nx + 'px, ' + ny + 'px)';

                //t.dataset.x = nx;
                //t.dataset.y = ny;
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( scrolling){
                    return;
                } else if ( !moved  ){
                    console.log('clicked');

                    //tar.click();
                } else {

                    var oc = p.getElementsByClassName('dot current');
                    oc.removeclass('current');

                    if ( nx > w/2 ){
                        nx = w;

                        oc = p.getElementsByClassName('dot')[0];

                    } else if ( nx <= w/2 ){
                        nx = 0;
                        
                        
                        oc = p.getElementsByClassName('dot')[1];
                    }

                    if ( oc ){
                        oc.classList.add('current');
                    }

                    p.dataset.x = nx;

                    for(var i=0;i<ss.length;i++){
                        var a = ss[i];
                        a.style.transition = 'all 150ms ease-in-out';
                        a.style.transform = 'translateX(' + nx + 'px)';
                    }
                }
            }

            window.addEventListener('touchmove', move, {passive:false});
            window.addEventListener('touchend', end, {passive:false});

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function menuhandler(e){
            var m = this.getparent('menu');
            
        }

        function listhandler(e){
            var l = this.getparent('list');
            if ( !l ){
                menuhandler.call(this, e);
                return;
            }
            var p = l.getparent('panel');

            if ( p.classList.contains('moving') ){
                return;
            }

            var c = l.getElementsByClassName('item current');

            c.removeclass('current');

            this.classList.add('current');

            closepanel();
        }

        function tweak(e){
            var v = this.value;
            console.log(v);
            if ( v == 'ui3' ){
                document.documentElement.classList.remove('ui2');
            } else if ( v == 'ui2' ){
                document.documentElement.classList.remove('ui3');
            } else if ( v == 'dotgrid' ){
                document.documentElement.classList.remove('grid');
            } else if ( v == 'grid' ){
                document.documentElement.classList.remove('dotgrid');
            }
            document.documentElement.classList.toggle(v);
        }

        function sliderhandler(e){
            e.preventDefault();
            e.stopPropagation();

            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }
            var s = this;
            var sx = ev.pageX;
            var sy = ev.pageY;

            var ox = Number(this.dataset.x) || 0;
            var oy = Number(this.dataset.y) || 0;

            var moved = false;

            var nx = 0;
            var ny = 0;

            var k = this.getElementsByClassName('knob')[0];

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                nx = x - sx;
                ny = y - sy;

                if ( !moved  ){
                    moved = true;
                }
                
                nx += ox;
                ny += oy;

                ny = Math.max(8, Math.min(ny, 160));

                var z = ((160 - ny) + 24) / 160;

                var az = 36 * z;
                
                brushsize = az;

                console.log(az)

                k.style.top = ny + 'px';
                k.style.transform = 'translateX(-50%) scale(' + z + ')';

                var ba = document.getElementById('brushactual');
                var ba2 = document.getElementsByClassName('brushactual2')[0];

                ba.style.width = ba.style.height = ba2.style.width = ba2.style.height = ba.parentElement.offsetHeight * z + 'px';

                s.dataset.x = nx;
                s.dataset.y = ny;
            }

            function end(e){
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                if ( !moved ){
                    console.log('clicked');
                } else {
                     var temp = document.getElementById('brushsize_panel');
                     temp.empty();
                     var cc = s.cloneNode(true);

                     temp.appendChild(cc);
                }

                closepanel();
            }

            window.addEventListener('touchmove', move);
            window.addEventListener('touchend', end);

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function swatchhandler(e){

            console.log('ugh')
            var c = window.getComputedStyle(this,null).backgroundColor;

            var id = this.getparent('panel').dataset.id;

            window[id + 'color'] = c;

            console.log(id);

            console.log(c);

            var qs = document.querySelector('.current .' + id + 'fill');
            if ( qs ){
                qs.style.background = c;

                var tw = qs.getparent('textwrap');
                var rc = qs.getparent('rectangle');

                if ( tw ){
                    var ta = tw.getElementsByClassName('textarea')[0];
                    ta.style.color = c;
                } else if (rc){
                    rc.style.backgroundColor = c;
                }
            }

            if ( id == 'brush'){
                document.getElementsByClassName('brushfill2')[0].style.background = c;
            }

            if ( id == 'shape' ){
                var s2 = document.getElementById('shape2fill');
                if ( s2 ){
                    s2.style.background = c;
                }
            }

            if ( id == 'shape2' ){
                var ugh = document.getElementsByClassName('contextpanel visible')[0];
                var cid = ugh.id;
                var sh = document.getElementById(cid + 'rect');
                sh.style.background = c;

                ugh.getElementsByClassName('shape2fill')[0].style.background = c;

                //shapecolor = c;

                //document.getElementById('shapefill').style.backgroundColor = c;
            }

            if ( id == 'text' ){
                var ugh = document.getElementsByClassName('contextpanel visible')[0];
                var cid = ugh.id;
                var sh = document.getElementById(cid + 'rect');
                sh.getElementsByClassName('textarea')[0].style.color = c;

                ugh.getElementsByClassName('textfill')[0].style.background = c;

                textcolor = c;

                document.getElementById('textfill2').style.backgroundColor = c;
            }

            var pan = document.getElementById(id + 'fill');
            if ( pan ){
                pan.style.background = c;
            }

            closepanel();
        }

        function typetool(e){

            console.log('TYPETOOL');
            blurall();

            var p = e.target.getparent('textarea');
            var b = e.target.getparent('toolbar');
            var pp = e.target.getparent('panel');
            var tw = e.target.getparent('tweaks');

            if ( p || b || pp || tw ){
                return;
            }

            e = e.touches ? e.touches[0] : e;

            var w = document.createElement('div');
            var t = document.createElement('textarea');

            t.className = 'textarea';

            w.className = 'textwrap current layeritem';

            var x = e.pageX;
            var y = e.pageY;

            w.style.top = y - 24 + 'px';
            w.style.left = x + 'px';
            t.style.width = '48px';
            w.style.zIndex = 1337;

            var ops = document.getElementById('text_context').cloneNode(true);
            //ops.removeAttribute('id');

            var cid = 's' + Date.now() + '-' + Math.floor(Math.random()*1000);

            ops.id = cid;
            w.dataset.context = cid;
            
            w.id = cid + 'rect';

            document.body.appendChild(ops);


            t.addEventListener('input', autoexpand);

            // t.onblur = function(){
            //     t.getparent('textwrap').classList.remove('current');
            //     t.readOnly = true;
            // }

            // var ops = document.getElementById('text_context').cloneNode(true);
            // ops.removeAttribute('id');

            w.appendChild(t);
            // w.appendChild(ops);

            document.getElementById('layers').appendChild(w);

            t.focus();

            document.getElementById('select_tool').click();

            t.parentElement.classList.add('current');

            setcontextpanel.call(w);

            //if ( e.touches ){
                showkeyboard.call(w, e);
            //}
        }

        function showkeyboard(e){
            var off = this.offset();
            var x = off.x;
            var y = off.y;
            var h = off.h;
            var w = off.w;

            var k = document.getElementById('keyboard');

            var nx = x + (w/2) - ( k.offsetWidth/2);

            var ny = y + h + 24;

            if ( nx < 16 ){
                nx = 16;
            } else if ( nx > window.innerWidth - k.offsetWidth - 16 ){
                nx = window.innerWidth - k.offsetWidth - 16;
            }

            if ( ny > window.innerHeight  - k.offsetHeight - 16 ){
                ny = y - k.offsetHeight - 16;
            }

            k.style.top = ny + 'px';
            k.style.left = nx + 'px';
            k.style.transform = 'translateX(0)';

            k.classList.add('show');
        }

        function hidekeyboard(){
            var k = document.getElementById('keyboard');
            k.classList.remove('show');
        }

        function autoexpand(e){
            var v = this.value;

            var d = document.createElement('div');
            d.innerText = v;
            d.style.display = 'inline';
            d.style.whiteSpace = 'nowrap';
            d.style.fontSize = '24px';

            document.body.appendChild(d);

            var w = d.offsetWidth;
            var h = d.offsetHeight;

            this.style.width = w + 9 + 'px';

            this.style.height = 0;
            var s = this.scrollHeight;

            this.style.height = s - 16 - 8 + 'px';

            d.parentNode.removeChild(d);

            setcontextpanel.call(this.getparent('textwrap'));
        }

        function blurall(e){
            var c = document.getElementsByClassName('layeritem current');
            c.removeclass('current');

            c = document.getElementsByClassName('contextpanel visible');
            c.removeclass('visible');

            hidekeyboard();
        }

        function blurelm(e){
            console.log('BLUR')
            var a = document.activeElement;//.blur();
            var c = document.getElementsByClassName('current');
            console.log(c[0]);
            if ( !c[0] || c[0] && (c[0] == a || this.getparent('current')) ){
                return;
            }
            console.log(a);
            a.blur();

            var ta = c[0].getElementsByClassName('textarea')[0];

            if ( ta ){
                ta.blur();
                ta.readOnly = true;
            }
            c.removeclass('current');

            hidecontext();
            hidekeyboard();

            var bc = document.getElementById('brush_context');

            bc.style.opacity = 0;
            bc.style.pointerEvents = 'none';
            bc.style.transform = 'translateY(6px)';
        }

        function hidecontext(){
            var p = document.getElementsByClassName('contextpanel visible');
            p.removeclass('visible');
        }

        function texthandler(e){
            e.stopPropagation();
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                return;
            }

            var ta = this.getElementsByClassName('textarea')[0];

            blurelm.call(this, e);

            var sx = ev.pageX;
            var sy = ev.pageY;

            var t = this;

            var ox = Number(t.dataset.x) || 0;
            var oy = Number(t.dataset.y) || 0;

            var moved = false;

            var nx = 0;
            var ny = 0;

            function move(e){
                var ev = e.touches ? e.touches[0] : e;
                var x = ev.pageX;
                var y = ev.pageY;

                var nx = x - sx;
                var ny = y - sy;

                if ( document.activeElement === ta ){ //if ( ta.readOnly === false ){
                    return;
                }

                if ( !moved && (Math.abs(nx) > 3 || Math.abs(ny) > 3) ){
                    moved = true;
                    //e.preventDefault();
                    e.stopPropagation();

                    hidecontext();
                } else if ( !moved ){
                    return;
                }

                nx += ox;
                ny += oy;

                t.style.transform = 'translate(' + nx + 'px, ' + ny + 'px)';

                t.dataset.x = nx;
                t.dataset.y = ny;
            }

            function end(e){
                e.preventDefault();
                e.stopPropagation();

                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);

                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);

                var off = t.offset();
                var ol = off.x;
                var ot = off.y;

                t.style.transform = 'translate(0px, 0px)';

                t.dataset.x = 0;
                t.dataset.y = 0;
                
                t.style.left = ol + nx + 'px';
                t.style.top = ot + ny + 'px';

                if ( !moved ){
                    console.log('clicked');

                    if ( !t.classList.contains('current')){

                        t.classList.add('current');
                        ta.readOnly = false;
                        ta.focus();

                        if ( e.touches ){

                            showkeyboard.call(t);
                        }
                    }

                    setcontextpanel.call(t);
                }
            }

            window.addEventListener('touchmove', move);
            window.addEventListener('touchend', end);

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function stopprop(e){
            e.preventDefault();
            e.stopPropagation();
        }

        function shapez(e){
            var b = this.classList.contains('shapeback');
            var r = document.getElementsByClassName('layeritem current')[0];
            var o = r.nextElementSibling;

            if ( b ){
                o = r.previousElementSibling;
                if ( o ){
                    r.parentNode.insertBefore(r, o);
                }
            } else if ( o ) {
                r.parentNode.insertBefore(r, o.nextElementSibling);
            }
        }

        function setcontextpanel(x){
            contextfollow.call(this);
            var cid = this.dataset.context;

            var c = document.getElementById(cid);

            c.offsetLeft;

            c.classList.add('visible');
        }

        function contextfollow(){
            var off = this.offset();
            var x = off.x;
            var y = off.y;
            var w = off.w;
            var h = off.h;

            var cid = this.dataset.context;

            var c = document.getElementById(cid);
            var cw = c.offsetWidth;
            var ch = c.offsetHeight;

            x = x + (w/2) - ( cw/2 );

            if ( x < 16){
                x = 16
            } else if ( x + cw > window.innerWidth - 16 ){
                x = window.innerWidth - 16 - cw;
            }

            c.style.left = Math.round(x) + 'px';

            if ( y < 72 ){

                console.log(y+h)
                if ( y+h > window.innerHeight - 72 ){
                    y += 16;

                    y = Math.max(y, 16);
                } else {
                    y = y + h + 16;
                }
            } else {
                y -= 64;
            }

            c.style.top = Math.round(y) + 'px';

            c.classList.remove('visible');
        }

        function closemenu(e){
            e = e || {};
            var t = e.target || document.body;
            if ( t.classList.contains('delete') || t.getparent('bgmenu') ){
                return;
            }

            if ( e.target){
                e.preventDefault();
                e.stopPropagation();
            }

            document.body.removeEventListener('click', closemenu);

            var o = document.getElementsByClassName('option opened');
            o.removeclass('opened');

            var m = document.getElementsByClassName('menuwrap');
            m.remove();

            var o = document.getElementsByClassName('contextpanel sublevel');

            var o1 = o[0].getElementsByClassName('option')[0];
            
            o.removeclass('sublevel');

            o1.style.marginLeft = 0;

        }

        function backbtn(e){
            var b = document.createElement('div');
            b.className = 'backbtn';

            b.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>';

            return b;
        }

        function colormenu(e){
            var o = this.classList.contains('opened');
            if ( o ){
                return;
            }

            var shell = this.dataset.menu;

            var c = this.getparent('contextpanel');
            var coff = c.offset();
            var x = coff.x;
            var y = coff.y;
            var w = coff.w;
            var h = coff.h;

            this.classList.add('opened');

            var p = document.createElement('div');
            var m = document.getElementById(shell);

            var s = document.getElementById('colorswatches').cloneNode(true);
            s.removeAttribute('id');

            p.className = 'menuwrap';
            
            m = m.cloneNode(true);

            m.removeAttribute('id');

            m.className = 'bgmenu';
            
            //m.appendChild(backbtn());
            m.appendChild(s);

            p.appendChild(m);
            
            document.body.addEventListener('click', closemenu);

            document.body.appendChild(p);

            var o = c.getElementsByClassName('option');

            var l = o.length - 1;
            o = o[0];

            var ox = -(c.offsetWidth - 48);
            o.style.marginLeft = ox + 'px';

            //p.offsetLeft;

            p.style.top = y + 'px';
            p.style.left = x + (w/2) - (p.offsetWidth / 2) + 'px';
            p.style.left = x + 48 + 12 + 'px';
            p.style.left = x + w + 12 + 'px';

            p.style.transform = 'translateX(0px)';

            p.offsetLeft;

            c.classList.add('sublevel')

            p.classList.add('visible');
            
            p.offsetLeft;

            p.style.transform = 'translateX(' + ox + 'px)';
        }

        function moremenu(e){
            var o = this.classList.contains('opened');
            if ( o ){
                return;
            }

            var c = this.getparent('contextpanel');
            var coff = c.offset();
            var x = coff.x;
            var y = coff.y;
            var w = coff.w;
            var h = coff.h;

            this.classList.add('opened');

            var p = document.createElement('div');
            var m = document.getElementById('moremenu');

            p.className = 'menuwrap';
            
            m = m.cloneNode(true);

            m.removeAttribute('id');

            m.className = 'overflowmenu';
            
            //m.appendChild(backbtn());

            p.appendChild(m);
            
            document.body.addEventListener('click', closemenu);

            document.body.appendChild(p);

            var o = c.getElementsByClassName('option');

            var l = o.length - 1;
            o = o[0];

            var ox = -(c.offsetWidth - 48);
            o.style.marginLeft = ox + 'px';

            //p.offsetLeft;

            p.style.top = y + 'px';
            p.style.left = x + (w/2) - (p.offsetWidth / 2) + 'px';
            p.style.left = x + 48 + 12 + 'px';
            p.style.left = x + w + 12 + 'px';

            p.style.transform = 'translateX(0px)';

            p.offsetLeft;

            c.classList.add('sublevel')

            p.classList.add('visible');
            
            p.offsetLeft;

            p.style.transform = 'translateX(' + ox + 'px)';

        }

        function deletecurrent(e){
            console.log('delete');
            e.preventDefault();
            e.stopPropagation();
            var d = document.getElementsByClassName('layeritem current');

            while(d[0]){
                var a = d[0];
                var cid = a.dataset.context;
                a.remove();
                var b = document.getElementById(cid);
                b.remove();
            }
            document.body.click();
        }

        function shift(e){
            var k = this.getparent('keyboard');
            k.classList.toggle('uppercase');
        }

        function key(e){
            var v = this.innerText;
            var a = document.getElementsByClassName('textwrap current')[0];

            a = a.getElementsByClassName('textarea')[0];

            switch(v.toLowerCase()){
                case 'space':
                    v = ' ';
                    break;
                case 'del': 
                    a.value = a.value.slice(0, -1);
                    return;
                case 'shift' :
                    return;
                case 'return' :
                    v = '\r\n';
                    break;
                case '&123' :
                    return;
                default:
            }

            a.value += v;
            a.focus();

            autoexpand.call(a, e);
        }

        function shape_tool2(e){
            var o = document.getElementsByClassName('shapes_panel panel2');

            if ( o[0] ){
                o.remove();
                return;
            }
            
            var s = document.getElementById('shapes_panel').cloneNode(true);

            s.removeAttribute('id');

            s.classList.add('panel2');

            var off = this.offset();
            var x = off.x + 72;
            var y = off.y - 2;

            s.style.top = y + 'px';
            s.style.left = x  + 'px';

            document.body.appendChild(s);
            s.offsetLeft;
            s.style.opacity = 1;
        }


        function type_tool2(e){
            console.log('type_tool2')
            if ( !document.documentElement.classList.contains('insert') ){
                return;
            }
            blurelm.call(this);

            typetool.call(this, {pageX: (window.innerWidth / 2) - 200,pageY: window.innerHeight / 2, touches: null, target: document.body })
        }

        function minishape(e){
            e.preventDefault();
            e.stopPropagation();
            console.log('ms');
            var t = this.dataset.type;

            document.body.classList.remove('rectanglex', 'circlex');
            document.body.classList.add(t);

            console.log('shape_tool2');
            if ( document.documentElement.classList.contains('insert') ){
                blurelm.call(this);
                insertrect();
            }

            closepanel();
        }

        function bordercontext(e){
            console.log('bordercontext')
            var p = this.getparent('contextpanel');
            var c = p .getElementsByClassName('content')[0];

            var b = document.getElementById('border_panel').cloneNode(true);

            b.removeAttribute('id');

            b.classList.remove('panel');

            //c.appendChild(b);

        }

        function colorswatch(e){
            console.log('COLOR');
            var m = this.getparent('menuwrap');
            var o = m.getElementsByClassName('color current');

            o.removeclass('current');

            this.classList.add('current');

            var c = this.getElementsByClassName('chip')[0] || this;
            var a = window.getComputedStyle(c).backgroundColor;

            console.log(a);

            var l = document.getElementsByClassName('layeritem current')[0];
            var id = l.dataset.context;

            if ( l.classList.contains('rectangle')) {

                l.style.backgroundColor = a;
            } else if ( l.classList.contains('textwrap')){
                l.getElementsByClassName('textarea')[0].style.color = a;
            }

            var p = document.getElementById(id);
            var f = p.getElementsByClassName('fill')[0];

            f.style.background = a;

            //closemenu();
        }

        Attach.on('touchstart', '.handle', handlehandler);
        Attach.on('mousedown', '.handle', handlehandler);

        Attach.on('touchstart', '#toolbar', handlehandler);
        Attach.on('mousedown', '#toolbar', handlehandler);

        Attach.on('click', '.toolbtn', toolhandler);

        Attach.on('click', '.control', panelhandler);

        Attach.on('click', '.contextpanel .option', panelhandler);

        Attach.on('click', '.item', listhandler);

        Attach.on('touchstart', '.panel', swipehandler);
        Attach.on('mousedown', '.panel', swipehandler);

        Attach.on('change', '.tweakr', tweak);

        Attach.on('mousedown', '.slider', sliderhandler);
        Attach.on('touchstart', '.slider', sliderhandler);

        Attach.on('click', '.swatch', swatchhandler);

        Attach.on('click', '.type_tool', typetool);

        //Attach.on('click', '.textarea', texthandler);

        Attach.on('mousedown', '.textwrap', texthandler);
        Attach.on('touchstart', '.textwrap', texthandler);

        Attach.on('mousedown', '.rectangle_tool', rectanglex);
        Attach.on('touchstart', '.rectangle_tool', rectanglex);

        Attach.on('mousedown', '.canvas_tool', rectanglex);
        Attach.on('touchstart', '.canvas_tool', rectanglex);

        Attach.on('mousedown', '.draggable', draggable);
        Attach.on('touchstart', '.draggable', draggable);

       
        Attach.on('mousedown', '.resizehandle', rectangleresize);
        Attach.on('touchstart', '.resizehandle', rectangleresize);
        
        Attach.on('mousedown', '.rectangle', rectanglemove);
        Attach.on('touchstart', '.rectangle', rectanglemove);

        //Attach.on('click', '.rectangle', ffocus);

        Attach.on('click', '.shapeup', shapez);
        Attach.on('click', '.shapeback', shapez);

        Attach.on('click', '.delete', deletecurrent);

        Attach.on('click', '.morebtn', moremenu);
        Attach.on('click', '.fillcolor', colormenu);
        Attach.on('click', '.textcolor', colormenu)

        Attach.on('mousedown', '.select_tool', marquee);
        Attach.on('touchstart', '.select_tool', marquee);

        Attach.on('click' , '.shift', shift);

        Attach.on('click' , '.key', key);

        Attach.on('click', '#shape_tool2', shape_tool2);
        Attach.on('click', '#type_tool2', type_tool2);

        Attach.on('click', '.minishape', minishape);

        Attach.on('click', '.shapeborder', bordercontext);

        Attach.on('click', '.color', colorswatch)


        //document.addEventListener('mousewheel', mousescroll, { passive:false });

        //Attach.on('mousedown', '.contextpanel', stopprop, true);

        canvassetup();

        window.onresize = resize;

        function resize(){
            screenrez();
            resize2();
        }

        window.addEventListener('mousedown', function(e){
            var ev = e.touches ? e.touches[0] : e;
            if( ev.which == 3 ){
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);

        document.body.addEventListener('mouseup', function(e){
            var t = e.target;

            if ( t == document.body || t.id == 'canvas2' ){
                // var f = document.getElementsByClassName('current');
                // f.removeclass('current');

                blurelm.call(this,e);

                // var p = document.getElementsByClassName('contextpanel visible');
                // p.removeclass('visible');
            }
        });

        function screenrez(){
            var r = document.getElementsByClassName('rez');
            var d = document.createElement('div');
            d.appendChild(document.createTextNode('Screen: ' + screen.width + ' x ' + screen.height + '\r\n Window: ' + window.innerWidth + ' x ' + window.innerHeight));
            

            d.className = 'rez';

            d.style.position = 'fixed';
            d.style.bottom = '8px';
            d.style.right = '8px';
            d.style.zIndex = 1337;
            d.style.background = 'rgba(0,0,0,.1)';
            d.style.color = '#333';
            d.style.borderRadius = 'var(--toolbarradius)';
            d.style.whiteSpace = 'pre-line';
            d.style.padding = '4px 8px';
            d.style.fontSize = '14px';
            d.style.pointerEvents = 'none';

            r.remove();

            document.body.appendChild(d);
        }

        screenrez();

        var dotgrid2 = 40;
        function dotspacing(e){
            //e.preventDefault();

            console.log(e.deltaY);

            var delta = 1;

            if ( e.deltaY < 0 ){
                delta = -1;
            }

            dotgrid2 += delta;

            dotgrid2 = Math.max(dotgrid2, 0.1);
            

            var n = 'tweaked_dotgrid';
            var o = document.head.getElementsByClassName(n);
            o.remove();

            var s = document.createElement('style');
            s.className = n;

            var css = ':root{ --dotgrid: ' + dotgrid2 + 'px; --grid: ' + dotgrid2 + 'px;}'

            s.appendChild(document.createTextNode(css));

            document.head.appendChild(s);

        }

        window.addEventListener('mousewheel', dotspacing, {passive:false});


        // var hammertime = new Hammer(document.body, {});
        // hammertime.on('pan', function(ev) {
        //     console.log(ev);
        // });

    </script>
    <!-- <script src="./fabric.js"></script> -->

    <script>
        //var canvas = document.getElementById('canvas2');

        //var canvas2 = new fabric.Canvas('canvas2');

        // canvas2.on('mouse:wheel', function(opt) {
        //     var delta = opt.e.deltaY;
        //     var zoom = canvas2.getZoom();
        //     zoom = zoom + delta/200;
        //     if (zoom > 20) zoom = 20;
        //     if (zoom < 0.01) zoom = 0.01;
        //     canvas2.setZoom(zoom);
        //     opt.e.preventDefault();
        //     opt.e.stopPropagation();
        // })

        
    </script>
</body>
</html>
